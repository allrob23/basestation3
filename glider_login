## 
## Copyright (c) 2006, 2007, 2008, 2011, 2012, 2013, 2020, 2021 by University of Washington.  All rights reserved.
##
## This file contains proprietary information and remains the 
## unpublished property of the University of Washington. Use, disclosure,
## or reproduction is prohibited except as permitted by express written
## license agreement with the University of Washington.
##
## THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
## AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
## IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
## ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
## LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
## CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
## SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
## INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
## CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
## ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
## POSSIBILITY OF SUCH DAMAGE.
##

# A glider just logged in
# NOTE: Ensure this and the .login file do not contain hidden ^M's or things will fail
# Ensure we have a comm.log file
touch comm.log

if(! $?BASESTATION_PATH ) then
    set BASESTATION_PATH = "/usr/local/basestation"
endif

printf "\n" >>! glider_early_gps.log
printf "\n" >>! glider_early_gps.log

set BASELOG = glider_early_gps_`date +%y%m%d%H%M%S`
set PYTHON_BINARY = python3.9

$PYTHON_BINARY $BASESTATION_PATH/GliderEarlyGPS.py --daemon --mission_dir `pwd` --verbose --base_log $BASELOG --csh_pid $$  >>&!  glider_early_gps.log

if (-f .connected) then
#    echo Reconnected at `date` >> comm.log
     echo Reconnected at `date +"%a %b %d %R:%S %Z %Y"` >> comm.log
else
#    echo Connected at `date` >> comm.log
     echo Connected at `date +"%a %b %d %R:%S %Z %Y"` >> comm.log
endif

rm -f .connected
touch .connected

# If set in the .cshrc (basestation simulators), honor that value for autologout
if( $?AUTOLOGOUT_GLIDER ) then
     # To catch hanging shells
     set autologout=$AUTOLOGOUT_GLIDER
else
     set autologout=3
endif

# Signal the glider what files are waiting for upload
set BASELOG = baselog_login_`date +%y%m%d%H%M%S`
$PYTHON_BINARY $BASESTATION_PATH/BaseLogin.py --mission_dir `pwd` --verbose --base_log $BASELOG  >>&!  baselog.log
if ( -f upload_files ) then
   source upload_files
   rm -f upload_files
endif

# NOTE: Ensure /usr/local/bin is before /usr/bin
