<style>
    a:link    {color:#0000ff; text-decoration:none}
    a:visited {color:#0000ff; text-decoration:none}
    a:hover   {color:#ff0000; text-decoration:underline}
    a:active  {color:#ff0000; text-decoration:underline}
    td {text-align:right; padding-left: 4px; }
</style>

<script>

    function $(x) {
        return document.getElementById(x)
    }

    Number.prototype.zeroPad = function() {
        return ('0'+this).slice(-2);
    }

    var blurTimer  = false;
    var isBlurred  = false;
    var isFlashing =false;
    var currTitle  = "";

    var currGlider = '';

    var engplots;

    function startFlash() {
        isFlashing = true;
        console.log('flashing');
        blurTimer = window.setInterval(function() 
            {
                document.title = document.title == currTitle ? currTitle + "..." : currTitle;
            }, 1000);
    }
 
    window.onblur=function() {
        isBlurred = true;
        console.log('blurring');
    }

    window.onfocus=function() { 
        isBlurred = false;
        isFlashing = false;
        document.title = currTitle;
        if (blurTimer) {
            clearInterval(blurTimer);
        }
        blurTimer = false;
        console.log('stopping');
    }

    function setupStream(glider) {
        var evtSrc = new EventSource('/stream/' + glider);

        evtSrc.addEventListener('open', function(e) {
            // document.getElementById('main').style.border = '7px solid #cccccc';
        }, false);

        evtSrc.addEventListener('error', function(e) {
            if (e.readyState == EventSource.CLOSED) {
                // document.getElementById('main').style.border = '7px solid red';
            }
        }, false);

        evtSrc.addEventListener('message', function(e) {
            var pieces, content, data, i;
            var vals = {};
            var update;
            var newDive;

            line = e.data;
            if (line.startsWith('NEW=')) {
                console.log(line);
                newDive = parseInt(line.split('=')[1].slice(2,6));
                loadPlots(newDive);
            }
            else {
                // line = e.data.replace("4096", "<br>");
                // line = line + '<br>\n';
                var elt = $('commlog');
                elt.innerHTML += line;
                elt.scrollTop = elt.scrollHeight;
            }
            if (isBlurred && !isFlashing) {
                startFlash();
            }
        }, false);
    }

    var currDive = -1;
    var maxDive = 10000; 
    var currElt = 'diveplot';

    function saveCmdfile() {
        var xhttp = new XMLHttpRequest();
        var json = {};
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                alert(this.responseText);
            }
        }
        json['file'] = 'cmdfile';
        json['contents'] = $('cmdfile').value; 
        xhttp.open("POST", "/save/" + currGlider, true);
        xhttp.send(JSON.stringify(json));
    }

    function changeDirective(cmd) {
        var newCmd = '$' + cmd;
        console.log(newCmd + ' ' + cmd);
        $('cmdfile').value = $('cmdfile').value.replace('$GO', newCmd);
        $('cmdfile').value = $('cmdfile').value.replace('$QUIT', newCmd);
        $('cmdfile').value = $('cmdfile').value.replace('$RESUME', newCmd);
        $('cmdfile').value = $('cmdfile').value.replace('$EXIT_TO_MENU', newCmd);
    }

    function popupPlotly(dive, elt) {
        window.open('/div/' + currGlider + '/' + dive + '/' + elt, '_blank');
    }

    function showPlot(elt, plotly) {
        $('mainImage').removeAttribute('hidden');
        $('mainImage').src = '/png/' + currGlider + '/' + currDive + '/' + elt;
        $('mainTable').setAttribute('hidden', '');
        if (plotly) {
            $('mainImage').onclick = function() { popupPlotly(currDive, elt); }
        }
        else {
            $('mainImage').onclick = null;
        }
        currElt = elt;
    }

    function showEng(elt, plotly) {
        $('mainImage').removeAttribute('hidden');
        $('mainImage').src = '/eng/' + currGlider + '/' + elt;
        $('mainTable').setAttribute('hidden', '');
        // $('mainImage').onclick = function() { popupPlotly(currDive, elt); }
        $('mainImage').onclick = null;
    }

    function buildTable() {
        var row, cell, text;
        var tbody = $('mainTable').getElementsByTagName('tbody')[0];
        var xhttp = new XMLHttpRequest();
        const colors = ["#cccccc", "#eeeeee"];
        var i, c;
        var date;
        var course; 
        var dist;
        var n, e;
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                resp = JSON.parse(this.responseText);
                for (d of resp) {
                    row = tbody.insertRow(1);
                    i = $('mainTable').rows.length % 2;
                    row.style.backgroundColor = colors[i];
                    cell = row.insertCell(0);
                    cell.innerHTML = '<a href="#" onclick="loadPlots(' + d['dive'] + ');">' + d['dive'] + '</a>';
                    cell.style.textAlign = 'left';
                    // cell.appendChild(text);

                    date = new Date(1000*(d['log_start'] + d['total_flight_time_s']));
                    cell = row.insertCell(1); 
                    text = document.createTextNode((date.getFullYear() - 2000) + '/' +
                                                   (date.getMonth() + 1).zeroPad() + '/' + 
                                                   date.getDate().zeroPad() + ' ' + 
                                                   date.getHours().zeroPad() + ':' + 
                                                   date.getMinutes().zeroPad());
                    cell.appendChild(text);

                    cell = row.insertCell(2); 
                    text = document.createTextNode('' + (d['total_flight_time_s']/60).toFixed(0));
                    cell.appendChild(text);

                    cell = row.insertCell(3);
                    text = document.createTextNode('' + d['max_depth'].toFixed(0) + '(' + d['log_D_TGT'] + ')');
                    cell.appendChild(text);

                    dist = Math.sqrt(d['GPS_north_displacement_m']*d['GPS_north_displacement_m'] 
                                     + d['GPS_east_displacement_m']*d['GPS_east_displacement_m']);
                    course = Math.atan2(d['GPS_east_displacement_m'], d['GPS_north_displacement_m'])*180.0/Math.PI;
                    if (course < 0) {
                        course = course + 360;
                    }
                    cell = row.insertCell(4);
                    text = document.createTextNode('' + (dist/1000).toFixed(2));
                    cell.appendChild(text);

                    cell = row.insertCell(5);
                    text = document.createTextNode('' + course.toFixed(1));
                    cell.appendChild(text);

                    n = d['flight_avg_speed_north'] * d['total_flight_time_s'];
                    e = d['flight_avg_speed_east'] * d['total_flight_time_s'];
                    dist = Math.sqrt(n*n + e*e);
                    course = Math.atan2(e, n)*180.0/Math.PI;
                    if (course < 0) {
                        course = course + 360;
                    }
                    cell = row.insertCell(6);
                    text = document.createTextNode('' + (dist/1000).toFixed(2));
                    cell.appendChild(text);

                    cell = row.insertCell(7);
                    text = document.createTextNode('' + course.toFixed(1));
                    cell.appendChild(text);

                    cell = row.insertCell(8);
                    text = document.createTextNode('' + (d['meters_to_target']/1000).toFixed(2));
                    cell.appendChild(text);

                    cell = row.insertCell(9);
                    text = document.createTextNode('' + (d['mag_heading_to_target'] + d['magnetic_variation']).toFixed(1));
                    cell.appendChild(text);

                    
                    dist = Math.sqrt(d['depth_avg_curr_east']*d['depth_avg_curr_east'] 
                                     + d['depth_avg_curr_north']*d['depth_avg_curr_north']);
                    course = Math.atan2(d['depth_avg_curr_east'], d['depth_avg_curr_north'])*180.0/Math.PI;
                    if (course < 0) {
                        course = course + 360;
                    }

                    cell = row.insertCell(10);
                    text = document.createTextNode('' + (dist*100.0).toFixed(1));
                    cell.appendChild(text);

                    cell = row.insertCell(11);
                    text = document.createTextNode('' + course.toFixed(1));
                    cell.appendChild(text);

                    cell = row.insertCell(12);
                    text = document.createTextNode('' + d['log_TEMP'].toFixed(2));
                    cell.appendChild(text);
                    cell = row.insertCell(13);
                    text = document.createTextNode('' + d['log_HUMID'].toFixed(2));
                    cell.appendChild(text);
                    cell = row.insertCell(14);
                    text = document.createTextNode('' + d['log_INTERNAL_PRESSURE'].toFixed(2));
                    cell.appendChild(text);

                    cell = row.insertCell(15);
                    text = document.createTextNode('' + d['volts_10V'].toFixed(2));
                    cell.appendChild(text);
                    cell = row.insertCell(16);
                    text = document.createTextNode('' + (d['capacity_10V']*100).toFixed(2));
                    cell.appendChild(text);
                    cell = row.insertCell(17);
                    text = document.createTextNode('' + d['volts_24V'].toFixed(2));
                    cell.appendChild(text);
                    cell = row.insertCell(18);
                    text = document.createTextNode('' + (d['capacity_24V']*100).toFixed(2));
                    cell.appendChild(text);

                }
            }
        }
        xhttp.open("GET", "/db/" + currGlider, true);
        xhttp.send();
            
    }

    function showTable() {
        $('mainImage').setAttribute('hidden', '');
        $('mainTable').removeAttribute('hidden');
    }

    function loadCmdfile(dive) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                resp = JSON.parse(this.responseText);
                if (resp['file'] == 'cmdfile') {
                    $('cmdfile').value = resp['contents'];
                }
            }
        }
        xhttp.open("GET", "/cmdfile/" + currGlider, true);
        xhttp.send();
    }

    function loadStatus(glider) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                resp = JSON.parse(this.responseText);
                document.title = resp['glider'];
                currTitle = resp['glider'];
                if (parseInt(resp['dive']) != currDive) {
                    currDive = maxDive = parseInt(resp['dive']);
                    loadPlots(currDive);
                }
                engplots = resp['engplots'];
            }
            buildTable();
        }
        xhttp.open("GET", "/status/" + glider, true);
        xhttp.send();
        setupStream(glider);
    }

    function clearPlots() {
        while($('bottom').firstChild) {
            $('bottom').removeChild($('bottom').firstChild);
        }
    }

    function addPlot(p, x, plotly) {
        img = document.createElement('img');
        img.src = '/png/' + currGlider + '/' + currDive + '/' + p;
        img.style = "position: absolute; left: " + x + "; top: 0; width:180px; heigh:169px;"
        img.onclick = function() { showPlot(p, plotly); };
        img.title = p;
        $('bottom').appendChild(img);
    }

    function addEng(p, x, plotly) {
        img = document.createElement('img');
        img.src = '/eng/' + currGlider + '/' + p;
        img.style = "position: absolute; left: " + x + "; top: 0; width:180px; heigh:169px;"
        img.onclick = function() { showEng(p, plotly); };
        img.title = p;
        $('bottom').appendChild(img);
    }

    function loadPlots(dive) {
        var xhttp = new XMLHttpRequest();
        var plots;
        var img;
        var x = 0;
        var idx;
        var priority = ["diveplot", "raw_ctd", "ts", "vert_vel"];

        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                resp = JSON.parse(this.responseText);
                clearPlots();
                var plots = resp['dvplots'];
                var plotly = resp['plotlyplots'];
                // var engplots = resp['engplots'];

                for (p of priority) {
                    if (plots.includes(p)) {
                        addPlot(p, x, plotly.includes(p));
                        x += 200;
                        idx = plots.indexOf(p);
                        plots.splice(idx, 1); 
                    }
                }
                for (p of plots) {
                    addPlot(p, x, plotly.includes(p));
                    x += 200;
                }
                for (p of engplots) {
                    addEng(p, x, false);
                    x += 200;
                }

                showPlot(currElt, plotly.includes(currElt));
                // $('mainImage').src = '/png/' + currGlider + '/' + dive + '/diveplot';
                // $('mainImage').removeAttribute('hidden'); 
                // $('mainTable').setAttribute('hidden', ''); 
            }
            currDive = dive;
        }
        xhttp.open("GET", "/plots/" + currGlider + '/' + dive, true);
        xhttp.send();
    }
   
    function changeDive(dir) {
        var c = currDive;

        currDive += dir;
        if (currDive > maxDive)
            currDive = maxDive;
        else if (currDive < 1)
            currDive = 1;

        if (currDive != c) {
            loadPlots(currDive);
        }
    }
        
    function init() {
        glider = window.location.pathname.substring(1);
        currGlider = glider;
        console.log(glider);
        loadStatus(glider);
        loadCmdfile(0);
    }

</script>

<html>
<body onload="init();" style="font-family: verdana, arial, tahoma, 'sans serif'; font-size: 12px;">
<div style="position: relative;">

<div id="main" style="position: absolute; left: 0; top: 0; width:1058px; height:894px; overflow:auto;">
    <img id="mainImage">
    <table id="mainTable" hidden="hidden" style="height:894px; width:1058px; font-size:12px;" rules=groups> 
    <colgroup span=4>
    <colgroup span=6>
    <colgroup span=2>
    <colgroup span=3>
    <colgroup span=4>
    <tbody style="height:894px; width:1058px; overflow-y:auto; display:block">
        <tr bgcolor="#aaaaaa" align="center">
            <th>dive</th>
            <th>end</th>
            <th>length</th>
            <th>depth</th>
            <th>dog</th>
            <th>cog</th>
            <th>dtw</th>
            <th>ctw</th>
            <th>dtg</th>
            <th>ctg</th>
            <th>Umag</th>
            <th>Udir</th>
            <th>temp</th>
            <th>RH</th>
            <th>int P</th>
            <th>volts10</th>
            <th>% cap</th>
            <th>volts24</th>
            <th>% cap</th>
        </tr>
    </tbody>
    </table>
</div>

<div id="commlog" style="position: absolute; left:1060; top:0; width:800; height:400; overflow:auto; font-size: 10px; box-sizing:border-box; border:1px solid black; white-space:pre;">

</div>

<div id="divCmdfile" style="position: absolute; left:1060; top:405; width:600px; height:400px; font-size: 12px;">
    <textarea id="cmdfile" style="width:100%; height:100%; box-sizing:border-box;">
    </textarea>
    <button id="btnSave" type="button" onclick="saveCmdfile();">Save</button>
    <button id="btnGO" type="button" onclick="changeDirective('GO');" style="background-color:#00aa00;">GO</button>
    <button id="btnQUIT" type="button" onclick="changeDirective('QUIT');" style="background-color:#ff0020;">QUIT</button>
    <button id="btnRESUME" type="button" onclick="changeDirective('RESUME');" style="background-color:yellow;">RESUME</button>
</div>

<div id="bottomButtons" style="position: absolute; left: 0; top: 900; width: 1058; height: 180; overflow: auto;">
    <button id="btnUp" type="button" onclick="changeDive(1);" style="font-size: 18px; width:80px;">&#x2191</button><br><br>
    <button id="btnTable" type="button" onclick="showTable();" style="font-size: 48px; width:80px;">&#x2637</button><br><br>
    <button id="btnDown" type="button" onclick="changeDive(-1);" style="font-size: 18px; width:80px;">&#x2193</button>
</div>

<div id="bottom" style="position: absolute; left: 100; top: 900; width: 958; height: 180; overflow: auto;">

</div>

</div>
</body>
</html>
