<link rel="stylesheet" href="/script/dialogs.css" />

<style>
    a:link,.spanClick           {color:#0000ff; text-decoration:none}
    a:visited {color:#0000aa; text-decoration:none}
    a:hover,.spanClick:hover    {color:#0000aa; text-decoration:underline}
    a:active,.spanClick:active  {color:#0000aa; text-decoration:underline}

    option { background-color:#eeeeee; }
    select { background-color:#eeeeee; }
    button { background-color:#dddddd; }
    button.tool { background-color:#dddddd; margin-top: 2px; margin-bottom: 2px; width:48px; height:48px;  border:0px; }

    .thumb { mix-blend-mode:multiply }

    .editFile {
        width:100%; 
        height:100%; 
        box-sizing:border-box; 
        background-color:#bbbbbb;
        border: 1px solid black;
    }

    body {
        background-color: #999999;
        color: #000000;
    }

    table {
        color: #000000;
    }
</style>
<script src="/script/plotly-latest.min.js"></script>
<script src="/script/util.js"></script>
<script src="/script/dialogs.js"></script>
<script>

    var blurTimer  = false;
    var isBlurred  = false;
    var isFlashing =false;
    var currTitle  = "";

    var currGlider = '';
    var currMission = '';

    var engplots = [];
    var engplotlyplots = [];
    var sgplots = [];
    var sgplotlyplots = [];

{% if runMode == 'pilot' %}
    var fixes = [];
    var connect_t = 0;

    var fixTimer = null;
{% endif %}

    var accessToken;

    function startFlash() {
        isFlashing = true;
        blurTimer = window.setInterval(function() 
            {
                document.title = document.title == currTitle ? currTitle + "..." : currTitle;
            }, 1000);
    }
 
    window.onblur=function() {
        isBlurred = true;
    }

    window.onfocus=function() { 
        isBlurred = false;
        isFlashing = false;
        document.title = currTitle;
        if (blurTimer) {
            clearInterval(blurTimer);
        }
        blurTimer = false;
    }

    function mission() {
        if (currMission != '')
            return `?mission=${currMission}`;
        else
            return '';
    }

{% if runMode == 'pilot' %}
    function updateTimer() {
        if (fixes.length > 0) {
            $('lastFix').innerHTML = '' + (Date.now()/1000 - fixes.at(-1).t).toFixed(0) + 's';
        }
        if (connect_t > 0) {
            $('lastConnect').innerHTML = '' + (Date.now()/1000 - connect_t).toFixed(0) + 's';
        }
        fixTimer = setTimeout('updateTimer()', 1000);
    }
{% endif %}

    let wsocket  = null;
    var lastSetup = 0;
    var first = true;

    function setupStream(glider, first) {
        if (Date.now() < lastSetup + 5000) {
            setTimeout(() => {
                setupStream(glider, false);
            }, 5000);
            console.log('too soon');
            return;
        }
        lastSetup = Date.now();
 
        if (wsocket != null) {
            wsocket.close();
            console.log('closing previous stream');
        }
        console.log('setting up stream');
        var loc = window.location, new_uri;
        if (loc.protocol === "https:") 
            new_uri = "wss:";
        else
            new_uri = "ws:";

        new_uri += "//" + loc.host;
        new_uri += "/stream/" + (first ? "init/" : "restart/") + glider + mission();
        console.log(new_uri);
        wsocket = new WebSocket(new_uri);

        wsocket.onerror = function(error) {
            console.log('stream error detected');
            wsocket.close();
            setupStream(glider, false);
        };

        wsocket.onclose = function(e) {
            if (e.wasClean) {
                console.log('stream closed cleanly');
            }
            else {
                console.log('connection died');
                setupStream(glider, false);
            }
        };

        var chunk = "";
        wsocket.onmessage = function(e) { 
            var pieces, content, data, i;
            var vals = {};
            var update;
            var newDive;
            var newCmdfile;
            var d, pieces, lines;
            var pt, fix;
            var yr, mo, da, hr, mi, se;
            var tstr;
            const months = {'Jan': 1, 'Feb': 2, 'Mar': 3, 'Apr': 4, 'May': 5, 'Jun':6, 'Jul':7, 'Aug':8, 'Sep':9, 'Oct':10, 'Nov':11, 'Dec':12};
            var styles = ["font-weight:bold;", "font-weight:bold; color:red;", "font-weight:bold; color:green;"]
            var bolds = {"targets":0, "science":0, "cmdfile":0, "pdoscmds.bat":0, "Connected":0, "QUIT":1, "RECOV_CODE":1, "GO":2};

            var line = e.data;
            if (line.startsWith('NEW=')) {
                console.log(line);
                pieces = line.split('=')[1].split(',');
                glider  = parseInt(pieces[0]);
                newDive = parseInt(pieces[1]);
                which   = pieces[2];
                if (which == 'files=perdive') {
                    loadPlots(newDive, true);
                    buildTable(currGlider, newDive);
                }
                else {
                    loadStatus(currGlider, -1);
                    console.log('unexpected NEW= response');
                }
                // loadLog(newDive);
            }
{% if runMode == 'pilot' %}
            else if (line.startsWith('CMDFILE=')) {
                newCmdfile = line.split('=')[1];
                $('cmdfile').value = newCmdfile;
            }
            else {
                lines = line.split('\n');

                var elt = $('commlog');
                elt.scrollTop = elt.scrollHeight;
                for (b of Object.keys(bolds)) {
                    line = line.replaceAll(b, '<span style="' + styles[bolds[b]] + '">' + b + '</span>');
                } 


                elt.innerHTML += line;
                for (d of lines) {
                    if (d.includes('GPS')) {
                        p = commGPSParser(d);
                        if (p != null) {
                            if (fixes.length == 0 || fixes.at(-1).t < p.fix.t) {
                                console.log('pushing fix at ' + p.fix.t);
                                fixes.push(p.fix);
                            } 
                            if (fixTimer == null) {
                                updateTimer();
                            }
                            if (fixes.length >= 2) {
                                var sog, cog, dog, dt;
                                dt = fixes.at(-1).t - fixes.at(-2).t;
                                dog = haversine(fixes.at(-1).pt, fixes.at(-2).pt);
                                cog = bearing(fixes.at(-2).pt, fixes.at(-1).pt);
                                sog = dog/dt/0.514;
                                $('SOG').innerHTML = sog.toFixed(2) + 'kts';
                                $('COG').innerHTML = cog.toFixed(1) + '&deg;';
                                $('DOG').innerHTML = dog.toFixed(0) + 'm';
                                $('dt').innerHTML = dt.toFixed(0) + 's';
                            }
                            else {
                                $('SOG').innerHTML = '0';
                                $('COG').innerHTML = '0';
                                $('DOG').innerHTML = '0';
                                $('dt').innerHTML = '0';
                            } 
                            
                            $('position').innerHTML = p.position;
                            $('positionTime').innerHTML = '@ ' + p.positionTime;
                            $('RH').innerHTML = p.RH;
                            $('intP').innerHTML = p.intP;
                            $('volts').innerHTML = p.volts;
                            $('pitch').innerHTML = p.pitch;
                            $('depth').innerHTML = p.depth;
                            $('dive').innerHTML = p.dive;
                            $('cycle').innerHTML = p.cycle;
                            $('call').innerHTML = p.call;
                        }    
                    }
                    else if (d.includes('Connected at')) {
                        if (!first) beep();
                        pieces = d.split(' ');
                        if (pieces.length == 8) {
                            yr = pieces[7];
                            mo = months[pieces[3]];
                            da = parseInt(pieces[4]);
                            hr = parseInt(pieces[5].split(':')[0]);
                            mi = parseInt(pieces[5].split(':')[1]);
                            se = parseInt(pieces[5].split(':')[2]);
                            tstr = yr + '-' + mo.zeroPad() + '-' + da.zeroPad()
                                   + 'T' + hr.zeroPad() + ':' + mi.zeroPad() + ':' + se.zeroPad() + '.000Z';
                            console.log(tstr);
                            if (pieces[6] == 'PST')
                                connect_t = Date.parse(tstr)/1000 + 8*3600;
                            else
                                connect_t = Date.parse(tstr)/1000 + 7*3600;
                            if (fixTimer == null) {
                                updateTimer();
                            }
                        }
                    }
                }
                console.log('last line=[' + lines.at(-1) + ']') 

                first = false;
                elt.scrollTop = elt.scrollHeight;
            }
{% else %}
            else if (line.startsWith('CMDFILE=')) {
                newDirective = line.split('=')[1];
            }
{% endif %}
            if (isBlurred && !isFlashing) {
                startFlash();
            }
        };
    }

    var currDive = -1;
    var maxDive = 10000; 
    var currElt = 'diveplot';
    var controlFileDive = {};

    var numPages = 0;

{% if runMode == 'pilot' %}
    function saveControl(force) {
        var json = {};
        var file = $('selectFile').value;

        json['force'] = force;
        json['file'] = file;
        json['contents'] = $(file).value; 

        fetch(`/save/${currGlider}/${file}${mission()}`, 
        {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ${accessToken}'
            },
            body: JSON.stringify(json),
        })
        .then(res => res.text())
        .then(text => {
            alert(text);
        })
        .catch(error => {
            alert(error);
        });
    }

    function changeDirective(cmd) {
        var newCmd = '$' + cmd;
        console.log(newCmd + ' ' + cmd);
        $('cmdfile').value = $('cmdfile').value.replace('$GO', newCmd);
        $('cmdfile').value = $('cmdfile').value.replace('$QUIT', newCmd);
        $('cmdfile').value = $('cmdfile').value.replace('$RESUME', newCmd);
        $('cmdfile').value = $('cmdfile').value.replace('$EXIT_TO_MENU', newCmd);
    }

    function loadControlFile(file, dive) {
        fetch(`/control/${currGlider}/${file}${mission()}`)
        .then(res => res.json())
        .then(data => {
            if ('file' in data && data['file'] == file) {
                $(file).value = data['contents'];
            }
            if ('dive' in data && data['dive'] > -1) {
                controlFileDive[file] = data['dive'];
            }
        })
        .catch(error => {
            console.log(`${dive}-${file}-${error}`);
        })
    }

    const knownFiles = ["cmdfile", "targets", "science", "scicon.sch", "pdoscmds.bat", "tcm2mat.cal", "sg_calib_constants.m"];
    const cmdfileButtons = ['btnGO', 'btnQUIT', 'btnRESUME'];
    function changeFile() {
        var file = $('selectFile').value;
        for (var f of knownFiles) {
            if (f == file)
                $(f).removeAttribute('hidden');
            else
                $(f).setAttribute('hidden', '');
        }

        for (var b of cmdfileButtons) {
            if (file != "cmdfile") 
                $(b).setAttribute('hidden', '');
            else 
                $(b).removeAttribute('hidden');
        }

        if (file in controlFileDive) {
            $('fileDive').innerHTML = '(' + controlFileDive[file] + ')';
            $('fileDive').removeAttribute('hidden');
        }
        else {
            $('fileDive').setAttribute('hidden', '');
            $('fileDive').innerHTML = '';
        }
    }
{% endif %}

    function popupPlotly(which, dive, elt) {
        window.open('/div/' + which + '/' + currGlider + '/' + dive + '/' + elt + mission(), `${currGlider}-${dive}-${elt}`);
    }

    function popupSelftest() {
        window.open('/selftest/' + currGlider + mission(), currGlider + '-selftest');
    }

    function popupMap() {
        window.open('/map/' + currGlider + mission(), currGlider + '-map');
    }

    function setVisibility(elt) {
        const divs = ['mainImage', 'mainTable', 'logDiv', 'plotlyDiv', 'logfileDiv', 'notificationsDiv', 'engfileDiv', 'capfileDiv'];
        for (var d of divs) {
            if (d != elt) $(d).setAttribute('hidden', '');
        }
        $(elt).removeAttribute('hidden');
    }
    function showPlot(which, elt, plotly) {
        console.log('showing ' + elt);
        setVisibility('mainImage');
        $('mainImage').src = '/png/' + which + '/' + currGlider + '/' + currDive + '/' + elt + mission();
        if (plotly) {
            $('mainImage').ondblclick = function() { popupPlotly(which, currDive, elt); }
            $('mainImage').oncontextmenu = function() { popupPlotly(which, currDive, elt); }
        }
        else {
            $('mainImage').ondblclick = null;
            $('mainImage').oncontextmenu = null;
        }
        currElt = elt;
    }

    function addTableRow(d) 
    {
        var row, cell, text;
        var tbody = $('mainTable').getElementsByTagName('tbody')[0];
        const colors = ["#cccccc", "#eeeeee"];
        var i, c;
        var date;
        var course; 
        var dist;
        var n, e;
        var rowID = 'row' + d['dive'];

        if ($(rowID) != null) {
            console.log('row exists ' + rowID);
            $(rowID).remove();
        }
     
        row = tbody.insertRow(1);
        row.id = rowID;
        
        i = $('mainTable').rows.length % 2;
        row.style.backgroundColor = colors[i];
        cell = row.insertCell(0);
        
        alerts = 'alerts' in d && d['alerts'] > 0 ? 'a' : '';
        capture = 'capture' in d && d['capture'] > 0 ? 'c' : '';
        cell.innerHTML = '<a href="#" onclick="loadPlots(' + d['dive'] + ', false);">' + d['dive'] + '</a>' + alerts + capture;
        cell.style.textAlign = 'left';
        // cell.appendChild(text);

        date = new Date(1000*(d['log_start'] + d['total_flight_time_s']));
        cell = row.insertCell(1); 
        text = document.createTextNode((date.getFullYear() - 2000) + '/' +
                                       (date.getMonth() + 1).zeroPad() + '/' + 
                                       date.getDate().zeroPad() + ' ' + 
                                       date.getHours().zeroPad() + ':' + 
                                       date.getMinutes().zeroPad());
        cell.appendChild(text);

        cell = row.insertCell(2); 
        text = document.createTextNode('' + (d['total_flight_time_s']/60).toFixed(0));
        cell.appendChild(text);

        cell = row.insertCell(3);
        text = document.createTextNode('' + d['max_depth'].toFixed(0) + '(' + d['log_D_TGT'] + ')');
        cell.appendChild(text);

        dist = Math.sqrt(d['GPS_north_displacement_m']*d['GPS_north_displacement_m'] 
                         + d['GPS_east_displacement_m']*d['GPS_east_displacement_m']);
        course = Math.atan2(d['GPS_east_displacement_m'], d['GPS_north_displacement_m'])*180.0/Math.PI;
        if (course < 0) {
            course = course + 360;
        }
        cell = row.insertCell(4);
        text = document.createTextNode('' + (dist/1000).toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(5);
        text = document.createTextNode('' + course.toFixed(1));
        cell.appendChild(text);

        n = d['flight_avg_speed_north'] * d['total_flight_time_s'];
        e = d['flight_avg_speed_east'] * d['total_flight_time_s'];
        dist = Math.sqrt(n*n + e*e);
        course = Math.atan2(e, n)*180.0/Math.PI;
        if (course < 0) {
            course = course + 360;
        }
        cell = row.insertCell(6);
        text = document.createTextNode('' + (dist/1000).toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(7);
        text = document.createTextNode('' + course.toFixed(1));
        cell.appendChild(text);

        cell = row.insertCell(8);
        text = document.createTextNode('' + (d['meters_to_target']/1000).toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(9);
        text = document.createTextNode('' + (d['mag_heading_to_target'] + d['magnetic_variation']).toFixed(1));
        cell.appendChild(text);

        cell = row.insertCell(10);
        text = document.createTextNode('' + d['dog_efficiency'].toFixed(2));
        cell.appendChild(text);

        
        dist = Math.sqrt(d['depth_avg_curr_east']*d['depth_avg_curr_east'] 
                         + d['depth_avg_curr_north']*d['depth_avg_curr_north']);
        course = Math.atan2(d['depth_avg_curr_east'], d['depth_avg_curr_north'])*180.0/Math.PI;
        if (course < 0) {
            course = course + 360;
        }

        cell = row.insertCell(11);
        text = document.createTextNode('' + (dist*100.0).toFixed(1));
        cell.appendChild(text);

        cell = row.insertCell(12);
        text = document.createTextNode('' + course.toFixed(1));
        cell.appendChild(text);

        cell = row.insertCell(13);
        text = document.createTextNode('' + d['log_HUMID'].toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(14);
        text = document.createTextNode('' + d['log_INTERNAL_PRESSURE'].toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(15);
        cell.classList.add("volt10");
        text = document.createTextNode('' + d['batt_volts_10V'].toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(16);
        cell.classList.add("volt10");
        text = document.createTextNode('' + (d['batt_capacity_10V']*100).toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(17);
        cell.classList.add("volt24");
        text = document.createTextNode('' + d['batt_volts_24V'].toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(18);
        cell.classList.add("volt24");
        text = document.createTextNode('' + (d['batt_capacity_24V']*100).toFixed(2));
        cell.appendChild(text);
        
        cell = row.insertCell(19);
        text = document.createTextNode('' + d['error_count'].toFixed(0));
        cell.appendChild(text);
    }

    function buildTable(glider, dive) {
        var q;
        console.log("building table");

    
        q = `/db/${glider}/${dive}${mission()}`
        if (dive  == -1) {
            clearTable();
        }
 
        fetch(q)
        .then(res => res.text())
        .then(data => {
            data = JSON.parse(data);

            var has10 = false;
            var has24 = false;
            for (d of data) {
                addTableRow(d);
                if (d['batt_capacity_24V'] > 0)
                    has24 = true;
                if (d['batt_capacity_10V'] > 0) 
                    has10 = true;
            }
            if (has10 == false) {
                coll = document.getElementsByClassName("volt10");
                for (var i = 0 ; i < coll.length ; i++)
                    coll[i].style.display = "none";
                $('volt24_header').innerHTML = 'volts';
            }
            else if (has24 == false) {
                coll = document.getElementsByClassName("volt24");
                for (var i = 0 ; i < coll.length ; i++)
                    coll[i].style.display = "none";
                $('volt10_header').innerHTML = 'volts';
            }
        })
        .catch(error => {
            console.log(error);
        });
    }

    function showTable() {
        setVisibility('mainTable'); 
    }

    function showPlotly() {
        setVisibility('plotlyDiv');
    }

    function showLog() {
        setVisibility('logDiv');
        currElt = 'logfile';
    }

    function showLogFile() {
        setVisibility('logfileDiv');
        currElt = 'logfileRaw';
    }

    function showEng() {
        setVisibility('engfileDiv');
        currElt = 'engfile';
    }

    var critLine = null;
    function showCap() {
        setVisibility('capfileDiv');
        currElt = 'capfile';
        if (critLine !== null)
            $(critLine).scrollIntoView();
    }

    function showNotifications() {
        setVisibility('notificationsDiv');
        currElt = 'notifications';
    }

    function loadAbout(mission, org) {
        var cell, t, tbody, row;

        console.log(mission);

        d = $('aboutContent');
        t = document.createElement('table');
        d.appendChild(t);
        tbody = document.createElement('tbody');
        t.appendChild(tbody);

        for (k of Object.keys(mission)) {
            if (mission[k] == null)
                continue;

            row = tbody.insertRow();
            cell = row.insertCell(0);
            cell.innerHTML = k;
            cell = row.insertCell(1);
            cell.innerHTML = mission[k];
        } 
    }

    function loadStatus(glider, dive) {
        fetch(`/status/${glider}${mission()}`)
        .then(res => res.text())
        .then(data => {
            console.log(data);
            if (data.includes("authorization failed")) {
                openLoginForm();
                return;
            }
            data = JSON.parse(data);
            document.title = data['glider'];
            currTitle = data['glider'];
            if (dive == -1 && parseInt(data['dive']) != currDive) {
                currDive = maxDive = parseInt(data['dive']);
                loadPlots(currDive, true);
                // loadLog(currDive);
            }
            else if (dive > 0 && dive < parseInt(data['dive'])) {
                maxDive = parseInt(data['dive']);
                currDive = dive;
                loadPlots(currDive, true);
                // loadLog(currDive);
            }
            engplotlyplots = data['engplotly'];
            engplots = data['engplots'];
            sgplots = data['sgplots'];
            sgplotlyplots = data['sgplotly'];
            buildTable(glider, -1);
            console.log(data);
            loadAbout(data.mission, data.organization);
        })
        .catch(error => {
            console.log(error);
        });

    }

    function clearPlots() {
        while($('bottom').firstChild) {
            $('bottom').removeChild($('bottom').firstChild);
        }
        plotList = []
    }

    function clearTable() {
        while($('mainTable').rows.length > 1) {
            $('mainTable').deleteRow(1);
        }
    }

    var plotList = []
    function addPlot(which, p, x, plotly) {
        img = document.createElement('img');
        img.src = '/png/' + which + '/' + currGlider + '/' + currDive + '/' + p + mission();
        img.style = "position: absolute; left: " + x + "; top: 0; max-width:180px; max-height:169px; mix-blend-mode:multiply;"
        img.onclick = function() { showPlot(which, p, plotly); };
        img.title = p;
        img.id = 'thumb' + p;
        $('bottom').appendChild(img);
        plotList.push(p);
    }

    function loadLog(dive) {
        fetch(`/log/${currGlider}/${dive}${mission()}`)
        .then(res => res.text())
        .then(data => {
            $('logDiv').innerHTML = 'Dive ' + dive + '<br>';
            $('logDiv').innerHTML += data;
        })
        .catch(error => {
            console.log(`loadLog - ${error}`);
        });
    }

    function loadFile(dive, ext, div) {
        fetch(`/file/${ext}/${currGlider}/${dive}${mission()}`)
        .then(res => res.text())
        .then(data => {
            if (data == 'none' && ext == 'cap') {
                $('btnCapFile').style.backgroundImage = "url('/script/images/cap-none-icon.png')";
                $(div).innerHTML = 'no capture file'; 
            }
            else {
                if (ext == 'cap') {
                    critLine = null;

                    if (data.includes(',C,')) {
                        var i = 0;
                        var txt = '';
                        for (var x of data.split('\n')) {      
                            if (x.includes(',C,'))  {
                                if (critLine == null) 
                                    critLine = 'crit' + i;
                                txt += `<span id="crit${i}"><b>${x}</b></span>\n`;
                            }
                            else {
                                txt += x + '\n';
                            }
                            i++;
                        } 
                        $(div).innerHTML = '<pre>' + txt + '</pre>';
                        
                        $('btnCapFile').style.backgroundImage = "url('/script/images/cap-crit-icon.png')";
                    }
                    else {
                        $(div).innerHTML = '<pre>' + data + '</pre>';
                        $('btnCapFile').style.backgroundImage = "url('/script/images/cap-icon.png')";
                    }
                }
                else {
                    $(div).innerHTML = '<pre>' + data + '</pre>';
                }
            }
        })
        .catch(error => {
            console.log(`loadFile - ${ext} ${error}`);
        });
    }
 
    async function loadNotifications(dive) {
        var i;
        var html;
        var pieces;
        let urls = [`/alerts/${currGlider}/${dive}${mission()}`, `/deltas/${currGlider}/${dive}${mission()}`];
        let notify = false;

        let resp = await Promise.all(urls.map(url => fetch(url).then(res => res.text())));
        let alerts = resp[0];
        let deltas = JSON.parse(resp[1]);

        html = "<h3>alerts</h3><p>";
        if (alerts != "not found") {
            html += alerts;
            notify = true;
        }

        html += '<h3>parameter changes</h3><p><table style="margin-left:40px;">';
        for (i = 0 ; i < deltas['parm'].length; i++) {
            pieces = deltas['parm'][i].split(',');
            html += `<tr><td>${pieces[0]}&nbsp;&nbsp;&nbsp;</td><td>${pieces[1]}</td><td> <b>&#10230;</b> <td>${pieces[2]}</td></tr>`;
        } 
        
        html += "</table><p><h3>control files</h3><p>";
        for (i = 0 ; i < deltas['file'].length; i++) {
            html += '<b>' + deltas['file'][i]['file'] + '</b>';
            html += '<div style="margin-left:40px;"><pre>' + deltas['file'][i]['contents'] + '</pre></div>';
        }

        $('notificationsDiv').innerHTML = html;

        if (deltas['file'].length > 0 || deltas['parm'].length > 0) {
            notify = true;
        }        

        if (notify) 
            $('btnNotifications').style.backgroundImage = "url('/script/images/notification-active-icon.png')";
        else
            $('btnNotifications').style.backgroundImage = "url('/script/images/notification-icon.png')";
    }
 
    function jumpScroll(n) {
        if (n <= plotList.length) {
            $('bottom').scrollTo(200*n, 0, 'smooth');
            $('thumb' + plotList[n]).click();
        }
        return false;
    }

    function loadPlots(dive, setCurr) {
        var plots;
        var img;
        var x = 0;
        var idx;
        var cookie;
        var priority;
        var first = false;
        const stockPriority = ["diveplot", "ctd", "ts", "vert_vel", "pitch", "roll", "roll_rate", "cog", "ctw", 
                               "wlbb2fl_Chlorophyll_fluorescence", "wlbb2fl_backscatter", "aa4831"];
       
        const subs = { "wlbb2fl_Chlorophyll_fluorescence": "Chlorophyll",
                       "wlbb2fl_backscatter": "backscatter", "ts": "T-S" };

        cookie = readCookie("order");
        if (cookie != null) 
            priority = cookie.split(",");
        else
            priority = stockPriority;

        currDive = dive; // inside the then or before plots might be actually loaded?

        loadLog(dive);
        loadFile(dive, 'log', 'logfileDiv');
        loadFile(dive, 'eng', 'engfileDiv');
        loadFile(dive, 'cap', 'capfileDiv');
        loadNotifications(dive);

        fetch(`/plots/${currGlider}/${dive}${mission()}`)
        .then(res => res.json())
        .then(resp => {
            var links = [];
            clearPlots();
            var plots = resp['dvplots'];
            var plotly = resp['plotlyplots'];
            // var engplots = resp['engplots'];

            var ab = plots.indexOf('ab');
            if (ab > -1 && !priority.includes('ab')) {
                plots.splice(ab, 1);
            }

            for (p of priority) {
                if (plots.includes(p)) {
                    addPlot('dv', p, x, plotly.includes(p));
                    x += 200;
                    idx = plots.indexOf(p);
                    plots.splice(idx, 1); 
                    links.push(p in subs ? subs[p] : p);

                    if (!first && setCurr) {
                        first = true;
                        currElt = p;
                    } 
                }
            }
            plots.sort();
            for (p of plots) {
                addPlot('dv', p, x, plotly.includes(p));
                links.push(p in subs ? subs[p] : p);
                x += 200;

                if (!first && setCurr) {
                    first = true;
                    currElt = p;
                } 
            }


            if (ab > -1 && !priority.includes('ab')) {
                addPlot('dv', 'ab', x, false);
                links.push('ab' in subs ? subs['ab'] : 'ab');
                x += 200;
            }

            links.push('eng');

            engplots.sort();
            for (p of engplots) {
                addPlot('eng', p, x, engplotlyplots.includes(p));
                links.push(p in subs ? subs[p] : p);
                x += 200;

                if (!first && setCurr) {
                    first = true;
                    currElt = p;
                } 
            }

            links.push('sg');
            sgplots.sort();
            for (p of sgplots) {
                addPlot('section', p, x, sgplotlyplots.includes(p));
                links.push(p in subs ? subs[p] : p);
                x += 200;

                if (!first && setCurr) {
                    first = true;
                    currElt = p;
                } 
            }

            if (currElt == 'logfile') 
                showLog(); 
            else if (currElt == 'logfileRaw')
                showLogFile();
            else if (currElt == 'engfile')
                showEng();
            else if (currElt == 'capfile')
                showCap();
            else if (currElt == 'notifications')
                showNotifications();
            else if (currElt.includes('plotly'))
                doPlotlyPlot(currElt.split('-')[1]);
            else if (engplots.includes(currElt))
                showPlot('eng', currElt, engplotlyplots.includes(currElt));
            else if (sgplots.includes(currElt))
                showPlot('section', currElt, sgplotlyplots.includes(currElt));
            else 
                showPlot('dv', currElt, plotly.includes(currElt));

            // $('mainImage').src = '/png/' + currGlider + '/' + dive + '/diveplot';
            // $('mainImage').removeAttribute('hidden'); 
            // $('mainTable').setAttribute('hidden', ''); 


            var n = links.length - 1;
            var e = links.indexOf('eng');
            var ab = links.indexOf('ab');
            var mn = ab > -1 ? ab - 1 : e - 1;
            var all;

            numPages = parseInt(n / 5) + 1;

            links.splice(e, 1); 

            var sec = links.indexOf('sg');

            var j;
            $('bottomLinks').innerHTML = '';
            for (var i = 0 ; i < mn ; i += 5) {
                if (i + 4 < mn)
                    j = i+4;
                else
                    j = mn;

                all = links.slice(i,j+1).join(', ');
                $('bottomLinks').innerHTML += '<span class="spanClick" onclick="jumpScroll(' + i + ');" title="' + all +'">' + links[i] + '&hellip;' + links[j] + '</span> <b>&#124;</b> '; 
            }
            if (ab > -1) //  && links[j] != 'ab')
                $('bottomLinks').innerHTML += '<span class="spanClick" onclick="jumpScroll(' + ab + ');">ab</span> <b>&#124;</b> ';

            mn = sec-1;
            for (var i = e ; i < mn ; i += 5) {
                if (i + 4 < mn)
                    j = i+4;
                else
                    j = mn;

                all = links.slice(i,j+1).join(', ');
                links[i] = links[i].replace('eng_', ''); 
                links[i] = links[i].replace('mission_', ''); 
                links[i] = links[i].replace('SDCARD_', ''); 
                links[i] = links[i].replace('FM_', ''); 
                links[j] = links[j].replace('eng_', ''); 
                links[j] = links[j].replace('mission_', ''); 
                links[j] = links[j].replace('SDCARD_', ''); 
                links[j] = links[j].replace('FM_', ''); 
                $('bottomLinks').innerHTML += '<span class="spanClick" onclick="jumpScroll(' + i + ');" title="' + all +'">' + links[i] + '&hellip;' + links[j] + '</span> <b>&#124;</b> '; 
            }

            // all = links.slice(e,sec).join(', ');
            // $('bottomLinks').innerHTML += '<span class="spanClick" onclick="jumpScroll(' + e + ');" title="' + all +'">eng</span> * ';

            links.splice(sec, 1); 

            all = links.slice(sec).join(', ');
            $('bottomLinks').innerHTML += '<span class="spanClick" onclick="jumpScroll(' + sec + ');" title="' + all +'">sections</span>';
        })
        .catch(error => {
            console.log(`loadPlots - ${error}`);
        });
    }
   
    function changeDive(dir) {
        var c = currDive;

        currDive += dir;
        if (currDive > maxDive)
            currDive = maxDive;
        else if (currDive < 1)
            currDive = 1;

        if (currDive != c) {
            loadPlots(currDive, false);
            // loadLog(currDive);
        }
    }
      
    function getSelectionText() {
        var text = "";
        var activeEl = document.activeElement;
        var activeElTagName = activeEl ? activeEl.tagName.toLowerCase() : null;
        if (
          (activeElTagName == "textarea") || (activeElTagName == "input" &&
          /^(?:text|search|password|tel|url)$/i.test(activeEl.type)) &&
          (typeof activeEl.selectionStart == "number")
        ) {
            text = activeEl.value.slice(activeEl.selectionStart, activeEl.selectionEnd);
        } else if (window.getSelection) {
            text = window.getSelection().toString();
        }
        return text;
    } 

    function parameterHelp(which) {
        var str = false;

        if (which == 'cmdfile') {
            var s = $(which).selectionStart;
            var e = $(which).selectionEnd;
            var v = $(which).value;

            if (v[s-1] == '$' && v[e] == ',') {
                str = v.substring(s, e);
            }
        }
        else if (which == 'logfile') {
            var v = window.getSelection().toString();
            var h = $('logfileDiv').innerHTML;
            var i = h.indexOf(v);
            if (i > 0 && h[i-1] == '$' && h[i + v.length] == ',') {
                str = v;
            }
        }
            
        if (str) {
            window.open('/parms#' + str, 'parms');
        }
    }

    function doPlotlyProfiles(which) {
        let x = $('selPlotlyContour').value;
        var stride = $('selPlotlyProfileStride').value;
        var zStride = $('selPlotlyZStride').value;
    
        $('btnPlotlyContour').disabled = true;
        $('btnPlotlyProfiles').disabled = true;
        var def  = $('btnPlotlyContour').style.backgroundColor;
        $('btnPlotlyContour').style.backgroundColor = 'yellow';
        $('btnPlotlyProfiles').style.backgroundColor = 'yellow';

        fetch(`/pro/${currGlider}/${x}/0/-1/${stride}/${zStride}${mission()}`)
        .then(res => res.text())
        .then(data => {
            data = data.replaceAll('NaN', 'null');
            data = JSON.parse(data);
            // console.log(data[x]);
            if (which == 'contour') {
                var d = [{
                    z: data[x],
                    y: data['depth'],
                    type: 'contour',
                    /// xaxis: 'profile',
                    // yaxis: 'depth',
                    connectgaps: $('chkFillGaps').checked,
                    contours: {
                        coloring: 'heatmap',
                        showlabels: true,
                        labelfont: {
                            family: 'Raleway',
                            size: 12,
                            color: 'white',
                        },
                    }, 
                }];
                var layout = { 
                                font:       {size: 12},
                                margin: { t:20, l:80, r:80, b:80 },
                                xaxis: { title: 'profile/' + stride },
                                yaxis: { title: 'depth', autorange: 'reversed' },
                                plot_bgcolor: "#cccccc",
                                paper_bgcolor: "#bbbbbb",
                             };
                var config = { responsive: true };
                
                Plotly.newPlot($('plotlyPlotDiv'), d, layout, config);
                $('btnPlotlyContour').style.backgroundColor = def;
                $('btnPlotlyContour').disabled = false;
                $('btnPlotlyProfiles').style.backgroundColor = def;
                $('btnPlotlyProfiles').disabled = false;
            }
            else if (which == 'profiles') {
                var d = [];
                let nb = data[x].length;
                let np = data[x][0].length;
                var xd;

                for (var i = 0 ; i < np ; i++) {
                    xd = [];
                    for (var j = 0 ; j < nb ; j++) {
                        xd[j] = data[x][j][i];
                    }
                    d.push({
                            x:xd,
                            y:data['depth'],
                            mode: "lines",
                            type: "scatter",
                            connectgaps: $('chkFillGaps').checked,
                            name: 'dive ' + data['dive'][i]
                           });
                }
                var layout = {
                                font:       {size: 12},
                                margin: { t:20, l:80, r:80, b:80 },
                                xaxis: { title: x },
                                yaxis: { title: 'depth', autorange: 'reversed' },
                                plot_bgcolor: "#cccccc",
                                paper_bgcolor: "#bbbbbb",
                             };
                var config = { responsive: true };
                Plotly.newPlot($('plotlyPlotDiv'), d, layout, config);
                $('btnPlotlyContour').style.backgroundColor = def;
                $('btnPlotlyContour').disabled = false;
                $('btnPlotlyProfiles').style.backgroundColor = def;
                $('btnPlotlyProfiles').disabled = false;
            }
        })
        .catch(error => {
            console.log('plotly ' + error);
        })
    }

    function doPlotlyPlot(which) {
        var mode;
        let x = $('selPlotlyX').value;
        let x2 = $('selPlotlyX2').value;
        // let y = $('selPlotlyY').value;
        let y = [...$('selPlotlyY').selectedOptions].map(option => option.value);
        var query;

        if ($('chkMissionPlots').checked) {
            if (x2 == '-')
                query = `/query/${currGlider}/${x},${y.join(',')}${mission()}`;
            else
                query = `/query/${currGlider}/${x},${x2},${y.join(',')}${mission()}`;
            mode = 0;
        }
        else {
            if (x2 == '-')
                query = `/time/${currGlider}/${currDive}/${x},${y.join(',')}${mission()}`;
            else
                query = `/time/${currGlider}/${currDive}/${x},${x2},${y.join(',')}${mission()}`;

            mode = 1;
        }

        console.log('mode=' + mode + ' query=' + query);
        fetch(query)
        .then(res => res.text())
        .then(data => {
            currElt = 'plotly-' + which;
            data = data.replaceAll('NaN', 'null');
            data = JSON.parse(data);
            if (which == 'plot' && x2 == '-') {
                var d = [];
                var xd = mode == 0 ? data.map(v => v[x]) : data[x];
                for (var i = 0 ; i < y.length ; i++) {
                    var yd = mode ==  0 ? data.map(v => v[y[i]]) : data[y[i]];
                    d.push({
                            x: xd,
                            y: yd,
                            mode: x == "dive" ? "lines" : "markers",
                            type: "scatter",
                            name: y[i]
                           });
                }
                var layout = { 
                                font:       {size: 12},
                                margin: { t:20, l:80, r:80, b:80 },
                                xaxis: { title: x },
                                yaxis: { title: y[0], autorange: y[0].includes('depth') ? 'reversed' : true },
                                title: { text: mode == 1 ? `Dive ${currDive} ${y[0]}` : '', y:0.95, x:0.5},
                                plot_bgcolor: "#cccccc",
                                paper_bgcolor: "#bbbbbb",
                             };
                var config = { responsive: true };
                Plotly.newPlot($('plotlyPlotDiv'), d, layout, config);
            }
            else if (which == 'plot') {
                var d = [];
                var xd = mode == 0 ? data.map(v => v[x]) : data[x];
                var xd2 = mode == 0 ? data.map(v => v[x2]) : data[x2];
                for (var i = 0 ; i < y.length ; i++) {
                    var yd = mode == 0 ? data.map(v => v[y[i]]) : data[y[i]];
                    d.push({
                            x: xd,
                            y: xd2,
                            mode: "markers",
                            type: "scatter",
                            name: y[i],
                            marker: {
                                color: yd,
                                colorbar: {
                                    title: y[i],
                                    len: 0.8,
                                },
                                colorscale: "Jet", 
                            }
                           });
                }
                var layout = { 
                                font:       {size: 12},
                                margin: { t:20, l:80, r:80, b:80 },
                                xaxis: { title: x },
                                yaxis: { title: x2, autorange: x2.includes('depth') ? 'reversed' : true },
                                plot_bgcolor: "#cccccc",
                                paper_bgcolor: "#bbbbbb",
                             };
                var config = { responsive: true };
                Plotly.newPlot($('plotlyPlotDiv'), d, layout, config);
            }
            else if (which == 'table') {
                var values = [];
                var headers = [];
                values.push(mode == 0 ? data.map(v => v[x]) : data[x]);
                headers.push([x]);
                for (var i = 0 ; i < y.length ; i++) {
                    values.push(mode == 0 ? data.map(v => v[y[i]]) : data[y[i]]);
                    headers.push([y[i]]);
                }

                var d = [{
                    type: 'table',
                    header: {
                        values: headers,
                        align: 'center',
                        line: { width: 1, color: 'black' },
                        fill: { color: "#aaaaaa" },
                        font: {family: "Arial", size: 12, color: "white"}

                    },
                    cells: {
                        values: values,
                        align: "center",
                        fill: { color: "#eeeeee" } ,
                        line: {color: "#cccccc", width: 1},
                        font: {family: "Arial", size: 11, color: ["black"]}
                    },
                }];
                Plotly.newPlot($('plotlyPlotDiv'), d);
            }
            else if (which == 'csv') {
                var d = [];
                if (x2 == '-')
                    d.push(([x].concat(y)).join(',')); // headers
                else 
                    d.push(([x,x2].concat(y)).join(',')); // headers

                console.log(d); 
                var o = []; 
                o.push(mode == 0 ? data.map(v => v[x]) : data[x]);
                if (x2 != '-') 
                    o.push(mode == 0 ? data.map(v => v[x2]) : data[x2]);

                for (var i = 0 ; i < y.length ; i++)
                    o.push(mode == 0 ? data.map(v => v[y[i]]) : data[y[i]]);

                output = o[0].map((_, colIndex) => o.map(row => row[colIndex]).join(','));
                console.log(output);

                const blob = new Blob([d.concat(output).join('\n')], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.setAttribute('href', url);
                a.setAttribute('download', y[0] + '.csv'); 
                a.click();
            }
        })
        .catch(error => {
            console.log('plotly ' + error);
        })
    }

    function emptySelect(s) {
        while(s.options.length > 0)
            s.remove(0);
    }

    function loadPlotlyControlsContour(glider) {
        fetch(`/provars/${glider}${mission()}`)
        .then(res => res.json())
        .then(data => {
            names = data['names'].sort();

            emptySelect($('selPlotlyContour'));
            for (n of names) {
                let optX = document.createElement('option');
                optX.value = n;
                optX.innerHTML = n;
                let optY = document.createElement('option');
                $('selPlotlyContour').appendChild(optX);
            }
        })
        .catch(error => {
            console.log('provars ' + error);
        });

    }

    function loadPlotlyControlsXY(glider) {
        fetch(`/dbvars/${glider}${mission()}`)
        .then(res => res.json())
        .then(data => {
            names = data['names'].sort();
            dv = names.indexOf('dive');
            names.splice(names.indexOf('dive'), 1);
            names = ['dive'].concat(names);

            emptySelect($('selPlotlyX'));
            emptySelect($('selPlotlyX2'));
            emptySelect($('selPlotlyY'));

            let noOpt = document.createElement('option');
            noOpt.value = '-';
            noOpt.innerHTML = '-';
            $('selPlotlyX2').appendChild(noOpt);

            for (n of names) {
                let optX = document.createElement('option');
                optX.value = n;
                optX.innerHTML = n;
                let optX2 = document.createElement('option');
                optX2.value = n;
                optX2.innerHTML = n;
                let optY = document.createElement('option');
                optY.value = n;
                optY.innerHTML = n;
 
                $('selPlotlyX').appendChild(optX);
                $('selPlotlyX2').appendChild(optX2);
                $('selPlotlyY').appendChild(optY);
            }
        })
        .catch(error => {
            console.log('dbvars ' + error);
        });

    }

    function loadPlotlyControlsTS(glider, dive) {
        fetch(`/timevars/${glider}/${dive}/${mission()}`)
        .then(res => res.json())
        .then(data => {
            var names = data.map(v => v['var']).sort();
            dv = names.indexOf('time');
            names.splice(names.indexOf('time'), 1);
            names = ['time'].concat(names);

            emptySelect($('selPlotlyX'));
            emptySelect($('selPlotlyX2'));
            emptySelect($('selPlotlyY'));

            let noOpt = document.createElement('option');
            noOpt.value = '-';
            noOpt.innerHTML = '-';
            $('selPlotlyX2').appendChild(noOpt);

            for (n of names) {
                let optX = document.createElement('option');
                optX.value = n;
                optX.innerHTML = n;
                let optX2 = document.createElement('option');
                optX2.value = n;
                optX2.innerHTML = n;
                let optY = document.createElement('option');
                optY.value = n;
                optY.innerHTML = n;
 
                $('selPlotlyX').appendChild(optX);
                $('selPlotlyX2').appendChild(optX2);
                $('selPlotlyY').appendChild(optY);
            }
        })
        .catch(error => {
            console.log('timevars ' + error);
        });

    }

    function switchControls(id) {
        if (id == 'chkTimeseriesPlots' && $(id).checked) {
            $('chkMissionPlots').checked = false;
            console.log('unchecking mission');
            loadPlotlyControlsTS(currGlider, currDive);
        }
        else if (id == 'chkMissionPlots' && $(id).checked) {
            $('chkTimeseriesPlots').checked = false;
            console.log('unchecking ts');
            loadPlotlyControlsXY(currGlider);
        }

        if ($('chkMissionPlots').checked == false 
              && $('chkTimeseriesPlots').checked == false) {
            $(id).checked =true;
        } 
    }
 
    function init() {
        let path = window.location.pathname.substring(1).split('/');
        let glider = -1;
        let dive = -1;

        if (path.length >= 1) {
            glider = path[0];
            console.log(glider);
        }

        let params = new URLSearchParams(window.location.search);
        if (params.has('dive')) {
            dive = parseInt(params.get('dive'));
        }
        if (params.has('mission')) {
            currMission = params.get('mission');
        }
        if (params.has('order')) {
            createCookie("order", params.get('order'), 180);
        }
        

        if (glider == -1) {
            alert('invalid request - specify glider');
            console.log('invalid request - specify glider');
            return;
        }

        if (path.length > 1) {
            window.history.replaceState('object or string', 'Title', `/${glider}`);
        }

        currGlider = glider;
        console.log(glider);
        window.name = glider;
        loadStatus(glider, dive);
        setupStream(glider, true);
{% if runMode == 'pilot' %}
        loadControlFile('cmdfile');
        loadControlFile('science');
        loadControlFile('targets');
        loadControlFile('scicon.sch');
        loadControlFile('tcm2mat.cal');
        loadControlFile('pdoscmds.bat');
        loadControlFile('sg_calib_constants.m');
{% endif %}
        loadPlotlyControlsXY(glider);
        loadPlotlyControlsContour(glider);
        $('chkMissionPlots').checked = true;
        $('chkTimeseriesPlots').checked = false;

        document.onkeydown = function (event) {
            const excl = ['input', 'textarea'];
            if (excl.includes(event.target.tagName.toLowerCase()))
                return;

            console.log(event);
            console.log(event.target);
            var idx;
            const key = event.key;
            if (key == 'a' || key == 'h') {
                idx = plotList.indexOf(currElt);
                if (idx > 0) {
                    idx --;
                    $('thumb' + plotList[idx]).click();
                }
            }
            else if (key == 'd' || key == 'l') {
                idx = plotList.indexOf(currElt);
                if (idx < (plotList.length - 1)) {
                    idx ++;
                    $('thumb' + plotList[idx]).click();
                }
            }
            else if (key == 'w' || key == 'k')
                changeDive(1);
            else if (key == 's' || key == 'j')
                changeDive(-1);
            else if ("123456789".includes(key) && parseInt(key) <= numPages) {
                jumpScroll((parseInt(key) - 1)*5);
            }

        };
        $('bottom').addEventListener("wheel", (evt) => {
            evt.preventDefault();
            $('bottom').scrollLeft += evt.deltaY;
        });
    }


</script>

<html>
<body onload="init();" style="font-family: verdana, arial, tahoma, 'sans serif'; font-size: 12px;">

 <a href="/">Index</a> <b>&#124;</b> <a href="/dash"> Dashboard </a> <b>&#124;</b> <span class="spanClick" onclick="openAboutForm(); return false;">About</span>

<div style="position: relative;">

<div id="toolbar" style="position:absolute; left:0 top:0; width:50px; height:894px;">
<div style="position:relative; width:50px; height:894px;">
    <button class="tool" style="background: url(/script/images/up-icon.png);" onclick="changeDive(1);" title="next dive [w,k] "></button>
    <button class="tool" style="background: url(/script/images/table-icon.png);" onclick="showTable();" title="dives table"></button>
    <button class="tool" style="background: url(/script/images/down-icon.png);" onclick="changeDive(-1);" title="prev dive [s,j]"></button>
    <button class="tool" style="background: url(/script/images/log-table-icon.png);" onclick="showLog();" title="log summary"></button>
    <button class="tool" style="background: url(/script/images/log-icon.png);" onclick="showLogFile();" title="log file"></button>
    <button class="tool" style="background: url(/script/images/chart-icon.png);" onclick="showPlotly();" title="plot and table tool"></button>
    <button class="tool" id="btnNotifications" style="background: url(/script/images/notification-icon.png);" onclick="showNotifications();" title="notifications"></button>
    <button class="tool" id="btnCapFile" style="background: url(/script/images/cap-none-icon.png);" onclick="showCap();" title="notifications"></button>
    <button class="tool" id="btnEngFile" style="background: url(/script/images/eng-icon.png);" onclick="showEng();" title="notifications"></button>

    <button class="tool" style="background: url(/script/images/globe-icon.png); position:absolute; bottom:50px; left:0" onclick="popupMap();" title="map"></button>
    <button class="tool" style="background: url(/script/images/selftest-icon.png); position:absolute; bottom:0; left:0;" onclick="popupSelftest();" title="selftest"></button>
</div>
</div>

<div id="main" style="position: absolute; left: 50; top: 0; width:1050px; height:894px; overflow:auto; background-color:#bbbbbb; text-align:center;" >
    <img id="mainImage" style="mix-blend-mode:multiply; max-height:894px; max-width:1050px; text-align:center;">
    <table rules="groups" id="mainTable" hidden="hidden" style="height:894px; width:1000px; font-size:14px; text-align:right; font-family:verdana, arial, tahoma, 'sans serif';"> 

        <colgroup span=4><col><col><col><col></colgroup>
        <colgroup span=6><col><col><col><col><col><col><col></colgroup>
        <colgroup span=2><col><col></colgroup>
        <colgroup span=2><col><col></colgroup>
        <colgroup span=2 id="volt10_group"><col class="volt10"><col class="volt10"></colgroup>
        <colgroup span=2 id="volt24_group"><col class="volt24"><col class="volt24"></colgroup>
        <colgroup span=1><col></colgroup>
        <tbody style="height:894px; width:1040px; overflow-y:auto;"> <!-- display:block"> -->
            <tr bgcolor="#aaaaaa" align="center">
                <th>dive</th>
                <th>end</th>
                <th>length</th>
                <th>depth</th>
                <th>dog</th>
                <th>cog</th>
                <th>dtw</th>
                <th>ctw</th>
                <th>dtg</th>
                <th>ctg</th>
                <th>OG eff.</th>
                <th>Umag</th>
                <th>Udir</th>
                <th>RH</th>
                <th>int P</th>
                <th id="volt10_header" class="volt10">volts10</th>
                <th id="cap10_header" class="volt10">% cap</th>
                <th id="volt24_header" class="volt24">volts24</th>
                <th id="cap24_header" class="volt24">% cap</th>
                <th>errors</th>
            </tr>
        </tbody>
    </table>

    <div id="logDiv" hidden="hidden"></div>
    <div id="notificationsDiv" hidden="hidden" style="margin-left:20px; text-align:left;"></div>
    
    
    <div id="plotlyDiv" hidden="hidden">
        <div id="plotyConfigDiv" style="display:flex;">
            <div style="float:left;">
                <span style="vertical-align:top;">X:</span><select id="selPlotlyX" style="vertical-align:top; width:240px;"></select> <br>
                <span style="vertical-align:top;">Y:</span><select id="selPlotlyX2" style="vertical-align:top; width:240px;"></select> <br>
                <input type="checkbox" checked id="chkMissionPlots" style="vertical-align:top;" onclick="switchControls(this.id);"><span style="vertical-align:top;">whole mission</span>
                <input type="checkbox" id="chkTimeseriesPlots" style="vertical-align:top;" onclick="switchControls(this.id);"><span style="vertical-align:top;">dive time series</span><br>
            </div>
            <span style="vertical-align:top; margin-left:8px;" >Z:</span><select id="selPlotlyY" multiple size="4" style="width:300px;"> </select>
            <div style="margin-left:8px;">
                <button id="btnPlotlyPlot" style="vertical-align:top;" onclick="doPlotlyPlot('plot');">plot</button>
                <button id="btnPlotlyTable" style="vertical-align:top;" onclick="doPlotlyPlot('table');">table</button><br>
                <button id="btnPlotlyCSV" style="vertical-align:top;" onclick="doPlotlyPlot('csv');">export</button>
            </div>
            <div style="margin-left:40px;"> <!-- style="float:right;"> -->
                <span style="vertical-align:top;">value:<select id="selPlotlyContour" style="vertical-align:top;"> </select></span><br>
                <div style="vertical-align:top; margin-top:4px; margin-bottom:4px;">
                    profile stride
                    <select style="vertical-align:top;" id="selPlotlyProfileStride">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5" selected>5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    bin stride
                    <select style="vertical-align:top;" id="selPlotlyZStride">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5" selected>5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                    <input type="checkbox" checked id="chkFillGaps" style="vertical-align:top;"><span style="vertical-align:top;">fill gaps</span><br>
                </div>
                <button id="btnPlotlyContour" style="vertical-align:top;" onclick="doPlotlyProfiles('contour');">contour</button>
                <button id="btnPlotlyProfiles" style="vertical-align:top;" onclick="doPlotlyProfiles('profiles');">profiles</button>
            </div>
        </div>
        <div id="plotlyPlotDiv" style="height:90%; width:100%; position:absolute; bottom:0;">
        </div>
    </div>

    <div id="logfileDiv" hidden="hidden" ondblclick="parameterHelp('logfile');" title="double click parameter for help" style="background-color:#dddddd; text-align:left;" >
    </div>

    <div id="engfileDiv" hidden="hidden" style="background-color:#dddddd; text-align:left;">
    </div>

    <div id="capfileDiv" hidden="hidden" style="background-color:#dddddd; text-align:left;">
    </div>
</div>

{% if runMode == 'pilot' %}

<div id="commlog" style="position: absolute; left:1110; top:0; width:600; height:450; overflow:auto; font-size: 10px; box-sizing:border-box; border:1px solid black; white-space:pre;background-color:#bbbbbb;">

</div>

<div id="status" style="position: absolute; left:1110; top:460px; width:600px; height:240px; overflow:auto; font-size: 10px; box-sizing:border-box; border:1px solid black; background-color:#bbbbbb;">
    <div id="position" style="font-weight: bold; font-size: 42px; padding-left: 2vmin; padding-top: 1px; padding-bottom: 1px">
    </div>
    <div id="positionTime" style="font-weight: bold; font-size: 20px; padding-left: 2vmin; padding-top: 1px; padding-bottom: 2px">
    </div>
    <table style="table-layout:fixed; width: 590px;">
        <col style="width:60px;">
        <col style="width:130px;">
        <col style="width:60px;">
        <col style="width:130px;">
        <col style="width:60px;">
        <col style="width:130px;">
        <tr>
            <td>SOG</td><td id="SOG"></td>
            <td>COG</td><td id="COG"></td>
            <td>last fix</td><td id="lastFix"></td>
        </tr>
        <tr>
            <td>DOG</td><td id="DOG"></td>
            <td>&Delta;t</td><td id="dt"></td>
            <td>last call</td><td id="lastConnect"></td>
        </tr>
        <tr>
            <td>pitch</td><td id="pitch"></td>
            <td>volts</td><td id="volts"></td>
        </tr>
        <tr>
            <td>depth</td><td id="depth"></td>
            <td>dive</td><td id="dive"></td>
        </tr>
        <tr>
            <td>RH</td><td id="RH"></td>
            <td>cycle</td><td id="cycle"></td>
        </tr>
        <tr>
            <td>int P</td><td id="intP"></td>
            <td>call</td><td id="call"></td>
        </tr>
    </table>
</div>

<div id="divCmdfile" style="position: absolute; left:1110; top:710; width:600px; height:380px; font-size: 12px;">
    <textarea id="cmdfile" class="editFile" ondblclick="parameterHelp('cmdfile');">
    </textarea>
    <textarea id="targets" class="editFile" hidden="hidden"></textarea>
    <textarea id="science" class="editFile" hidden="hidden"></textarea>
    <textarea id="scicon.sch" class="editFile" hidden="hidden"></textarea>
    <textarea id="pdoscmds.bat" class="editFile" hidden="hidden"></textarea>
    <textarea id="tcm2mat.cal" class="editFile" hidden="hidden"></textarea>
    <textarea id="sg_calib_constants.m" class="editFile" hidden="hidden"></textarea>
    <button id="btnSave" type="button" onclick="saveControl(0);" style="margin-left:2px;">Save</button>
    <button id="btnForce" type="button" onclick="saveControl(1);">Force</button>
    <button id="btnGO" type="button" onclick="changeDirective('GO');" style="background-color:#00aa00;">GO</button>
    <button id="btnQUIT" type="button" onclick="changeDirective('QUIT');" style="background-color:#ff0020;">QUIT</button>
    <button id="btnRESUME" type="button" onclick="changeDirective('RESUME');" style="background-color:yellow;">RESUME</button>
    <select id="selectFile" onchange="changeFile()">
        <option value="cmdfile" selected>cmdfile</option>
        <option value="targets">targets</option>
        <option value="science">science</option>
        <option value="scicon.sch">scicon.sch</option>
        <option value="pdoscmds.bat">pdoscmds.bat</option>
        <option value="tcm2mat.cal">tcm2mat.cal</option>
        <option value="sg_calib_constants.m">sg_calib_constants.m</option>
    </select>
    <span id="fileDive" hidden="hidden"></span>
</div>

{% endif %}

<div id="bottomBox" style="position: absolute; left: 0; top: 900; width: 1100; height: 205; overflow: hidden" title="a or h to move left, f or l to move right, number key 1-8 to jump to section, scroll wheel scrolls">
    <div id="bottomLinks" style="position: absolute; left: 10; top: 0; width: 978; height: 20; overflow: hidden;">

    </div>
    <div id="bottom" style="position: absolute; left: 0; top: 20; width: 1100; height: 185; overflow: auto; background-color:#bbbbbb;">

    </div>
</div>

</div> 

{% include "dialogs.html" %}

</body>


</html>
