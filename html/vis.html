<meta name="viewport" content="width=device-width, initial-scale=1.0"/> 

<link rel="stylesheet" href="script/dialogs.css" />
{% if runMode == 'pilot' %}
{% if noChat == false %}
<link rel="stylesheet" href="script/chat.css" />
{% endif %}
<link rel="manifest" href="manifest.json">
{% endif %}

<link rel="stylesheet" href="script/base.css" />
<link rel="stylesheet" href="script/plottool.css" />

<script src="script/plotly-latest.min.js"></script>
<script src="script/util.js"></script>
<script src="script/dialogs.js"></script>
<script src="script/websocket.js"></script>
<script src="script/tabstats.js"></script>

{% if runMode == 'pilot' %}
<script src="script/chat.js"></script>
{% endif %}
<style>
    .hide {
        display: none !important;
    }
</style>

<script>

    var mobile = false;

    var blurTimer  = false;
    var isBlurred  = false;
    var isFlashing =false;
    var currTitle  = "";

    var currGlider = '';
    var currMission = '';
    var currStatus = '';

    var engplots = [];
    var engplotlyplots = [];
    var sgplots = [];
    var sgplotlyplots = [];

    var startX = null;
    var startY = null;
    var startZ = null;
    var startOp = null;
    var lastDive = null;

    var permalink = null;

    var divesInTable = [];

{% if runMode == 'pilot' %}
    var fixes = [];
    var connect_t = 0;

    var fixTimer = null;
{% endif %}

    function showPermalink() {
        var link;
        let params = new URLSearchParams(window.location.search);
        let path = window.location.href.split('?')[0];
        if (params && params.has('mission'))
            link = path + '?mission=' + params.get('mission') + '&' + permalink;
        else
            link = path + '?' + permalink;

        alert(link);
    }

    function startFlash() {
        isFlashing = true;
        blurTimer = window.setInterval(function() 
            {
                document.title = document.title == currTitle ? currTitle + "..." : currTitle;
            }, 1000);
    }
 
    window.onblur=function() {
        isBlurred = true;
    }

    window.onfocus=function() { 
        isBlurred = false;
        isFlashing = false;
        document.title = currTitle;
        if (blurTimer) {
            clearInterval(blurTimer);
        }
        blurTimer = false;
    }

    function mission() {
        if (currMission != '')
            return `?mission=${currMission}`;
        else
            return '';
    }

{% if runMode == 'pilot' %}
    function updateTimer() {
        if (fixes.length > 0) {
            $('lastFix').innerHTML = '' + (Date.now()/1000 - fixes.at(-1).t).toFixed(0) + 's';
        }
        if (connect_t > 0) {
            $('lastConnect').innerHTML = '' + (Date.now()/1000 - connect_t).toFixed(0) + 's';
        }
        fixTimer = setTimeout('updateTimer()', 1000);
    }
{% endif %}

    let wsocket  = null;
    var first = true;

    function setupStream(glider, first, history) {
        console.log('setting up stream');
        var loc = window.location, new_uri;
        if (loc.protocol === "https:")
            new_uri = "wss:";
        else
            new_uri = "ws:";

        let which = 'restart';
        if (first)
            which = 'init';
        else if (history)
            which = 'history';
        
{% if runMode == 'pilot' %}
{% if noChat == false %}
        if (first || history) {
            $('chatContent').innerHTML = '';
        }
{% endif %}
{% endif %}

        path = loc.pathname.split('/').slice(0,-1).join('/');
        new_uri += "//" + loc.host + path;
        new_uri += "/stream/" + which + "/" + glider + mission();
        console.log(new_uri);
        wsocket = new ReconnectingWebSocket(new_uri);
        wsocket.timeoutInterval = 10000;
        wsocket.debug = true;

        wsocket.onopen = function() {
            wsocket.url = wsocket.url.replace('init', 'restart');
        }

        wsocket.onerror = function(error) {
            console.log('stream error detected');
        };

        wsocket.onclose = function(e) {
            if (e.wasClean) {
                console.log('stream closed cleanly');
            }
            else {
                console.log('connection died');
            }
        };

        var lastChat_t = 0;

        wsocket.onmessage = function(e) { 
            var pieces, content, data, i;
            var vals = {};
            var update;
            var newDive;
            var newCmdfile;
            var d, pieces, lines;
            var pt, fix;
            var h;
            var styles = ["font-weight:bold;", "font-weight:bold; color:red;", "font-weight:bold; color:green;"]
            var bolds = {"targets":0, "science":0, "cmdfile":0, "pdoscmds.bat":0, "Connected":0, "QUIT":1, "RECOV_CODE":1, "GO":2};

            var line = e.data;
            console.log(line);
            if (line.startsWith('START')) {
                console.log('got START ping');
            }
{% if runMode == 'pilot' %}
            else if (line.startsWith('CHAT=')) {
                msgs = JSON.parse(line.slice(5));
                for (m of msgs) {
                    chatLoadMessage(glider, m);
                }                 
            }
{% endif %}
            else if (line.startsWith('NEW=')) {
                json = JSON.parse(line.slice(4));
                glider = json['glider'];
                if ('content' in json && json['content'] == 'files=all' && 
                     (json['when'] == 'socket' || json['when'] == 'sync') ) {
                    newDive = json['dive'];
                    if (newDive > maxDive) {
                        maxDive = newDive;
                        updateMaxDive();
                        loadPlots(newDive, true);
                        buildTable(currGlider, newDive);
                        buildChangelog(3);
                    }
                }
                else if ('lat' in json) {
                    if (!first) beep();
                    
                    connect_t = json['connected'];
                    if (fixTimer == null) {
                        updateTimer();

                    }

                    if (fixes.length == 0 || fixes.at(-1).t < json['epoch']) {
                        console.log('pushing fix at ' + json['epoch']);
                        fixes.push(positionFix(json['lat'], json['lon'], json['epoch']));
                    } 
                    if (fixTimer == null) {
                        updateTimer();
                    }
                    if (fixes.length >= 2) {
                        var sog, cog, dog, dt;
                        dt = fixes.at(-1).t - fixes.at(-2).t;
                        dog = haversine(fixes.at(-1).pt, fixes.at(-2).pt);
                        cog = bearing(fixes.at(-2).pt, fixes.at(-1).pt);
                        sog = dog/dt/0.514;
                        $('SOG').innerHTML = sog.toFixed(2) + 'kts';
                        $('COG').innerHTML = cog.toFixed(1) + '&deg;';
                        $('DOG').innerHTML = dog.toFixed(0) + 'm';
                        $('dt').innerHTML = dt.toFixed(0) + 's';
                    }
                    else {
                        $('SOG').innerHTML = '0';
                        $('COG').innerHTML = '0';
                        $('DOG').innerHTML = '0';
                        $('dt').innerHTML = '0';
                    }

                    $('position').innerHTML = formatPos(dd2ddmm(json['lat'])) + ',' + formatPos(dd2ddmm(json['lon']));
                    $('positionTime').innerHTML = '@ ' + new Date(json['epoch']*1000).toISOString().replace('T', ' ').slice(0,-8);

                    $('RH').innerHTML = json['RH'].toFixed(2);
                    $('intP').innerHTML = json['intP'].toFixed(2);
                    $('volts').innerHTML = json['volts24'].toFixed(2);
                    $('pitch').innerHTML = json['pitch'].toFixed(1);
                    $('depth').innerHTML = json['depth'].toFixed(1);
                    $('dive').innerHTML = json['dive'];
                    $('cycle').innerHTML = json['cycle'];
                    $('call').innerHTML = json['call'];
                }
                else {
                    // loadStatus(currGlider, -1);
                    console.log('untreated NEW=' + line);
                }
                // loadLog(newDive);
                first = false;
            }
{% if runMode == 'pilot' %}
            else if (line.startsWith('FILE=')) {
                json = JSON.parse(line.slice(5));
                $(json['file']).value = json['body'];
            }
            else { // new comm.log content comes unprefixed
                var elt = $('commlog');
                for (b of Object.keys(bolds)) {
                    line = line.replaceAll(b, '<span style="' + styles[bolds[b]] + '">' + b + '</span>');
                } 

                elt.innerHTML += line;
                elt.scrollTop = elt.scrollHeight;
            }

{% else %}
            else if (line.startsWith('CMDFILE=')) {
                newDirective = line.split('=')[1];
            }
{% endif %}
            if (isBlurred && !isFlashing) {
                startFlash();
            }
        };
    }

    var currDive = -1;
    var maxDive = 10000; 
    var currElt = 'diveplot';
    var controlFileDive = {};

    var numPages = 0;

    function updateMaxDive() {
        var v2 = $('txtPlotlyLastDive').value;

        if (lastDive) {
            $('txtPlotlyLastDive').value = lastDive;
            lastDive = null;
        }
        else {
            $('txtPlotlyLastDive').value = maxDive;
        }
    }

{% if runMode == 'pilot' %}
{% if noSave == false %}
    function saveControl(force) {
        var json = {};
        var file = $('selectFile').value;

        json['force'] = force;
        json['file'] = file;
        json['contents'] = $(file).value; 

        fetch(`save/${currGlider}/${file}${mission()}`, 
        {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(json),
        })
        .then(res => res.text())
        .then(text => {
            if (text.includes("authorization failed")) {
                openLoginForm(function() { saveControl(force); });
                return;
            }
            alert(text);
        })
        .catch(error => {
            alert(error);
        });
    }

    function changeDirective(cmd) {
        var newCmd = '$' + cmd;
        console.log(newCmd + ' ' + cmd);
        $('cmdfile').value = $('cmdfile').value.replace('$GO', newCmd);
        $('cmdfile').value = $('cmdfile').value.replace('$QUIT', newCmd);
        $('cmdfile').value = $('cmdfile').value.replace('$RESUME', newCmd);
        $('cmdfile').value = $('cmdfile').value.replace('$EXIT_TO_MENU', newCmd);

        return false;
    }
{% endif %}

    function loadControlFile(file) {
        fetch(`control/${currGlider}/${file}${mission()}`)
        .then(res => res.text())
        .then(text => {
            if (text == 'none')
                return;

            try {
                data = JSON.parse(text);
            } catch (error) {
                console.log(file + ' ' + text + ' ' + error);
                return;
            }

            if ('file' in data && data['file'] == file) {
                $(file).value = data['contents'];
            }
            if ('dive' in data && data['dive'] > -1) {
                controlFileDive[file] = data['dive'];
            }
        })
        .catch(error => {
            console.log(`${file}-${error}`);
        })
    }

    const knownFiles = ["cmdfile", "targets", "science", "scicon.sch", "pdoscmds.bat", "tcm2mat.cal", "sg_calib_constants.m"];
    const cmdfileButtons = ['btnGO', 'btnQUIT', 'btnRESUME'];
    function changeFile() {
        var file = $('selectFile').value;
        for (var f of knownFiles) {
            if (f == file)
                $(f).removeAttribute('hidden');
            else
                $(f).setAttribute('hidden', '');
        }

        for (var b of cmdfileButtons) {
            if (file != "cmdfile") 
                $(b).setAttribute('hidden', '');
            else 
                $(b).removeAttribute('hidden');
        }

        if (file in controlFileDive) {
            $('fileDive').innerHTML = '(' + controlFileDive[file] + ')';
            $('fileDive').removeAttribute('hidden');
        }
        else {
            $('fileDive').setAttribute('hidden', '');
            $('fileDive').innerHTML = '';
        }
    }
{% endif %}

    function popupImage(ext, which, dive, elt) {
        var m = mission();
        if (m == '')
            m = '?wrap=page';
        else
            m = m + '&wrap=page';

        window.open('plot/' + ext + '/' + which + '/' + currGlider + '/' + dive + '/' + elt + m, `${currGlider}-${dive}-${elt}`);
    }

    function popupSelftest() {
        window.open('selftest/' + currGlider + mission(), currGlider + '-selftest');
    }

    function popupMap() {
        window.open('map/' + currGlider + mission(), currGlider + '-map');
    }

    function popupPosition() {
        window.open('pos/' + currGlider + mission(), currGlider + '-position');
    }

    function gliderIndex() {
        window.open('./?gliders=' + currGlider);
    }

    function openBallastSheet() {
        var opts = ['limit=1'];
        if (mission() != '')
            opts.push(mission()) 

        var q = `query/${currGlider}/dive,log_MASS,log_RHO,log_VBD_MIN,log_VBD_MAX,log_MAX_BUOY,log_C_VBD,log_VBD_CNV${formatQuery(opts)}`

        fetch(q)
        .then(res => res.text())
        .then(text => {
            try {
                data = JSON.parse(text);
                let volmax = data['log_MASS']/data['log_RHO'] + (data['log_VBD_MIN'] - data['log_C_VBD'])*data['log_VBD_CNV'];
                window.open(`ballast?mass=${data['log_MASS']}&volmax=${volmax}&density=${data['log_RHO']}&thrust=${-data['log_MAX_BUOY']}&min=${data['log_VBD_MIN']}&max=${data['log_VBD_MAX']}`, currGlider + '-ballast');
            } catch (error) {
                console.log('openBallastSheet ' + error);
            }
        });
    }

    function missionIndex() {
        if (!currMission || currMission == '')
            return;

        if (currStatus == 'active')
            window.open('dash?mission=' + currMission);
        else
            window.open('./?mission=' + currMission);
    }

    function setVisibility(elt) {
        const divs = ['mainImage', 'mainDiv', 'mainTable', 'logDiv', 'plotlyDiv', 'logfileDiv', 'notificationsDiv', 'changelogDiv', 'engfileDiv', 'capfileDiv'];
        for (var d of divs) {
            if (d != elt) $(d).classList.add('hide');
        }
        $(elt).classList.remove('hide');
        $('plotlyPopperOuter').style.display = 'none';
        $('plotlyPermalink').style.display = 'none';
        $('diveIndicator').style.display = 'none';
    }


    function showPlot(which, elt, plotly) {
        console.log('showing ' + elt);
        console.log('plotly available ' + plotly)
        if (!plotly || mobile) {
            setVisibility('mainImage');
            $('mainImage').src = `plot/webp/${which}/${currGlider}/${currDive}/${elt}${mission()}`;
            $('plotlyPopperOuter').style.display = 'block';
            $('diveIndicator').style.display = 'block';
            console.log('popper up');
            if (plotly)
                $('plotlyPopperOuter').onclick = function() 
                    { 
                        popupImage('div', which, currDive, elt); 
                        return false; 
                    } 
            else
                $('plotlyPopperOuter').onclick = function() 
                    { 
                        popupImage('webp', which, currDive, elt); 
                        return false; 
                    } 
        }
        else {
            setVisibility('mainDiv');
            $('diveIndicator').style.display = 'block';
            $('plotlyPopperOuter').style.display = 'block';
            console.log('popper up');

            fetch(`plot/div/${which}/${currGlider}/${currDive}/${elt}${mission()}`)
            .then(res => res.text())
            .then(data => {
                setInnerHTML($('mainDiv'), data);
                $('plotlyPopperOuter').onclick = function() 
                    { 
                        popupImage('div', which, currDive, elt); 
                        return false; 
                    } 
            })
            .catch(error => {
                console.log('show plot error'); // error);
            });
        }
        currElt = elt;
        console.log(currElt);
    }

    function addTableRow(d) 
    {
        var row, cell, text;
        var tbody = $('mainTable').getElementsByTagName('tbody')[0];
        const colors = ["#cccccc", "#eeeeee"];
        var i, c;
        var date;
        var course; 
        var dist;
        var n, e;
        var rowID = 'row' + d['dive'];

        if ($(rowID) != null) {
            console.log('row exists ' + rowID);
            $(rowID).remove();
        }
   
        divesInTable.push(d['dive']);
 
        for (const key in d) {
            if (d[key] == null)
                d[key] = 0;
        }
 
        row = tbody.insertRow(1);
        row.id = rowID;
        
        i = $('mainTable').rows.length % 2;
        row.style.backgroundColor = colors[i];
        cell = row.insertCell(0);
       
        if ('criticals' in d &&  d['criticals'] > 0)
            color = 'red';
        else
            color = 'black';

        alerts  = 'alerts'  in d && d['alerts']  > 0 ? '<b title="alerts">a</b>' : '';
        capture = 'capture' in d && d['capture'] > 0 ? `<b title="capture file" style="color:${color}">c</b>` : '';
        changes = 'changes' in d && d['changes'] > 0 ? '<b title="parameter changes">p</b>' : '';
        files   = 'files' in d && d['files'] > 0 ? '<b title="control files">f</b>' : '';
 
        cell.innerHTML = '<a href="#" onclick="loadPlots(' + d['dive'] + ', false);">' + d['dive'] + '</a>' + changes + files + alerts + capture;
        cell.style.textAlign = 'left';
        // cell.appendChild(text);

        // date = new Date(1000*(d['log_start'] + d['total_flight_time_s']));
        date = new Date(1000*(d['log_gps_time']));
        cell = row.insertCell(1); 
        text = document.createTextNode((date.getFullYear() - 2000) + '/' +
                                       (date.getMonth() + 1).zeroPad() + '/' + 
                                       date.getDate().zeroPad() + ' ' + 
                                       date.getHours().zeroPad() + ':' + 
                                       date.getMinutes().zeroPad());
        cell.appendChild(text);

        cell = row.insertCell(2); 
        text = document.createTextNode('' + ((d['log_gps_time'] - d['log_start'])/60).toFixed(0));
        cell.appendChild(text);

        cell = row.insertCell(3);
        text = document.createTextNode('' + d['max_depth'].toFixed(0) + '(' + d['log_D_TGT'] + ')');
        cell.appendChild(text);

        dist = Math.sqrt(d['GPS_north_displacement_m']*d['GPS_north_displacement_m'] 
                         + d['GPS_east_displacement_m']*d['GPS_east_displacement_m']);
        course = Math.atan2(d['GPS_east_displacement_m'], d['GPS_north_displacement_m'])*180.0/Math.PI;
        if (course < 0) {
            course = course + 360;
        }
        cell = row.insertCell(4);
        text = document.createTextNode('' + (dist/1000).toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(5);
        text = document.createTextNode('' + course.toFixed(1));
        cell.appendChild(text);

        n = d['flight_avg_speed_north'] * d['time_seconds_diving'];
        e = d['flight_avg_speed_east'] * d['time_seconds_diving'];
        dist = Math.sqrt(n*n + e*e);
        course = Math.atan2(e, n)*180.0/Math.PI;
        if (course < 0) {
            course = course + 360;
        }
        cell = row.insertCell(6);
        text = document.createTextNode('' + (dist/1000).toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(7);
        text = document.createTextNode('' + course.toFixed(1));
        cell.appendChild(text);

        cell = row.insertCell(8);
        text = document.createTextNode('' + (d['meters_to_target']/1000).toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(9);
        text = document.createTextNode('' + (d['mag_heading_to_target'] + d['magnetic_variation']).toFixed(1));
        cell.appendChild(text);

        cell = row.insertCell(10);
        text = document.createTextNode('' + d['dog_efficiency'].toFixed(2));
        cell.appendChild(text);

        
        dist = Math.sqrt(d['depth_avg_curr_east']*d['depth_avg_curr_east'] 
                         + d['depth_avg_curr_north']*d['depth_avg_curr_north']);
        course = Math.atan2(d['depth_avg_curr_east'], d['depth_avg_curr_north'])*180.0/Math.PI;
        if (course < 0) {
            course = course + 360;
        }

        cell = row.insertCell(11);
        text = document.createTextNode('' + (dist*100.0).toFixed(1));
        cell.appendChild(text);

        cell = row.insertCell(12);
        text = document.createTextNode('' + course.toFixed(1));
        cell.appendChild(text);

        cell = row.insertCell(13);
        text = document.createTextNode('' + d['log_HUMID'].toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(14);
        text = document.createTextNode('' + d['log_INTERNAL_PRESSURE'].toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(15);
        cell.classList.add("volt10");
        text = document.createTextNode('' + d['batt_volts_10V'].toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(16);
        cell.classList.add("volt10");
        text = document.createTextNode('' + (d['batt_capacity_10V']*100).toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(17);
        cell.classList.add("volt24");
        text = document.createTextNode('' + d['batt_volts_24V'].toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(18);
        cell.classList.add("volt24");
        text = document.createTextNode('' + (d['batt_capacity_24V']*100).toFixed(2));
        cell.appendChild(text);
        
        cell = row.insertCell(19);
        text = document.createTextNode('' + d['error_count'].toFixed(0));
        cell.appendChild(text);
    }

    function buildChangelog(which) {
        var glider = currGlider;
        var q, sort;
        var prev, c, cols;

        console.log("building table");
  

        const colors = ["#cccccc", "#eeeeee"];
 
        if (which == 1 || which == 3) {
            sort = document.querySelector('input[name="changelogSortParm"]:checked').value;
            q = `changes/${glider}/-1/parms/${sort}${mission()}`

            fetch(q)
            .then(res => res.text())
            .then(text => {
                try {
                    data = JSON.parse(text);
                } catch (error) {
                    console.log('buildChangelog ' + error);
                    console.log(text);
                    return;
                }

                c = 0;
                if (sort == 'dive') {
                    prev = -1;
                    cols = ['dive', 'parm'];
                }
                else {
                    prev = '';
                    cols = ['parm', 'dive'];
                }
                
                txt = '<table id="changeTable">';
                for (d of data) {
                    if (d[cols[0]] != prev) 
                        c = (c == 0 ? 1 : 0);

                    txt += '<tr style="background-color: ' + colors[c] + '";>';

                    if (d[cols[0]] != prev) {
                        txt += '<td>' + d[cols[0]] + '</td>';
                        prev = d[cols[0]];
                    }    
                    else 
                        txt += '<td></td>';
                    
                    txt += '<td>' + d[cols[1]] + '</td>';

                    txt += '<td>' + d['oldval'] + '</td>';
                    txt += '<td><b>&#10230;</b></td>';
                    txt += '<td>' + d['newval'] + '</td></tr>';
                }
                txt += '</table>';
                $('changelogTable').innerHTML = txt;
            })
            .catch(error => {
                console.log(error);
            });
        }
        if (which == 2 || which == 3) {
            sort = document.querySelector('input[name="changelogSortFile"]:checked').value;
            q = `changes/${glider}/-1/files/${sort}${mission()}`

            console.log('building files history');
            fetch(q)
            .then(res => res.text())
            .then(text => {
                console.log(text);
                try {
                    data = JSON.parse(text);
                } catch (error) {
                    console.log('buildChangelog ' + error);
                    console.log(text);
                    return;
                }

                c = 0;
                
                html = '';
                for (d of data) {
                    html += '<b>' + d['fullname'] + '</b>';
                    html += '<div style="margin-left:40px;"><pre>' + d['contents'] + '</pre></div>';
                }
                $('changelogFilesContent').innerHTML = html;
            })
            .catch(error => {
                console.log(error);
            });
        } 
    }

    function buildTable(glider, dive) {
        var q;
        console.log("building table");

    
        q = `db/${glider}/${dive}${mission()}`
        if (dive  == -1) {
            clearTable();
        }
 
        fetch(q)
        .then(res => res.text())
        .then(text => {
            try {
                data = JSON.parse(text);
            } catch (error) {
                console.log('buildTable ' + error);
                console.log(text);
                return;
            }
        
            var has10 = false;
            var has24 = false;
            for (d of data) {
                addTableRow(d);
                if (d['batt_capacity_24V'] > 0)
                    has24 = true;
                if (d['batt_capacity_10V'] > 0) 
                    has10 = true;
            }
            if (has10 == false) {
                coll = document.getElementsByClassName("volt10");
                for (var i = 0 ; i < coll.length ; i++)
                    coll[i].style.display = "none";
                $('volt24_header').innerHTML = 'volts';
            }
            else if (has24 == false) {
                coll = document.getElementsByClassName("volt24");
                for (var i = 0 ; i < coll.length ; i++)
                    coll[i].style.display = "none";
                $('volt10_header').innerHTML = 'volts';
            }
            if (dive == -1) {
                highlightCurrDive(currDive);
            }
        })
        .catch(error => {
            console.log(error);
        });
    }

    function showTable() {
        setVisibility('mainTable'); 
        currElt = 'table';
    }

    function showPlotly() {
        setVisibility('plotlyDiv');
    }

    function showLog() {
        setVisibility('logDiv');
        currElt = 'logfile';
        $('diveIndicator').style.display = 'block';
    }

    function showLogFile() {
        setVisibility('logfileDiv');
        currElt = 'logfileRaw';
        $('diveIndicator').style.display = 'block';
    }

    function showEng() {
        setVisibility('engfileDiv');
        currElt = 'engfile';
        $('diveIndicator').style.display = 'block';
    }

    var critLine = null;
    function showCap() {
        setVisibility('capfileDiv');
        $('diveIndicator').style.display = 'block';
        currElt = 'capfile';
        if (critLine !== null)
            $(critLine).scrollIntoView();
    }

    function showNotifications() {
        setVisibility('notificationsDiv');
        $('diveIndicator').style.display = 'block';
        currElt = 'notifications';
        if ($('btnNotifications').innerHTML != "") {
            $('btnNotifications').style.backgroundImage = "url('script/images/notification-active-icon.png')";
            $('btnNotifications').innerHTML = '';
            console.log('clearing alert blink');
        }
    }

    function showChangelog() {
        setVisibility('changelogDiv');
        currElt = 'changelog';
    }

    function loadAbout(mission, org) {
        var cell, t, tbody, row;

        d = $('aboutContent');
        t = document.createElement('table');
        d.appendChild(t);
        tbody = document.createElement('tbody');
        t.appendChild(tbody);

        for (k of Object.keys(mission)) {
            if (mission[k] == null)
                continue;

            row = tbody.insertRow();
            cell = row.insertCell(0);
            cell.innerHTML = k + ':';
            cell.style = "text-align:right;"
            cell = row.insertCell(1);
            cell.innerHTML = mission[k];
        } 
    }

    function loadStatus(glider, dive) {
        fetch(`status/${glider}${mission()}`)
        .then(res => res.text())
        .then(text => {
            // console.log(text);
            if (text.includes("authorization failed")) {
                openLoginForm(window.location.reload.bind(window.location));
                return;
            }
            try {
                data = JSON.parse(text);
            } catch (error) {
                console.log('loadStatus ' + error);
                console.log(text);
                return;
            }
            document.title = data['glider'];
            currTitle = data['glider'];
            if (dive == -1 && parseInt(data['dive']) != currDive) {
                currDive = maxDive = parseInt(data['dive']);
                
                loadPlots(currDive, true);
                $('diveIndicator').innerHTML = 'dive ' + currDive;

                // loadLog(currDive);
                updateMaxDive();
            }
            else if (dive > 0 && dive < parseInt(data['dive'])) {
                maxDive = parseInt(data['dive']);
                currDive = dive;

                loadPlots(currDive, true);
                $('diveIndicator').innerHTML = 'dive ' + currDive;

                // loadLog(currDive);
                updateMaxDive();
            }
            engplotlyplots = data['engplotly'];
            engplots = data['engplots'];
            sgplots = data['sgplots'];
            sgplotlyplots = data['sgplotly'];
            buildTable(glider, -1);
            buildChangelog(3);
            loadAbout(data.mission, data.organization);
            if (data.mission.status == 'active') {
                setupStream(glider, true, true);
                currStatus = 'active';
            }
        })
        .catch(error => {
            console.log(error);
        });

    }

    function clearPlots() {
        while($('plotRibbon').firstChild) {
            $('plotRibbon').removeChild($('plotRibbon').firstChild);
        }
        plotList = []
    }

    var prevHighlightID = '';
    var prevHighlightColor = '';  

    function clearTable() {
        while($('mainTable').rows.length > 1) {
            $('mainTable').deleteRow(1);
        }
        prevHighlightID = '';
        prevHighlightColor = '';  
    }

    var plotList = []
    function addPlot(which, p, x, plotly) {
        var div = document.createElement('div');
        div.classList.add('thumbDiv');
        img = document.createElement('img');
        img.classList.add('thumbImg');
        img.src = 'plot/webp/' + which + '/' + currGlider + '/' + currDive + '/' + p + mission();
        img.onclick = function() { showPlot(which, p, plotly); };
        img.title = p;
        img.id = 'thumb' + p;
        div.appendChild(img);
        $('plotRibbon').appendChild(div);
        plotList.push(p);
    }

    function jumpScrollByName(x) {
        i = plotList.indexOf(x);
        if (i > -1) {
            jumpScroll(i);
        }
    }

    function loadLog(dive) {
        fetch(`log/${currGlider}/${dive}${mission()}`)
        .then(res => res.text())
        .then(data => {
            // $('logDiv').innerHTML = 'Dive ' + dive + '<br>';
            $('logDiv').innerHTML = '<br>';
            $('logDiv').innerHTML += data;
        })
        .catch(error => {
            console.log(`loadLog - ${error}`);
        });
    }

    function loadFile(dive, ext, div) {
        fetch(`file/${ext}/${currGlider}/${dive}${mission()}`)
        .then(res => res.text())
        .then(data => {
            if (data == 'none' && ext == 'cap') {
                $('btnCapFile').style.backgroundImage = "url('script/images/cap-none-icon.png')";
                $(div).innerHTML = '<br>no capture file'; 
            }
            else {
                if (ext == 'cap') {
                    critLine = null;

                    if (data.includes(',C,')) {
                        var i = 0;
                        var txt = '';
                        for (var x of data.split('\n')) {      
                            if (x.includes(',C,'))  {
                                if (critLine == null) 
                                    critLine = 'crit' + i;
                                txt += `<span id="crit${i}"><b>${x}</b></span>\n`;
                            }
                            else {
                                txt += x + '\n';
                            }
                            i++;
                        } 
                        $(div).innerHTML = '<pre>' + txt + '</pre>';
                        
                        $('btnCapFile').style.backgroundImage = "url('script/images/cap-crit-icon.png')";
                    }
                    else {
                        $(div).innerHTML = '<pre>' + data + '</pre>';
                        $('btnCapFile').style.backgroundImage = "url('script/images/cap-icon.png')";
                    }
                }
                else {
                    $(div).innerHTML = '<pre>' + data + '</pre>';
                }
            }
        })
        .catch(error => {
            console.log(`loadFile - ${ext} ${error}`);
        });
    }
 
    async function loadNotifications(dive) {
        var i;
        var html;
        var pieces;
        var deltas;
        let urls = [`alerts/${currGlider}/${dive}${mission()}`, `deltas/${currGlider}/${dive}${mission()}`];
        let notify = 'none';

        let resp = await Promise.all(urls.map(url => fetch(url).then(res => res.text())));
        let alerts = resp[0];
        try {
            deltas = JSON.parse(resp[1]);
        } catch (error) {
            console.log('loadNotifications ' + error);
            console.log(resp[1]);
            deltas = { 'parm': [], 'file': [] };
        }

        // html = `Dive ${dive}<p><h3>alerts</h3><p>`;
        html = '';
        if (alerts != "not found") {
            html += alerts;
            if (alerts.indexOf('CRITICAL:') > -1)
                notify = 'critical';
            else if (alerts.indexOf('ERROR:') > -1)
                notify = 'error';
            else if (alerts.indexOf('WARNING:') > -1)
                notify = 'warning';
            else 
                notify = 'notify';
        }

        html += '<h3 onclick="showChangelog(); return false;" style="color:blue;">parameter changes</h3><p><table style="margin-left:40px;">';
        for (i = 0 ; i < deltas['parm'].length; i++) {
            pieces = deltas['parm'][i];
            html += `<tr><td>${pieces['parm']}&nbsp;&nbsp;&nbsp;</td><td>${pieces['oldval']}</td><td> <b>&#10230;</b> <td>${pieces['newval']}</td></tr>`;
        } 
        
        html += '</table><p><h3 onclick="showChangelog(); return false;" style="color:blue;">control files</h3><p>';
        for (i = 0 ; i < deltas['file'].length; i++) {
            html += '<b>' + deltas['file'][i]['file'] + '</b>';
            html += '<div style="margin-left:40px;"><pre>' + deltas['file'][i]['contents'] + '</pre></div>';
        }

        $('notificationsDiv').innerHTML = html;

        if (deltas['file'].length > 0 || deltas['parm'].length > 0) {
            if (notify == 'none')
                notify = 'notify';
        }        

        if (notify == 'critical')  { 
            $('btnNotifications').style.backgroundImage = "url('script/images/notification-icon.png')";
            $('btnNotifications').innerHTML = "<img src='script/images/notification-active-flash-red.png' class='blinkfade'>";
        }
        else if (notify == 'error')  { 
            $('btnNotifications').style.backgroundImage = "url('script/images/notification-icon.png')";
            $('btnNotifications').innerHTML = "<img src='script/images/notification-active-flash-yellow.png' class='blinkfade'>";
        }
        else if (notify == 'warning')  { 
            $('btnNotifications').style.backgroundImage = "url('script/images/notification-icon.png')";
            $('btnNotifications').innerHTML = "<img src='script/images/notification-active-flash.png' class='blinkfade'>";
        }
        else if (notify == 'notify') {
            $('btnNotifications').style.backgroundImage = "url('script/images/notification-active-icon.png')";
            $('btnNotifications').innerHTML = "";
        }
        else {
            $('btnNotifications').style.backgroundImage = "url('script/images/notification-icon.png')";
            $('btnNotifications').innerHTML = "";
        }
    }
 
    function jumpScroll(n) {
        if (n <= plotList.length) {
            $('plotRibbon').scrollTo(200*n, 0, 'smooth');
            $('thumb' + plotList[n]).click();
        }
        return false;
    }

    function loadPlots(dive, setCurr) {
        var plots;
        var img;
        var x = 0;
        var idx;
        var cookie;
        var priority;
        var first = false;
        const stockPriority = ["diveplot", "reduced_ctd", "ctd", "ts", "vert_vel", "pitch", "roll", "roll_rate", "cog", "ctw", 
                               "wlbb2fl_Chlorophyll_fluorescence", "wlbb2fl_backscatter", "aa4831"];
       
        const subs = { "wlbb2fl_Chlorophyll_fluorescence": "Chlorophyll",
                       "wlbb2fl_backscatter": "backscatter", "ts": "T-S" };

        cookie = readCookie("order");
        if (cookie != null) 
            priority = cookie.split(",");
        else
            priority = stockPriority;

        currDive = dive; // inside the then or before plots might be actually loaded?

        highlightCurrDive(dive);
        loadLog(dive);
        loadFile(dive, 'log', 'logfileDiv');
        loadFile(dive, 'eng', 'engfileDiv');
        loadFile(dive, 'cap', 'capfileDiv');
        loadNotifications(dive);
        $('diveIndicator').innerHTML = 'dive ' + currDive;

        fetch(`plots/${currGlider}/${dive}${mission()}`)
        .then(res => res.json())
        .then(resp => {
            var links = [];
            clearPlots();
            var plots = resp['dvplots'];
            var plotly = resp['plotlyplots'];
            // var engplots = resp['engplots'];

            var ab = plots.indexOf('ab');
            if (ab > -1 && !priority.includes('ab')) {
                plots.splice(ab, 1);
            }

            for (p of priority) {
                if (plots.includes(p)) {
                    addPlot('dv', p, x, plotly.includes(p));
                    x += 200;
                    idx = plots.indexOf(p);
                    plots.splice(idx, 1); 
                    links.push(p in subs ? subs[p] : p);

                    if (!first && setCurr) {
                        first = true;
                        currElt = p;
                    } 
                }
            }
            plots.sort();
            for (p of plots) {
                addPlot('dv', p, x, plotly.includes(p));
                links.push(p in subs ? subs[p] : p);
                x += 200;

                if (!first && setCurr) {
                    first = true;
                    currElt = p;
                } 
            }


            if (ab > -1 && !priority.includes('ab')) {
                addPlot('dv', 'ab', x, false);
                links.push('ab' in subs ? subs['ab'] : 'ab');
                x += 200;
            }

            links.push('eng');

            engplots.sort();
            for (p of engplots) {
                addPlot('eng', p, x, engplotlyplots.includes(p));
                links.push(p in subs ? subs[p] : p);
                x += 200;

                if (!first && setCurr) {
                    first = true;
                    currElt = p;
                } 
            }

            links.push('sg');
            sgplots.sort();
            for (p of sgplots) {
                if (p.includes('section_000')) {
                    addPlot('section', p, x, sgplotlyplots.includes(p));
                    links.push(p in subs ? subs[p] : p);
                    x+= 200;

                    if (!first && setCurr) {
                        first = true;
                        currElt = p;
                    }

                    idx = sgplots.indexOf(p);
                    sgplots.splice(idx, 1); 
                }
            }
            for (p of sgplots) {
                addPlot('section', p, x, sgplotlyplots.includes(p));
                links.push(p in subs ? subs[p] : p);
                x += 200;

                if (!first && setCurr) {
                    first = true;
                    currElt = p;
                } 
            }

            if (currElt == 'logfile') 
                showLog(); 
            else if (currElt == 'logfileRaw')
                showLogFile();
            else if (currElt == 'engfile')
                showEng();
            else if (currElt == 'capfile')
                showCap();
            else if (currElt == 'notifications')
                showNotifications();
            else if (currElt == 'changelog')
                showChangelog();
            else if (currElt == 'table')
                showTable();
            else if (currElt.includes('plotly')) {
                showPlotly();
/*
                var w = currElt.split('-')[1];
                if (w == 'plot' || w == 'table')
                    doPlotlyPlot(w);
                else if (w == 'profiles' || w == 'contour')
                    doPlotlyProfiles(w);
*/
            }
            else if (engplots.includes(currElt))
                showPlot('eng', currElt, engplotlyplots.includes(currElt));
            else if (sgplots.includes(currElt))
                showPlot('section', currElt, sgplotlyplots.includes(currElt));
            else 
                showPlot('dv', currElt, plotly.includes(currElt));

            // $('mainImage').src = '/plot/png/' + currGlider + '/' + dive + '/diveplot';
            // $('mainImage').removeAttribute('hidden'); 
            // $('mainTable').setAttribute('hidden', ''); 


            var n = links.length - 1;
            var e = links.indexOf('eng');
            var ab = links.indexOf('ab');
            var mn = ab > -1 ? ab - 1 : e - 1;
            var all;

            numPages = parseInt(n / 5) + 1;

            links.splice(e, 1); 

            var sec = links.indexOf('sg');

            var j;
            $('plotRibbonLinks').innerHTML = '';
            for (var i = 0 ; i < mn ; i += 5) {
                if (i + 4 < mn)
                    j = i+4;
                else
                    j = mn;

                all = links.slice(i,j+1).join(', ');
                $('plotRibbonLinks').innerHTML += '<span class="spanClick jumpLink" onclick="jumpScroll(' + i + ');" title="' + all +'">' + links[i] + '&hellip;' + links[j] + '</span> <b>&#124;</b> '; 
            }
            if (ab > -1) //  && links[j] != 'ab')
                $('plotRibbonLinks').innerHTML += '<span class="spanClick jumpLink" onclick="jumpScroll(' + ab + ');">ab</span> <b>&#124;</b> ';

            mn = sec-1;
            for (var i = e ; i < mn ; i += 5) {
                if (i + 4 < mn)
                    j = i+4;
                else
                    j = mn;

                all = links.slice(i,j+1).join(', ');
                links[i] = links[i].replace('eng_', ''); 
                links[i] = links[i].replace('mission_', ''); 
                links[i] = links[i].replace('SDCARD_', ''); 
                links[i] = links[i].replace('FM_', ''); 
                links[j] = links[j].replace('eng_', ''); 
                links[j] = links[j].replace('mission_', ''); 
                links[j] = links[j].replace('SDCARD_', ''); 
                links[j] = links[j].replace('FM_', ''); 
                $('plotRibbonLinks').innerHTML += '<span class="spanClick jumpLink" onclick="jumpScroll(' + i + ');" title="' + all +'">' + links[i] + '&hellip;' + links[j] + '</span> <b>&#124;</b> '; 
            }

            // all = links.slice(e,sec).join(', ');
            // $('plotRibbonLinks').innerHTML += '<span class="spanClick jumpLink" onclick="jumpScroll(' + e + ');" title="' + all +'">eng</span> * ';

            links.splice(sec, 1); 

            all = links.slice(sec).join(', ');
            $('plotRibbonLinks').innerHTML += '<span class="spanClick jumpLink" onclick="jumpScroll(' + sec + ');" title="' + all +'">sections</span>';
        })
        .catch(error => {
            console.log(`loadPlots - ${error}`);
        });
    }
    
    function highlightCurrDive(dv) {
        if ('row' + dv != prevHighlightID && $('row' + dv) != null) {
            if (prevHighlightID != '') {
                $(prevHighlightID).style.backgroundColor = prevHighlightColor;
            }
            prevHighlightColor = $('row' + currDive).style.backgroundColor;    
            prevHighlightID = 'row' + currDive;
            $('row' + currDive).style.backgroundColor = '#FFCC99';
        }
    }
 
    function changeDive(dir) {
        var c = currDive;

        currDive += dir;
        while (divesInTable.includes(currDive) === false && currDive < maxDive && currDive > 1) {
            currDive += dir;
        }

        if (currDive > maxDive)
            currDive = maxDive;
        else if (currDive < 1)
            currDive = 1;

        if (currDive != c) {
            loadPlots(currDive, false);
            // loadLog(currDive);
        }
    }
     
    function setDive(dive) {
        if (currDive != dive && dive <= maxDive && dive >= 1) {
            currDive = dive;
            loadPlots(currDive, false);
        }
    } 

    function getSelectionText() {
        var text = "";
        var activeEl = document.activeElement;
        var activeElTagName = activeEl ? activeEl.tagName.toLowerCase() : null;
        if (
          (activeElTagName == "textarea") || (activeElTagName == "input" &&
          /^(?:text|search|password|tel|url)$/i.test(activeEl.type)) &&
          (typeof activeEl.selectionStart == "number")
        ) {
            text = activeEl.value.slice(activeEl.selectionStart, activeEl.selectionEnd);
        } else if (window.getSelection) {
            text = window.getSelection().toString();
        }
        return text;
    } 

    function parameterHelp(which) {
        var str = false;

        if (which == 'cmdfile') {
            var s = $(which).selectionStart;
            var e = $(which).selectionEnd;
            var v = $(which).value;

            if (v[s-1] == '$' && v[e] == ',') {
                str = v.substring(s, e);
            }
        }
        else {
            var v = window.getSelection().toString();
            var h = $('logfileDiv').innerHTML; // we look in logfile to see if this is a valid parameter name
            var i = h.indexOf(v);
            if (i > 0 && h[i-1] == '$' && h[i + v.length] == ',') {
                str = v;
            }
        }
            
        if (str) {
            window.open('parms#' + str, 'parms');
        }
    }

    function transpose(matrix) {
        return matrix[0].map((col, i) => matrix.map(row => row[i]));
    }

    function doPlotlyProfiles(which) {
        let x = $('selPlotlyContour').value;
        var binSize = $('selPlotlyZStride').value;
        const whichNames = { 1: "dives", 2: "climbs", 3: "both", 4: "combine" }; 
        let whichProf =  document.querySelector('input[name="plotlyWhichProfiles"]:checked').value; 
        let first = $('txtPlotlyFirstDive').value;
        let last = $('txtPlotlyLastDive').value;
        let step = $('selPlotlyDiveStride').value;
        let top  = $('txtPlotlyTopDepth').value;
        let bot  = $('txtPlotlyBotDepth').value;
 
        $('btnPlotlyContour').disabled = true;
        $('btnPlotlyProfiles').disabled = true;
        var def  = $('btnPlotlyContour').style.backgroundColor;
        $('btnPlotlyContour').style.backgroundColor = 'yellow';
        $('btnPlotlyProfiles').style.backgroundColor = 'yellow';

        permalink = `z=${x}&op=${which}`;
        permalink += `&first=${first}`;
        permalink += `&last=${last}`;
        permalink += `&top=${top}`;
        permalink += `&step=${step}`;
        permalink += `&bottom=${bot}`;
        permalink += `&bin=${binSize}`;
        permalink += `&${whichNames[whichProf]}`;

        fetch(`pro/${currGlider}/${x}/${whichProf}/${first}/${last}/${step}/${top}/${bot}/${binSize}${mission()}`)
        .then(res => res.text())
        .then(data => {
            data = data.replaceAll('NaN', 'null');
            data = JSON.parse(data);
            // console.log(data[x]);
            currElt = 'plotly-' + which;
            console.log(currElt);
            $('plotlyPermalink').style.display = 'block';
            if (which == 'contour') {
                var d = [{
                    z: data[x],
                    y: data['depth'],
                    x: data['dive'],
                    type: 'contour',
                    /// xaxis: 'profile',
                    // yaxis: 'depth',
                    connectgaps: $('chkFillGaps').checked,
                    contours: {
                        coloring: 'heatmap',
                        showlabels: true,
                        labelfont: {
                            family: 'Raleway',
                            size: 12,
                            color: 'white',
                        },
                    }, 
                }];
                var layout = { 
                                font:       {size: 12},
                                margin: { t:20, l:80, r:80, b:80 },
                                xaxis: { title: 'dive' },
                                yaxis: { title: 'depth', autorange: 'reversed' },
                                plot_bgcolor: "#cccccc",
                                paper_bgcolor: "#bbbbbb",
                             };
                var config = { responsive: true };
                
                $('plotlyPlotDiv').removeChild($('plotlyPlotDiv').firstChild);
                Plotly.newPlot($('plotlyPlotDiv'), d, layout, config);
                $('btnPlotlyContour').style.backgroundColor = def;
                $('btnPlotlyContour').disabled = false;
                $('btnPlotlyProfiles').style.backgroundColor = def;
                $('btnPlotlyProfiles').disabled = false;
            }
            else if (which == 'profiles') {
                var d = [];
                let nb = data[x].length;
                let np = data[x][0].length;
                var xd;

                for (var i = 0 ; i < np ; i++) {
                    xd = [];
                    for (var j = 0 ; j < nb ; j++) {
                        xd[j] = data[x][j][i];
                    }
                    d.push({
                            x:xd,
                            y:data['depth'],
                            mode: "lines",
                            type: "scatter",
                            connectgaps: $('chkFillGaps').checked,
                            name: 'dive ' + data['dive'][i]
                           });
                }
                var layout = {
                                font:       {size: 12},
                                margin: { t:20, l:80, r:80, b:80 },
                                xaxis: { title: x },
                                yaxis: { title: 'depth', autorange: 'reversed' },
                                plot_bgcolor: "#cccccc",
                                paper_bgcolor: "#bbbbbb",
                             };
                var config = { responsive: true };
                Plotly.newPlot($('plotlyPlotDiv'), d, layout, config);
                $('btnPlotlyContour').style.backgroundColor = def;
                $('btnPlotlyContour').disabled = false;
                $('btnPlotlyProfiles').style.backgroundColor = def;
                $('btnPlotlyProfiles').disabled = false;
            }
        })
        .catch(error => {
            console.log('plotly ' + error);
        })
    }

    function doPlotlyPlot(which) {
        var mode;
        let x = $('selPlotlyX').value;
        let x2 = $('selPlotlyX2').value;
        // let y = $('selPlotlyY').value;
        var y = [...$('selPlotlyY').selectedOptions].map(option => option.value);
        var query;

        //for (var i = 0 ; i < $('selPlotlyY').options.length ; i++) {
        //    if ($('selPlotlyY').options[i].selected)
        //        y.push($('selPlotlyY').options[i].value);
        //}

 
        console.log('do plotly, mode = ' + which);

        permalink = `x=${x}&z=${y.join(',')}&op=${which}`;
        if ($('chkMissionPlots').checked) {
            permalink += '&wholemission';
            if (x2 == '-') {
                query = `query/${currGlider}/${x},${y.join(',')}${mission()}`;
            }
            else {
                query = `query/${currGlider}/${x},${x2},${y.join(',')}${mission()}`;
                permalink += `&y=${x2}`;
            }
            mode = 0;

        }
        else {
            permalink += '&divetimeseries';
            if (x2 == '-') { 
                query = `time/${currGlider}/${currDive}/${x},${y.join(',')}${mission()}`;
            }
            else {
                query = `time/${currGlider}/${currDive}/${x},${x2},${y.join(',')}${mission()}`;
                permalink += `&y=${x2}`;
            }
            mode = 1;
        }

        console.log('mode=' + mode + ' query=' + query);
        fetch(query)
        .then(res => res.text())
        .then(data => {
            currElt = 'plotly-' + which;
            console.log(currElt);
            data = data.replaceAll('NaN', 'null');
            data = JSON.parse(data);
            console.log(data);
            $('plotlyPermalink').style.display = 'block';
            if (which == 'plot' && x2 == '-') {
                var d = [];
                var xd = data[x];
                for (var i = 0 ; i < y.length ; i++) {
                    var yd = data[y[i]];
                    d.push({
                            x: xd,
                            y: yd,
                            mode: x == "dive" ? "lines" : "markers",
                            type: "scatter",
                            name: y[i]
                           });
                }
                var layout = { 
                                font:       {size: 12},
                                margin: { t:20, l:80, r:80, b:80 },
                                xaxis: { title: x },
                                yaxis: { title: y[0], autorange: y[0].includes('depth') || y[0].includes('pressure') ? 'reversed' : true },
                                title: { text: mode == 1 ? `Dive ${currDive} ${y[0]}` : '', y:0.95, x:0.5},
                                plot_bgcolor: "#cccccc",
                                paper_bgcolor: "#bbbbbb",
                             };
                var config = { responsive: true };
                $('plotlyPlotDiv').removeChild($('plotlyPlotDiv').firstChild);
                Plotly.newPlot($('plotlyPlotDiv'), d, layout, config);
            }
            else if (which == 'plot') {
                var d = [];
                var xd = data[x];
                var xd2 = data[x2];
                for (var i = 0 ; i < y.length ; i++) {
                    var yd = data[y[i]];
                    d.push({
                            x: xd,
                            y: xd2,
                            mode: "markers",
                            type: "scatter",
                            name: y[i],
                            marker: {
                                color: yd,
                                colorbar: {
                                    title: y[i],
                                    len: 0.8,
                                },
                                colorscale: "Jet", 
                            }
                           });
                }
                var layout = { 
                                font:       {size: 12},
                                margin: { t:20, l:80, r:80, b:80 },
                                xaxis: { title: x },
                                yaxis: { title: x2, autorange: x2.includes('depth') || x2.includes('pressure') ? 'reversed' : true },
                                plot_bgcolor: "#cccccc",
                                paper_bgcolor: "#bbbbbb",
                             };
                var config = { responsive: true };
                $('plotlyPlotDiv').removeChild($('plotlyPlotDiv').firstChild);
                Plotly.newPlot($('plotlyPlotDiv'), d, layout, config);
            }
            else if (which == 'table') {
                var values = [];
                var headers = [];
                values.push(data[x]);
                headers.push([x]);
                if (x2 != '-') {
                    values.push(data[x2]);
                    headers.push([x2]);
                }
                for (var i = 0 ; i < y.length ; i++) {
                    values.push(data[y[i]]);
                    headers.push([y[i]]);
                }
/*
                var d = [{
                    type: 'table',
                    header: {
                        values: headers,
                        align: 'center',
                        line: { width: 1, color: 'black' },
                        fill: { color: "#aaaaaa" },
                        font: {family: "Arial", size: 12, color: "white"}

                    },
                    cells: {
                        values: values,
                        align: "center",
                        fill: { color: "#eeeeee" } ,
                        line: {color: "#cccccc", width: 1},
                        font: {family: "Arial", size: 11, color: ["black"]}
                    },
                }];
                $('plotlyPlotDiv').removeChild($('plotlyPlotDiv').firstChild);
                Plotly.newPlot($('plotlyPlotDiv'), d);
*/

                t = makeDataTable('plotlyPlotDataTable', headers, values);
                $('plotlyPlotDiv').removeChild($('plotlyPlotDiv').firstChild);
                $('plotlyPlotDiv').append(t);

            }
            else if (which == 'csv') {
                var d = [];
                if (x2 == '-')
                    d.push(([x].concat(y)).join(',')); // headers
                else 
                    d.push(([x,x2].concat(y)).join(',')); // headers

                console.log(d); 
                var o = []; 
                o.push(data[x]);
                if (x2 != '-') 
                    o.push(data[x2]);

                for (var i = 0 ; i < y.length ; i++)
                    o.push(data[y[i]]);

                output = o[0].map((_, colIndex) => o.map(row => row[colIndex]).join(','));
                console.log(output);

                const blob = new Blob([d.concat(output).join('\n')], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.setAttribute('href', url);
                a.setAttribute('download', y[0] + '.csv'); 
                a.click();
            }
            console.log(y);
        })
        .catch(error => {
            console.log('plotly ' + error);
        })
    }

    function emptySelect(s) {
        while(s.options.length > 0)
            s.remove(0);
    }

    function loadPlotlyControlsContour(glider) {
        console.log('loading contour controls');
        fetch(`timevars/${glider}${mission()}`)
        .then(res => res.text())
        .then(text => {
            try {
                var allnames = JSON.parse(text);  
                var names = [] 
                for (var i = 0 ; i < allnames.length ; i++) {
                    if (!allnames[i].includes('time') && !allnames[i].includes('depth')) {
                        names.push(allnames[i]); 
                    }
                }

                emptySelect($('selPlotlyContour'));
                for (n of names) {
                    let optX = document.createElement('option');
                    optX.value = n;
                    optX.innerHTML = n;
                    let optY = document.createElement('option');
                    $('selPlotlyContour').appendChild(optX);
                }

                if (startZ) {
                    $('selPlotlyContour').value = startZ;
                }     
                if (startOp && (startOp == 'contour' || startOp == 'profiles')) {
                    if (startZ) {
                        startZ = null;
                    }
                    doPlotlyProfiles(startOp); 
                    showPlotly();
                    startOp = null;
                }
            } catch(e) {
                console.log('provars ' + e);
                console.log(text);
            }
        })
        .catch(error => {
            console.log('provars ' + error);
        });

    }

    function loadPlotlyControlsXY(glider) {
        console.log('loading XY controls');
        fetch(`dbvars/${glider}${mission()}`)
        .then(res => res.text())
        .then(text => {
            try {
                data = JSON.parse(text);
            } catch (error) {
                console.log(text);
                return;
            }

            names = data['names'].sort();
            dv = names.indexOf('dive');
            names.splice(names.indexOf('dive'), 1);
            names = ['dive'].concat(names);

            emptySelect($('selPlotlyX'));
            emptySelect($('selPlotlyX2'));
            emptySelect($('selPlotlyY'));

            let noOpt = document.createElement('option');
            noOpt.value = '-';
            noOpt.innerHTML = '-';
            $('selPlotlyX2').appendChild(noOpt);

            for (n of names) {
                let optX = document.createElement('option');
                optX.value = n;
                optX.innerHTML = n;
                let optX2 = document.createElement('option');
                optX2.value = n;
                optX2.innerHTML = n;
                let optY = document.createElement('option');
                optY.value = n;
                optY.innerHTML = n;
 
                $('selPlotlyX').appendChild(optX);
                $('selPlotlyX2').appendChild(optX2);
                $('selPlotlyY').appendChild(optY);
            }
            if ($('chkMissionPlots').checked) {
                if (startX) {
                    $('selPlotlyX').value = startX;
                    startX = null;
                }
                if (startY) {
                    $('selPlotlyX2').value = startY;
                    startY = null;
                }
                if (startZ) {
                    $('selPlotlyY').value = startZ;
                }
                if (startOp && (startOp == 'plot' || startOp == 'table' || startOp == 'csv')) {
                    if (startZ) {
                        startZ = null;
                    }

                    doPlotlyPlot(startOp);
                    showPlotly();
                    startOp = null;
                }
            }
        })
        .catch(error => {
            console.log('dbvars ' + error);
        });

    }

    function loadPlotlyControlsTS(glider, dive) {
        console.log('loading TS controls');
        fetch(`timevars/${glider}${mission()}`)
        .then(res => res.text())
        .then(text => {
            try {
                 data = JSON.parse(text);
            } catch (error) {
                console.log(text);
                return;
            }

            var names = data;
            dv = names.indexOf('time');
            names.splice(names.indexOf('time'), 1);
            names = ['time'].concat(names);

            emptySelect($('selPlotlyX'));
            emptySelect($('selPlotlyX2'));
            emptySelect($('selPlotlyY'));

            let noOpt = document.createElement('option');
            noOpt.value = '-';
            noOpt.innerHTML = '-';
            $('selPlotlyX2').appendChild(noOpt);

            for (n of names) {
                let optX = document.createElement('option');
                optX.value = n;
                optX.innerHTML = n;
                let optX2 = document.createElement('option');
                optX2.value = n;
                optX2.innerHTML = n;
                let optY = document.createElement('option');
                optY.value = n;
                optY.innerHTML = n;
 
                $('selPlotlyX').appendChild(optX);
                $('selPlotlyX2').appendChild(optX2);
                $('selPlotlyY').appendChild(optY);
            }
            if ($('chkTimeseriesPlots').checked) {
                if (startX) {
                    $('selPlotlyX').value = startX;
                    startX = null;
                }
                if (startY) {
                    $('selPlotlyX2').value = startY;
                    startY = null;
                }
                if (startZ) {
                    $('selPlotlyY').value = startZ;
                }
                if (startOp && (startOp == 'plot' || startOp == 'table' || startOp == 'csv')) {
                    if (startZ) {
                        startZ = null;
                    }
                    doPlotlyPlot(startOp);
                    showPlotly();
                    startOp = null;
                }
            }
        })
        .catch(error => {
            console.log('timevars ' + error);
        });

    }

    function switchControls(id) {
        if (id == 'chkTimeseriesPlots' && $(id).checked) {
            $('chkMissionPlots').checked = false;
            console.log('unchecking mission');
            loadPlotlyControlsTS(currGlider, currDive);
            $('labelY').innerHTML = 'Y:';
            $('labelZ').innerHTML = 'Z:';
            // $('selPlotlyX2').disabled = false;
        }
        else if (id == 'chkMissionPlots' && $(id).checked) {
            $('chkTimeseriesPlots').checked = false;
            console.log('unchecking ts');
            loadPlotlyControlsXY(currGlider);
            // $('selPlotlyX2').disabled = true;
            $('labelY').innerHTML = 'Y:';
            $('labelZ').innerHTML = 'Z:';
        }

        if ($('chkMissionPlots').checked == false 
              && $('chkTimeseriesPlots').checked == false) {
            $(id).checked =true;
        } 
    }

    var bodyFudge = 0;

    function init() {
        let path = window.location.pathname.substring(1).split('/');
        let glider = -1;
        let dive = -1;

        var scale = 'scale(1.0)';
        document.body.style.webkitTransform =  scale;    // Chrome, Opera, Safari
        document.body.style.msTransform =   scale;       // IE 9
        document.body.style.transform = scale;     // General

        if (path.length >= 1) {
            glider = path[path.length - 1]
            console.log(glider);
        }

        let params = new URLSearchParams(window.location.search);
        if (params.has('dive')) {
            dive = parseInt(params.get('dive'));
        }
        if (params.has('mission')) {
            currMission = params.get('mission');
        }
        if (params.has('plot')) {
            currElt = params.get('plot');
        }
        if (params.has('order')) {
            createCookie("order", params.get('order'), 180);
        }

        // set mobile based on media query
        if (window.matchMedia("(pointer: coarse)").matches) {
            mobile = true;
        }

        // check if user has spec'd an override to mobile,
        // if so set (or reset) the local storage for
        // the subsequent query
        if (params.has('mobile')) 
            localStorage.setItem('visMode', 'mobile');
        else if (params.has('desktop'))
            localStorage.setItem('visMode', 'desktop');

        // check local storage to see if user has a 
        // preferred override mode - if so, set it
        let mode = localStorage.getItem('visMode');
        if (mode && mode == 'mobile') {
            mobile = true; 
        }
        else if (mode && mode == 'desktop') {
            mobile = false;
        }

        if (mobile) 
            visClass = 'mobile';
        else
            visClass = 'desktop';

        if (glider == -1) {
            alert('invalid request - specify glider');
            console.log('invalid request - specify glider');
            return;
        }
/*
        if (path.length > 1) {
            window.history.replaceState('object or string', 'Title', `/${glider}`);
        }
*/

        if (currMission != '') {
            $('missionIndex').removeAttribute('hidden');
            $('missionIndexText').innerHTML = currMission.replaceAll('_', ' ');
        }

        $('gliderIndexText').innerHTML = 'SG' + glider;

        currGlider = glider;
        console.log(glider);
        window.name = glider;
        loadStatus(glider, dive);
        // setupStream(glider, true, true);
{% if runMode == 'pilot' %}
        loadControlFile('cmdfile');
        loadControlFile('science');
        loadControlFile('targets');
        loadControlFile('scicon.sch');
        loadControlFile('tcm2mat.cal');
        loadControlFile('pdoscmds.bat');
        loadControlFile('sg_calib_constants.m');
        $('selectFile').value = 'cmdfile';
{% endif %}
        loadPlotlyControlsXY(glider);
        loadPlotlyControlsContour(glider);
        $('chkMissionPlots').checked = true;
        $('chkTimeseriesPlots').checked = false;

{% if runMode == 'pilot' %}
{% if noChat == false %}
        dragElement($('chatDiv'));
        $('attachImage').addEventListener('change', attachImageChange);
        $('modalImgClose').onclick = function() {
            $('modalImgDiv').style.display = "none";
        }
{% endif %}
{% endif %}

        if (params.has('bin')) {
            $('selPlotlyZStride').value = params.get('bin');
        }
        if (params.has('top')) {
            $('txtPlotlyTopDepth').value = params.get('top');
        }
        if (params.has('bottom')) {
            $('txtPlotlyBotDepth').value = params.get('bottom');
        }
        if (params.has('first')) {
            $('txtPlotlyFirstDive').value = params.get('first');
        }
        if (params.has('last')) {
            $('txtPlotlyLastDive').value = params.get('last');
            lastDive = params.get('last');
        }
        if (params.has('step')) {
            $('selPlotlyDiveStride').value = params.get('step');
        }
        if (params.has('op')) {
             startOp = params.get('op');
             currElt = 'plotly-' + startOp;
        }

        if (params.has('wholemission')) { 
            $('chkMissionPlots').checked = true;
            switchControls('chkMissionPlots');
        }
        else if (params.has('divetimeseries')) {
            $('chkTimeseriesPlots').checked = true;
            switchControls('chkTimeseriesPlots');
        }

        if (params.has('dives'))
            $('radPlotlyDives').checked = true;
        else if (params.has('climbs'))
            $('radPlotlyClimbs').checked = true;
        else if (params.has('both'))
            $('radPlotlyBoth').checked = true;
        else if (params.has('combine'))
            $('radPlotlyCombine').checked = true;

        if (params.has('x')) {
            startX = params.get('x');
        }
        if (params.has('y')) {
            startY = params.get('y');
        }
        if (params.has('z')) {
            startZ = params.get('z');
        }

        document.onkeydown = function (event) {
            const excl = ['input', 'textarea'];
            if (excl.includes(event.target.tagName.toLowerCase()))
                return;

            var idx;
            const key = event.key;
            if (key == 'a' || key == 'h') {
                idx = plotList.indexOf(currElt);
                if (idx > 0) {
                    idx --;
                    $('thumb' + plotList[idx]).click();
                }
            }
            else if (key == 'd' || key == 'l') {
                idx = plotList.indexOf(currElt);
                if (idx < (plotList.length - 1)) {
                    idx ++;
                    $('thumb' + plotList[idx]).click();
                }
            }
            else if (key == 'w' || key == 'k')
                changeDive(1);
            else if (key == 's' || key == 'j')
                changeDive(-1);
            else if ("123456789".includes(key) && parseInt(key) <= numPages) {
                jumpScroll((parseInt(key) - 1)*5);
            }

        };

        $('plotRibbon').addEventListener("wheel", (evt) => {
            evt.preventDefault();
            $('plotRibbon').scrollLeft += evt.deltaY;
        });

        if (mobile) {
            document.body.addEventListener("focus", event => {
                const target = event.target;
                switch (target.id) {
                    case "cmdfile":
                    case "targets":
                    case "science":
                    case "scicon.sch":
                    case "sg_calib_constants.m":
                    case "pdoscmds.bat":
                    case "tcm2mat.cal":
                        $('divCmdfile').classList.add("editing");   
                        document.body.scrollTo( { top: 0, left: 0 } );
                        window.scrollTo( { top: 0, left: 0 });
                        $('divCmdfile').scrollIntoView();
                        $('navLinks').scrollIntoView();
                        $('cmdfileEditClose').style.display = "block";
                        
                }
            }, true); 
            document.body.addEventListener("blur", () => {
                defocusEditWindow();
            }, true); 
        }

        const elements = document.querySelectorAll('body *');

        elements.forEach((element) => {
            element.classList.add(visClass);
        });
    }

    function defocusEditWindow() {
        $('divCmdfile').classList.remove("editing");
        $('cmdfileEditClose').style.display = "none";
    }

    function showRibbon() {
        if ($('plotRibbonBox').style.display == 'none')
            $('plotRibbonBox').style.display = 'block';
        else
            $('plotRibbonBox').style.display = 'none';
    }

{% if runMode == 'pilot' %}
    var rightMode = 'grid';
    function toggleRight() {
        const collection = document.getElementsByClassName("plotly-graph-div"); 
        if ($('right').style.display == 'none') {
            $('right').style.display = rightMode;
            $('toggleRight').innerHTML = 'Hide pilot';
            Plotly.Plots.resize(collection[0]);
        }
        else {
            rightMode = $('right').style.display;
            $('right').style.display = 'none';
            $('toggleRight').innerHTML = 'Show pilot';
            Plotly.Plots.resize(collection[0]);
        }
    }
{% endif %}
        
</script>

<html>
<body onload="init();" style="font-family: verdana, arial, tahoma, 'sans serif';">

<div id="navLinks">
    <a href="./" target="index">Index</a> <b>&#124;</b> 
    <a href="dash" target="dash"> Dashboard </a> <b>&#124;</b> 
{% if runMode == 'pilot' %}
{% if noChat == false %}
    <span class="spanClick" onclick="chatShow(); return false;">Chat</span> <b>&#124;</b>
{% endif %}
{% endif %}
    <span class="spanClick" onclick="openAboutForm(); return false;">About</span> <b>&#124;</b>
    <div class="dropdown">
        <span class="spanClick droplink">Tools </span><b>&#124;</b>
        <div class="dropdown-content">
            <span class="spanClick" onclick="popupPosition(); return false;">Position</span> 
            <span class="spanClick" onclick="openRegressionForm(); return false;">VBD regression</span> 
            <span class="spanClick" onclick="openBallastSheet(); return false;">Ballast worksheet</span> 
        </div>
    </div>
    <span id="missionIndex" hidden="hidden"><span id="missionIndexText" class="spanClick" onclick="missionIndex(); return false;">Mission</span> <b>&#124;</b></span>
    <span id="gliderIndex"><span id="gliderIndexText" class="spanClick" onclick="gliderIndex(); return false;">Glider</span> <b>&#124;</b></span>
    <a href="help" target="help"> Help </a> 
{% if runMode == 'pilot' %}
    <span class="spanClick" id="toggleRight" style="float:right; padding-right: 10px;" onclick="toggleRight(); return false;">Hide pilot</span>
{% endif %}
</div>

<div id="bodyView">

<div id="toolbar">
    <div class="toolTop">
        <button class="tool" id="btnDiveUp"        onclick="changeDive(1);" title="next dive [w,k] "></button>
        <button class="tool" id="btnDiveTable"     onclick="showTable();" title="dives table"></button>
        <button class="tool" id="btnDiveDown"      onclick="changeDive(-1);" title="prev dive [s,j]"></button>
        <button class="tool" id="btnNotifications" onclick="showNotifications();" title="notifications"></button>
        <button class="tool" id="btnCapFile"       onclick="showCap();" title="capture file"></button>
        <button class="tool" id="btnLogTable"      onclick="showLog();" title="log summary"></button>
        <button class="tool" id="btnPlotTool"      onclick="showPlotly();" title="plot and table tool"></button>
        <button class="tool" id="btnLogFile"       onclick="showLogFile();" title="log file"></button>
        <button class="tool" id="btnEngFile"       onclick="showEng();" title="engineering file"></button>
    </div>

    <div class="toolBottom">
        <button class="tool" id="btnMap"      onclick="popupMap();" title="map"></button>
        <button class="tool" id="btnSelftest" onclick="popupSelftest();" title="selftest"></button>
    </div>
</div>

<div id="main">
    <div id="ribbonExpander" onclick="showRibbon(); return false;">&#10063;&#10063&#10063;</div>
    <div id="plotlyPopperOuter">&#x2922;</div>
    <span id="diveIndicator"></span>
    <div id="plotlyPermalink" onclick="showPermalink();">&#x1F517;</div>
    <img id="mainImage" style="mix-blend-mode:multiply;" class="hide">
    <div id="mainDiv" class="mainViewport" style="mix-blend-mode:multiply;" class="hide">
    </div>
    <table rules="groups" id="mainTable" class="hide">

        <colgroup span=4><col><col><col><col></colgroup>
        <colgroup span=6><col><col><col><col><col><col><col></colgroup>
        <colgroup span=2><col><col></colgroup>
        <colgroup span=2><col><col></colgroup>
        <colgroup span=2 id="volt10_group"><col class="volt10"><col class="volt10"></colgroup>
        <colgroup span=2 id="volt24_group"><col class="volt24"><col class="volt24"></colgroup>
        <colgroup span=1><col></colgroup>
        <tbody>
            <tr bgcolor="#aaaaaa" align="center">
                <th>dive</th>
                <th>end</th>
                <th>length</th>
                <th>depth</th>
                <th>dog</th>
                <th>cog</th>
                <th>dtw</th>
                <th>ctw</th>
                <th>dtg</th>
                <th>ctg</th>
                <th>OG eff.</th>
                <th>Umag</th>
                <th>Udir</th>
                <th>RH</th>
                <th>int P</th>
                <th id="volt10_header" class="volt10">volts10</th>
                <th id="cap10_header" class="volt10">% cap</th>
                <th id="volt24_header" class="volt24">volts24</th>
                <th id="cap24_header" class="volt24">% cap</th>
                <th>errors</th>
            </tr>
        </tbody>
    </table>

    <div id="logDiv" class="hide"></div>
    <div id="notificationsDiv" style="margin-left:20px; text-align:left;" oncontextmenu="parameterHelp('notificationsDiv');" class="hide"></div>
    <div id="changelogDiv" style="margin-left:20px; text-align:left;" oncontextmenu="parameterHelp('changelogDiv');" class="hide">
        <div id="changelogParms">
            Sort by
            <input type="radio" id="radSortDives" name="changelogSortParm" value="dive" checked onchange="buildChangelog(1);">
            <label for="radSortDives">dive</label>
            <input type="radio" id="radSortParms" name="changelogSortParm" value="parm" onchange="buildChangelog(1);"> 
            <label for="radSortParms">parameter</label>
            <p>
            <div id="changelogTable">
            </div>
        </div>
        <div id="changelogFiles">
            Sort by
            <input type="radio" id="radFileDives" name="changelogSortFile" value="dive" checked onchange="buildChangelog(2);">
            <label for="radFileDives">dive</label>
            <input type="radio" id="radFileParms" name="changelogSortFile" value="file" onchange="buildChangelog(2);"> 
            <label for="radFileParms">file</label>
            <p>
            <div id="changelogFilesContent">
            </div>
        </div>
    </div>
    
    
    <div id="plotlyDiv" class="hide">
        <div id="plotyConfigXYDiv">
            <span id="labelX">X:</span><select id="selPlotlyX"></select><br>
            <span id="labelY">Y:</span><select id="selPlotlyX2"></select> <br>
            <input type="checkbox" checked id="chkMissionPlots" onclick="switchControls(this.id);"><label for="chkMissionPlots">whole mission</label>
            <input type="checkbox" id="chkTimeseriesPlots" onclick="switchControls(this.id);"><label for="chkTimeseriesPlots">dive time series</label><br>
        </div>
        <div id="plotlyConfigZDiv">
            <span id="labelZ">Z:</span><select id="selPlotlyY" class="select-checkbox" multiple size="4"> </select>
        </div>
        <div id="plotlyConfigXYZButtons">
            <button id="btnPlotlyPlot" onclick="doPlotlyPlot('plot');">plot</button>
            <button id="btnPlotlyTable" onclick="doPlotlyPlot('table');">table</button><br>
            <button id="btnPlotlyCSV" onclick="doPlotlyPlot('csv');">export</button>
        </div>
        <div id="plotlyConfigContour"> <!-- style="float:right;"> -->
            <div id="plotlyConfigContourValue">value:<select id="selPlotlyContour"> </select></div><br>
            <div id="plotlyConfigStrides">
                depth: top <input id="txtPlotlyTopDepth" maxlength=4 type="number" min=1 max=9999 style="width: 5em;" value=0> 
                       bot <input id="txtPlotlyBotDepth" maxlength=4 type="number" min=2 max=9999 style="width: 5em;" value=990>
                bin
                <select style="vertical-align:top;" id="selPlotlyZStride">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="5" selected>5</option>
                    <option value="10">10</option>
                    <option value="20">20</option>
                </select>
            </div>
            <div id="plotlyConfigContourDives">
                dives: first <input id="txtPlotlyFirstDive" maxlength=4 type="number" min=1 max=9999 style="width: 5em;" value=1> 
                       last <input id="txtPlotlyLastDive" maxlength=4 type="number" min=2 max=9999 style="width: 5em;" value=9999>
                       step <select style="vertical-align:top;" id="selPlotlyDiveStride">
                                <option value="1" selected>1</option>
                                <option value="2">2</option>
                                <option value="5">5</option>
                                <option value="10">10</option>
                                <option value="20">20</option>
                            </select>
            </div>
            <div id="plotlyConfigWhichProfiles">
                <input type="radio" id="radPlotlyDives" name="plotlyWhichProfiles" value="1"> 
                <label for="radPlotlyDives">dives</label>
                <input type="radio" id="radPlotlyClimbs" name="plotlyWhichProfiles" value="2"> 
                <label for="radPlotlyClimbs">climbs</label>
                <input type="radio" id="radPlotlyBoth" name="plotlyWhichProfiles" value="3" checked> 
                <label for="radPlotlyBoth">both</label>
                <input type="radio" id="radPlotlyCombine" name="plotlyWhichProfiles" value="4"> 
                <label for="radPlotlyCombine">combine</label>
            </div>
            <div id="plotlyConfigContourButtons">
                <button id="btnPlotlyContour" onclick="doPlotlyProfiles('contour');">contour</button>
                <button id="btnPlotlyProfiles" onclick="doPlotlyProfiles('profiles');">profiles</button>
                <input type="checkbox" checked id="chkFillGaps"><label for="chkFillGaps">fill gaps</label><br>
            </div>
        </div>
        <div id="plotlyPlotDiv">
        </div>
    </div>

    <div id="logfileDiv" class="hide" oncontextmenu="parameterHelp('logfileDiv'); return false;" title="right click/long press parameter for help" style="background-color:#eeeeee; text-align:left;" >
    </div>

    <div id="engfileDiv" class="hide" style="background-color:#eeeeee; text-align:left;">
    </div>

    <div id="capfileDiv" class="hide" style="background-color:#eeeeee; text-align:left;">
    </div>
</div>

<div id="plotRibbonBox" title="a or h to move left, f or l to move right, number key 1-8 to jump to section, scroll wheel scrolls">
    <div id="plotRibbonLinks">

    </div>
    <div id="plotRibbon">

    </div>
</div>


{% if runMode == 'pilot' %}

<div id="right">

    <div id="status">
        <div id="position">
        </div>
        <div id="positionTime">
        </div>
        <table id="statusTable">
            <col class="statusTableLabel">
            <col class="statusTableValue">
            <col class="statusTableLabel">
            <col class="statusTableValue">
            <col class="statusTableLabel">
            <col class="statusTableValue">
            <tr>
                <td>SOG</td><td id="SOG"></td>
                <td>COG</td><td id="COG"></td>
                <td>last fix</td><td id="lastFix"></td>
            </tr>
            <tr>
                <td>DOG</td><td id="DOG"></td>
                <td>&Delta;t</td><td id="dt"></td>
                <td>last call</td><td id="lastConnect"></td>
            </tr>
            <tr>
                <td>pitch</td><td id="pitch"></td>
                <td>volts</td><td id="volts"></td>
            </tr>
            <tr>
                <td>depth</td><td id="depth"></td>
                <td>dive</td><td id="dive"></td>
            </tr>
            <tr>
                <td>RH</td><td id="RH"></td>
                <td>cycle</td><td id="cycle"></td>
            </tr>
            <tr>
                <td>int P</td><td id="intP"></td>
                <td>call</td><td id="call"></td>
            </tr>
        </table>
    </div>

    <div id="commlog">

    </div>

    <div id="divCmdfile">
        <div id="cmdfileEditClose" style="display:none;" onclick="defocusEditWindow(); return false;"><b>&#10060;</b></div>
        <textarea id="cmdfile" class="editFile" oncontextmenu="parameterHelp('cmdfile'); return false;">
        </textarea>
        <textarea id="targets" class="editFile" hidden="hidden"></textarea>
        <textarea id="science" class="editFile" hidden="hidden"></textarea>
        <textarea id="scicon.sch" class="editFile" hidden="hidden"></textarea>
        <textarea id="pdoscmds.bat" class="editFile" hidden="hidden"></textarea>
        <textarea id="tcm2mat.cal" class="editFile" hidden="hidden"></textarea>
        <textarea id="sg_calib_constants.m" class="editFile" hidden="hidden"></textarea>
        <div id="fileButtons">
{% if noSave == false %}
            <button id="btnSave" type="button" onclick="saveControl(0);" style="margin-left:2px;">Save</button>
            <button id="btnForce" type="button" onclick="saveControl(1);">Force</button>
            <button id="btnGO" type="button" onclick="changeDirective('GO');" style="background-color:#00aa00;">GO</button>
            <button id="btnQUIT" type="button" onclick="changeDirective('QUIT');" style="background-color:#ff0020;">QUIT</button>
            <button id="btnRESUME" type="button" onclick="changeDirective('RESUME');" style="background-color:yellow;">RESUME</button>
{% endif %}
            <select id="selectFile" onchange="changeFile()">
                <option value="cmdfile" selected>cmdfile</option>
                <option value="targets">targets</option>
                <option value="science">science</option>
                <option value="scicon.sch">scicon.sch</option>
                <option value="pdoscmds.bat">pdoscmds.bat</option>
                <option value="tcm2mat.cal">tcm2mat.cal</option>
                <option value="sg_calib_constants.m">sg_calib_constants.m</option>
            </select>
            <span id="fileDive" hidden="hidden"></span>
        </div>
    </div>
</div>  <!-- right --> 

{% endif %}

</div>  <!-- bodyView -->

{% include "dialogs.html" %}
{% if runMode == 'pilot' %}
{% if noChat == false %}
{% include "chat.html" %}
{% endif %}
{% endif %}

</body>


</html>
