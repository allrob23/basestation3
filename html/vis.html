<style>
    a:link,.spanClick           {color:#0000ff; text-decoration:none}
    a:visited {color:#0000ff; text-decoration:none}
    a:hover,.spanClick:hover    {color:#ff0000; text-decoration:underline}
    a:active,.spanClick:active  {color:#ff0000; text-decoration:underline}

    option { background-color:#eeeeee; }
    select { background-color:#eeeeee; }
    button { background-color:#dddddd; }

</style>
<script src="/script/plotly-latest.min.js"></script>
<script>

    function beep() {
        var snd = new Audio("data:audio/wav;base64,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qJrx4KOQjahZxWbcZgztj2c49nKmkId44S71j0c8eV9yDK6uPRzx5X18eDvjvQ6yKo9ZSS6l//8elePK/Lf//IInrOF/FvDoADYAGBMGb7FtErm5MXMlmPAJQVgWta7Zx2go+8xJ0UiCb8LHHdftWyLJE0QIAIsI+UbXu67dZMjmgDGCGl1H+vpF4NSDckSIkk7Vd+sxEhBQMRU8j/12UIRhzSaUdQ+rQU5kGeFxm+hb1oh6pWWmv3uvmReDl0UnvtapVaIzo1jZbf/pD6ElLqSX+rUmOQNpJFa/r+sa4e/pBlAABoAAAAA3CUgShLdGIxsY7AUABPRrgCABdDuQ5GC7DqPQCgbbJUAoRSUj+NIEig0YfyWUho1VBBBA//uQZB4ABZx5zfMakeAAAAmwAAAAF5F3P0w9GtAAACfAAAAAwLhMDmAYWMgVEG1U0FIGCBgXBXAtfMH10000EEEEEECUBYln03TTTdNBDZopopYvrTTdNa325mImNg3TTPV9q3pmY0xoO6bv3r00y+IDGid/9aaaZTGMuj9mpu9Mpio1dXrr5HERTZSmqU36A3CumzN/9Robv/Xx4v9ijkSRSNLQhAWumap82WRSBUqXStV/YcS+XVLnSS+WLDroqArFkMEsAS+eWmrUzrO0oEmE40RlMZ5+ODIkAyKAGUwZ3mVKmcamcJnMW26MRPgUw6j+LkhyHGVGYjSUUKNpuJUQoOIAyDvEyG8S5yfK6dhZc0Tx1KI/gviKL6qvvFs1+bWtaz58uUNnryq6kt5RzOCkPWlVqVX2a/EEBUdU1KrXLf40GoiiFXK///qpoiDXrOgqDR38JB0bw7SoL+ZB9o1RCkQjQ2CBYZKd/+VJxZRRZlqSkKiws0WFxUyCwsKiMy7hUVFhIaCrNQsKkTIsLivwKKigsj8XYlwt/WKi2N4d//uQRCSAAjURNIHpMZBGYiaQPSYyAAABLAAAAAAAACWAAAAApUF/Mg+0aohSIRobBAsMlO//Kk4soosy1JSFRYWaLC4qZBYWFRGZdwqKiwkNBVmoWFSJkWFxX4FFRQWR+LsS4W/rFRb/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////VEFHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAU291bmRib3kuZGUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMjAwNGh0dHA6Ly93d3cuc291bmRib3kuZGUAAAAAAAAAACU=");  
        snd.play();
    }

    function $(x) {
        return document.getElementById(x)
    }

    Number.prototype.zeroPad = function() {
        return ('0'+this).slice(-2);
    }

   function bearing(pt1, pt2) {
        var lat2 = pt2.lat*Math.PI/180;
        var lat1 = pt1.lat*Math.PI/180;
        var dLat = (lat2 - lat1);
        var dLon = (pt2.lon-pt1.lon)*Math.PI/180;
        var y = Math.sin(dLon) * Math.cos(lat2);
        var x = Math.cos(lat1)*Math.sin(lat2) -
                Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
        var brng = (Math.atan2(y, x)*180/Math.PI + 360) % 360;

        return brng;
    }

    function haversine(pt0, pt1) {
        var lat0, lon0, lat1, lon1;
        var sdlat_2, sdlon_2;
        var a;
        const R = 6378137.0;
        const DTR = 1.745329251994330e-02;

        lat0 = pt0.lat*DTR;
        lat1 = pt1.lat*DTR;
        lon0 = pt0.lon*DTR;
        lon1 = pt1.lon*DTR;

        sdlat_2 = Math.sin(0.5*(lat0 - lat1));
        sdlon_2 = Math.sin(0.5*(lon0 - lon1));

        a = sdlat_2*sdlat_2 + Math.cos(lat0)*Math.cos(lat1)*sdlon_2*sdlon_2;
        if (a >= 1 || a <= 0) {
            return 0;
        }

        return 2.0*R*Math.asin(Math.sqrt(a));
    }

    function formatPos(ddmm) {
        var deg = Math.trunc(ddmm/100);
        var min = Math.abs(ddmm - deg*100);
        var zero = min < 10 ? '0' : '';
        return (deg + '&deg;' + zero + min.toFixed(3) + '&prime;');
    }

    function ddmm2dd(ddmm) {
        var deg = Math.trunc(ddmm/100);
        var min = ddmm - deg*100;

        return deg + min/60;
    }

    function createCookie(name,value,days) {
        if (days) {
            var date = new Date();
            date.setTime(date.getTime()+(days*24*60*60*1000));
            var expires = "; expires="+date.toGMTString();
        }
        else var expires = "";
        document.cookie = name+"="+value+expires+"; path=/";
    }

    function readCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for(var i=0;i < ca.length;i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1,c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
        }
        return null;
    }

    function eraseCookie(name) {
        createCookie(name,"",-1);
    }

    var blurTimer  = false;
    var isBlurred  = false;
    var isFlashing =false;
    var currTitle  = "";

    var currGlider = '';

    var engplots;
    var sgplots;

    var fixes = [];
    var connect_t = 0;

    var fixTimer = null;

    function startFlash() {
        isFlashing = true;
        blurTimer = window.setInterval(function() 
            {
                document.title = document.title == currTitle ? currTitle + "..." : currTitle;
            }, 1000);
    }
 
    window.onblur=function() {
        isBlurred = true;
    }

    window.onfocus=function() { 
        isBlurred = false;
        isFlashing = false;
        document.title = currTitle;
        if (blurTimer) {
            clearInterval(blurTimer);
        }
        blurTimer = false;
    }

    function updateTimer() {
        if (fixes.length > 0) {
            $('lastFix').innerHTML = '' + (Date.now()/1000 - fixes.at(-1).t).toFixed(0) + 's';
        }
        if (connect_t > 0) {
            $('lastConnect').innerHTML = '' + (Date.now()/1000 - connect_t).toFixed(0) + 's';
        }
        fixTimer = setTimeout('updateTimer()', 1000);
    }

    let wsocket  = null;
    var lastSetup = 0;
    var first = true;

    function setupStream(glider) {
        if (Date.now() < lastSetup + 5000) {
            setTimeout('setupStream(glider)', 5000);
            console.log('too soon');
            return;
        }
        lastSetup = Date.now();
 
        if (wsocket != null) {
            wsocket.close();
            console.log('closing previous stream');
        }
        console.log('setting up stream');
        var loc = window.location, new_uri;
        if (loc.protocol === "https:") 
            new_uri = "wss:";
        else
            new_uri = "ws:";

        new_uri += "//" + loc.host;
        new_uri += "/stream/" + glider;
        wsocket = new WebSocket(new_uri);

        wsocket.onerror = function(error) {
            console.log('stream error detected');
            wsocket.close();
            setupStream(glider);
        };

        wsocket.onclose = function(e) {
            if (e.wasClean) {
                console.log('stream closed cleanly');
            }
            else {
                console.log('connection died');
                setupStream(glider);
            }
        };

        var chunk = "";
        wsocket.onmessage = function(e) { 
            var pieces, content, data, i;
            var vals = {};
            var update;
            var newDive;
            var newCmdfile;
            var d, pieces, lines;
            var pt, fix;
            var yr, mo, da, hr, mi, se;
            var tstr;
            const months = {'Jan': 1, 'Feb': 2, 'Mar': 3, 'Apr': 4, 'May': 5, 'Jun':6, 'Jul':7, 'Aug':8, 'Sep':9, 'Oct':10, 'Nov':11, 'Dec':12};
            var styles = ["font-weight:bold;", "font-weight:bold; color:red;", "font-weight:bold; color:green;"]
            var bolds = {"targets":0, "science":0, "cmdfile":0, "pdoscmds.bat":0, "Connected":0, "QUIT":1, "RECOV_CODE":1, "GO":2};


            var line = e.data;
            if (line.startsWith('NEW=')) {
                console.log(line);
                newDive = parseInt(line.split('=')[1].slice(2,6));
                loadPlots(newDive, true);
                // loadLog(newDive);
            }
            else if (line.startsWith('CMDFILE=')) {
                newCmdfile = line.split('=')[1];
                $('cmdfile').value = newCmdfile;
            }
            else {
                lines = line.split('\n');

                var elt = $('commlog');
                elt.scrollTop = elt.scrollHeight;
                for (b of Object.keys(bolds)) {
                    line = line.replaceAll(b, '<span style="' + styles[bolds[b]] + '">' + b + '</span>');
                } 


                elt.innerHTML += line;
                for (d of lines) {
                    if (d.includes('GPS')) {
                        pieces = d.split(' ');
                        if (pieces.length == 2) {
                            colons = pieces[0].split(':');
                            gps    = pieces[1].split(',');
                            da = parseInt(gps[1].substring(0,2))
                            mo = parseInt(gps[1].substring(2,4))
                            yr = 2000 + parseInt(gps[1].substring(4,6))
                            hr = parseInt(gps[2].substring(0,2))
                            mi = parseInt(gps[2].substring(2,4))
                            se = parseInt(gps[2].substring(4,6))
                            tstr = yr + '-' + mo.zeroPad() + '-' + da.zeroPad()
                                   + 'T' + hr.zeroPad() + ':' + mi.zeroPad() + ':' + se.zeroPad() + '.000Z';
                            
                            fix = { pt: { 
                                            lat: ddmm2dd(parseFloat(gps[3])),
                                            lon: ddmm2dd(parseFloat(gps[4]))
                                        },
                                
                                    t: Date.parse(tstr)/1000,
                                  };

                            if (fixes.length == 0 || fixes.at(-1).t < fix.t) {
                                console.log('pushing fix at ' + fix.t);
                                fixes.push(fix);
                            } 
                            if (fixTimer == null) {
                                updateTimer();
                            }
                            if (fixes.length >= 2) {
                                var sog, cog, dog, dt;
                                dt = fixes.at(-1).t - fixes.at(-2).t;
                                dog = haversine(fixes.at(-1).pt, fixes.at(-2).pt);
                                cog = bearing(fixes.at(-2).pt, fixes.at(-1).pt);
                                sog = dog/dt/0.514;
                                $('SOG').innerHTML = sog.toFixed(2) + 'kts';
                                $('COG').innerHTML = cog.toFixed(1) + '&deg;';
                                $('DOG').innerHTML = dog.toFixed(0) + 'm';
                                $('dt').innerHTML = dt.toFixed(0) + 's';
                            }
                            else {
                                $('SOG').innerHTML = '0';
                                $('COG').innerHTML = '0';
                                $('DOG').innerHTML = '0';
                                $('dt').innerHTML = '0';
                            } 
                            
                            $('position').innerHTML = formatPos(parseFloat(gps[3])) + ',' + formatPos(parseFloat(gps[4])); 
                            $('positionTime').innerHTML = '@ ' + tstr.replace('T', ' ');
                            $('RH').innerHTML = colons[15];
                            $('intP').innerHTML = colons[14];
                            $('volts').innerHTML = colons[12];
                            $('pitch').innerHTML = colons[10];
                            $('depth').innerHTML = colons[11];
                            $('dive').innerHTML = colons[0];
                            $('cycle').innerHTML = colons[1];
                            $('call').innerHTML = colons[2];
                        }    
                    }
                    else if (d.includes('Connected at')) {
                        if (!first) beep();
                        pieces = d.split(' ');
                        if (pieces.length == 8) {
                            yr = pieces[7];
                            mo = months[pieces[3]];
                            da = parseInt(pieces[4]);
                            hr = parseInt(pieces[5].split(':')[0]);
                            mi = parseInt(pieces[5].split(':')[1]);
                            se = parseInt(pieces[5].split(':')[2]);
                            tstr = yr + '-' + mo.zeroPad() + '-' + da.zeroPad()
                                   + 'T' + hr.zeroPad() + ':' + mi.zeroPad() + ':' + se.zeroPad() + '.000Z';
                            console.log(tstr);
                            if (pieces[6] == 'PST')
                                connect_t = Date.parse(tstr)/1000 + 8*3600;
                            else
                                connect_t = Date.parse(tstr)/1000 + 7*3600;
                            if (fixTimer == null) {
                                updateTimer();
                            }
                        }
                    }
                }
                console.log('last line=[' + lines.at(-1) + ']') 

                first = false;
                elt.scrollTop = elt.scrollHeight;
            }
            if (isBlurred && !isFlashing) {
                startFlash();
            }
        };
    }

    var currDive = -1;
    var maxDive = 10000; 
    var currElt = 'diveplot';
    var controlFileDive = {};

    function saveControl(force) {
        var json = {};
        var file = $('selectFile').value;

        json['force'] = force;
        json['file'] = file;
        json['contents'] = $(file).value; 

        fetch(`/save/${currGlider}/${file}`, 
        {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(json),
        })
        .then(res => res.text())
        .then(text => {
            alert(text);
        })
        .catch(error => {
            alert(error);
        });
    }

    function changeDirective(cmd) {
        var newCmd = '$' + cmd;
        console.log(newCmd + ' ' + cmd);
        $('cmdfile').value = $('cmdfile').value.replace('$GO', newCmd);
        $('cmdfile').value = $('cmdfile').value.replace('$QUIT', newCmd);
        $('cmdfile').value = $('cmdfile').value.replace('$RESUME', newCmd);
        $('cmdfile').value = $('cmdfile').value.replace('$EXIT_TO_MENU', newCmd);
    }

    function popupPlotly(dive, elt) {
        window.open('/div/' + currGlider + '/' + dive + '/' + elt, '_blank');
    }

    function popupSelftest() {
        window.open('/selftest/' + currGlider, currGlider + '-selftest');
    }

    function popupMap() {
        window.open('/map/' + currGlider, currGlider + '-map');
    }

    function showPlot(elt, plotly) {
        $('mainImage').removeAttribute('hidden');
        $('mainImage').src = '/png/' + currGlider + '/' + currDive + '/' + elt;
        $('mainTable').setAttribute('hidden', '');
        $('logDiv').setAttribute('hidden', '');
        $('plotlyDiv').setAttribute('hidden', '');
        $('logfileDiv').setAttribute('hidden', '');
        if (plotly) {
            $('mainImage').ondblclick = function() { popupPlotly(currDive, elt); }
            $('mainImage').oncontextmenu = function() { popupPlotly(currDive, elt); }
        }
        else {
            $('mainImage').ondblclick = null;
            $('mainImage').oncontextmenu = null;
        }
        currElt = elt;
    }

    function showMissionPlot(which, elt, plotly) {
        $('mainImage').removeAttribute('hidden');
        $('mainImage').src = '/' + which + '/' + currGlider + '/' + elt;
        $('mainTable').setAttribute('hidden', '');
        $('logDiv').setAttribute('hidden', '');
        $('plotlyDiv').setAttribute('hidden', '');
        $('logfileDiv').setAttribute('hidden', '');
        // $('mainImage').onclick = function() { popupPlotly(currDive, elt); }
        $('mainImage').ondblclick = null;
        currElt = elt;
    }

    function buildTable(glider) {
        var row, cell, text;
        var tbody = $('mainTable').getElementsByTagName('tbody')[0];
        const colors = ["#cccccc", "#eeeeee"];
        var i, c;
        var date;
        var course; 
        var dist;
        var n, e;
        console.log("building table");

        clearTable();

        fetch(`/db/${glider}`)
        .then(res => res.json())
        .then(data => {
            for (d of data) {
                row = tbody.insertRow(1);
                i = $('mainTable').rows.length % 2;
                row.style.backgroundColor = colors[i];
                cell = row.insertCell(0);
                cell.innerHTML = '<a href="#" onclick="loadPlots(' + d['dive'] + ', false);">' + d['dive'] + '</a>';
                cell.style.textAlign = 'left';
                // cell.appendChild(text);

                date = new Date(1000*(d['log_start'] + d['total_flight_time_s']));
                cell = row.insertCell(1); 
                text = document.createTextNode((date.getFullYear() - 2000) + '/' +
                                               (date.getMonth() + 1).zeroPad() + '/' + 
                                               date.getDate().zeroPad() + ' ' + 
                                               date.getHours().zeroPad() + ':' + 
                                               date.getMinutes().zeroPad());
                cell.appendChild(text);

                cell = row.insertCell(2); 
                text = document.createTextNode('' + (d['total_flight_time_s']/60).toFixed(0));
                cell.appendChild(text);

                cell = row.insertCell(3);
                text = document.createTextNode('' + d['max_depth'].toFixed(0) + '(' + d['log_D_TGT'] + ')');
                cell.appendChild(text);

                dist = Math.sqrt(d['GPS_north_displacement_m']*d['GPS_north_displacement_m'] 
                                 + d['GPS_east_displacement_m']*d['GPS_east_displacement_m']);
                course = Math.atan2(d['GPS_east_displacement_m'], d['GPS_north_displacement_m'])*180.0/Math.PI;
                if (course < 0) {
                    course = course + 360;
                }
                cell = row.insertCell(4);
                text = document.createTextNode('' + (dist/1000).toFixed(2));
                cell.appendChild(text);

                cell = row.insertCell(5);
                text = document.createTextNode('' + course.toFixed(1));
                cell.appendChild(text);

                n = d['flight_avg_speed_north'] * d['total_flight_time_s'];
                e = d['flight_avg_speed_east'] * d['total_flight_time_s'];
                dist = Math.sqrt(n*n + e*e);
                course = Math.atan2(e, n)*180.0/Math.PI;
                if (course < 0) {
                    course = course + 360;
                }
                cell = row.insertCell(6);
                text = document.createTextNode('' + (dist/1000).toFixed(2));
                cell.appendChild(text);

                cell = row.insertCell(7);
                text = document.createTextNode('' + course.toFixed(1));
                cell.appendChild(text);

                cell = row.insertCell(8);
                text = document.createTextNode('' + (d['meters_to_target']/1000).toFixed(2));
                cell.appendChild(text);

                cell = row.insertCell(9);
                text = document.createTextNode('' + (d['mag_heading_to_target'] + d['magnetic_variation']).toFixed(1));
                cell.appendChild(text);

                
                dist = Math.sqrt(d['depth_avg_curr_east']*d['depth_avg_curr_east'] 
                                 + d['depth_avg_curr_north']*d['depth_avg_curr_north']);
                course = Math.atan2(d['depth_avg_curr_east'], d['depth_avg_curr_north'])*180.0/Math.PI;
                if (course < 0) {
                    course = course + 360;
                }

                cell = row.insertCell(10);
                text = document.createTextNode('' + (dist*100.0).toFixed(1));
                cell.appendChild(text);

                cell = row.insertCell(11);
                text = document.createTextNode('' + course.toFixed(1));
                cell.appendChild(text);

                cell = row.insertCell(12);
                text = document.createTextNode('' + d['log_TEMP'].toFixed(2));
                cell.appendChild(text);
                cell = row.insertCell(13);
                text = document.createTextNode('' + d['log_HUMID'].toFixed(2));
                cell.appendChild(text);
                cell = row.insertCell(14);
                text = document.createTextNode('' + d['log_INTERNAL_PRESSURE'].toFixed(2));
                cell.appendChild(text);

                cell = row.insertCell(15);
                text = document.createTextNode('' + d['volts_10V'].toFixed(2));
                cell.appendChild(text);
                cell = row.insertCell(16);
                text = document.createTextNode('' + (d['capacity_10V']*100).toFixed(2));
                cell.appendChild(text);
                cell = row.insertCell(17);
                text = document.createTextNode('' + d['volts_24V'].toFixed(2));
                cell.appendChild(text);
                cell = row.insertCell(18);
                text = document.createTextNode('' + (d['capacity_24V']*100).toFixed(2));
                cell.appendChild(text);
            }
        })
        .catch(error => {
            console.log(error);
        });
    }

    function showTable() {
        $('mainImage').setAttribute('hidden', '');
        $('logDiv').setAttribute('hidden', '');
        $('plotlyDiv').setAttribute('hidden', '');
        $('logfileDiv').setAttribute('hidden', '');
        $('mainTable').removeAttribute('hidden');
    }

    function showPlotly() {
        $('mainImage').setAttribute('hidden', '');
        $('logDiv').setAttribute('hidden', '');
        $('mainTable').setAttribute('hidden', '');
        $('logfileDiv').setAttribute('hidden', '');
        $('plotlyDiv').removeAttribute('hidden');
    }

    function showLog() {
        $('mainImage').setAttribute('hidden', '');
        $('mainTable').setAttribute('hidden', '');
        $('plotlyDiv').setAttribute('hidden', '');
        $('logfileDiv').setAttribute('hidden', '');
        $('logDiv').removeAttribute('hidden');
        currElt = 'logfile';
    }

    function showLogFile() {
        $('mainImage').setAttribute('hidden', '');
        $('mainTable').setAttribute('hidden', '');
        $('plotlyDiv').setAttribute('hidden', '');
        $('logDiv').setAttribute('hidden', '');
        $('logfileDiv').removeAttribute('hidden');
        currElt = 'logfileRaw';
    }

    function loadControlFile(file, dive) {
        fetch(`/control/${currGlider}/${file}`)
        .then(res => res.json())
        .then(data => {
            if ('file' in data && data['file'] == file) {
                $(file).value = data['contents'];
            }
            if ('dive' in data && data['dive'] > -1) {
                controlFileDive[file] = data['dive'];
            }
        })
        .catch(error => {
            console.log(`${dive}-${file}-${error}`);
        })
    }

    function loadStatus(glider, dive) {
        fetch(`/status/${glider}`)
        .then(res => res.json())
        .then(data => {
            document.title = data['glider'];
            currTitle = data['glider'];
            if (dive == -1 && parseInt(data['dive']) != currDive) {
                currDive = maxDive = parseInt(data['dive']);
                loadPlots(currDive, true);
                // loadLog(currDive);
            }
            else if (dive > 0 && dive < parseInt(data['dive'])) {
                maxDive = parseInt(data['dive']);
                currDive = dive;
                loadPlots(currDive, true);
                // loadLog(currDive);
            }
            engplots = data['engplots'];
            sgplots = data['sgplots'];
            buildTable(glider);
        })
        .catch(error => {
            console.log(error);
        });

        setupStream(glider);
    }

    function clearPlots() {
        while($('bottom').firstChild) {
            $('bottom').removeChild($('bottom').firstChild);
        }
    }

    function clearTable() {
        while($('mainTable').rows.length > 1) {
            $('mainTable').deleteRow(1);
        }
    }

    function addPlot(p, x, plotly) {
        img = document.createElement('img');
        img.src = '/png/' + currGlider + '/' + currDive + '/' + p;
        img.style = "position: absolute; left: " + x + "; top: 0; width:180px; heigh:169px;"
        img.onclick = function() { showPlot(p, plotly); };
        img.title = p;
        $('bottom').appendChild(img);
    }

    function addMissionPlot(which, p, x, plotly) {
        img = document.createElement('img');
        img.src = '/' + which + '/' + currGlider + '/' + p;
        img.style = "position: absolute; left: " + x + "; top: 0; width:180px; heigh:169px;"
        img.onclick = function() { showMissionPlot(which, p, plotly); };
        img.title = p;
        $('bottom').appendChild(img);
    }

    function loadLog(dive) {
        fetch(`/log/${currGlider}/${dive}`)
        .then(res => res.text())
        .then(data => {
            $('logDiv').innerHTML = 'Dive ' + dive + '<br>';
            $('logDiv').innerHTML += data;
        })
        .catch(error => {
            consoloe.log(`loadLog - ${error}`);
        });
    }

    function loadLogFile(dive) {
        fetch(`/logfile/${currGlider}/${dive}`)
        .then(res => res.text())
        .then(data => {
            $('logfileDiv').innerHTML = '<pre>' + data + '</pre>';
        })
        .catch(error => {
            consoloe.log(`loadLogFile - ${error}`);
        });
    }
    
    function jumpScroll(n) {
        $('bottom').scrollTo(200*n, 0, 'smooth');
        console.log('scrolling to ' + 200*n);
        return false;
    }

    function loadPlots(dive, setCurr) {
        var plots;
        var img;
        var x = 0;
        var idx;
        var cookie;
        var priority;
        var first = false;
        const stockPriority = ["diveplot", "ctd", "ts", "vert_vel", "pitch", "roll", "roll_rate", "cog", "ctw", 
                               "wlbb2fl_Chlorophyll_fluorescence", "wlbb2fl_backscatter", "aa4831"];
       
        const subs = { "wlbb2fl_Chlorophyll_fluorescence": "Chlorophyll",
                       "wlbb2fl_backscatter": "backscatter", "ts": "T-S" };

        cookie = readCookie("order");
        if (cookie != null) 
            priority = cookie.split(",");
        else
            priority = stockPriority;

        currDive = dive; // inside the then or before plots might be actually loaded?

        loadLog(dive);
        loadLogFile(dive);

        fetch(`/plots/${currGlider}/${dive}`)
        .then(res => res.json())
        .then(resp => {
            var links = [];
            clearPlots();
            var plots = resp['dvplots'];
            var plotly = resp['plotlyplots'];
            // var engplots = resp['engplots'];

            var ab = plots.indexOf('ab');
            if (ab > -1 && !priority.includes('ab')) {
                plots.splice(ab, 1);
            }

            for (p of priority) {
                if (plots.includes(p)) {
                    addPlot(p, x, plotly.includes(p));
                    x += 200;
                    idx = plots.indexOf(p);
                    plots.splice(idx, 1); 
                    links.push(p in subs ? subs[p] : p);

                    if (!first && setCurr) {
                        first = true;
                        currElt = p;
                    } 
                }
            }
            plots.sort();
            for (p of plots) {
                addPlot(p, x, plotly.includes(p));
                links.push(p in subs ? subs[p] : p);
                x += 200;

                if (!first && setCurr) {
                    first = true;
                    currElt = p;
                } 
            }


            if (ab > -1 && !priority.includes('ab')) {
                addPlot('ab', x, false);
                links.push('ab' in subs ? subs['ab'] : 'ab');
                x += 200;
            }

            links.push('eng');

            engplots.sort();
            for (p of engplots) {
                addMissionPlot('eng', p, x, false);
                links.push(p in subs ? subs[p] : p);
                x += 200;

                if (!first && setCurr) {
                    first = true;
                    currElt = p;
                } 
            }

            links.push('sg');
            sgplots.sort();
            for (p of sgplots) {
                addMissionPlot('section', p, x, false);
                links.push(p in subs ? subs[p] : p);
                x += 200;

                if (!first && setCurr) {
                    first = true;
                    currElt = p;
                } 
            }

            if (currElt == 'logfile') 
                showLog(); 
            else if (currElt == 'logfileRaw')
                showLogFile();
            else if (engplots.includes(currElt))
                showMissionPlot('eng', currElt, plotly.includes(currElt));
            else if (sgplots.includes(currElt))
                showMissionPlot('section', currElt, plotly.includes(currElt));
            else 
                showPlot(currElt, plotly.includes(currElt));

            // $('mainImage').src = '/png/' + currGlider + '/' + dive + '/diveplot';
            // $('mainImage').removeAttribute('hidden'); 
            // $('mainTable').setAttribute('hidden', ''); 


            var n = links.length - 1;
            var e = links.indexOf('eng');
            var ab = links.indexOf('ab');
            var mn = ab > -1 ? ab - 1 : e - 1;
            var all;
 
            links.splice(e, 1); 

            var sec = links.indexOf('sg');

            var j;
            $('bottomLinks').innerHTML = '';
            for (var i = 0 ; i < mn ; i += 5) {
                if (i + 4 < mn)
                    j = i+4;
                else
                    j = mn;

                all = links.slice(i,j+1).join(', ');
                $('bottomLinks').innerHTML += '<span class="spanClick" onclick="jumpScroll(' + i + ');" title="' + all +'">' + links[i] + '&hellip;' + links[j] + '</span> * '; 
            }
            if (ab > -1) //  && links[j] != 'ab')
                $('bottomLinks').innerHTML += '<span class="spanClick" onclick="jumpScroll(' + ab + ');">ab</span> * ';

            all = links.slice(e,sec).join(', ');
            $('bottomLinks').innerHTML += '<span class="spanClick" onclick="jumpScroll(' + e + ');" title="' + all +'">eng</span> * ';

            links.splice(sec, 1); 

            all = links.slice(sec).join(', ');
            $('bottomLinks').innerHTML += '<span class="spanClick" onclick="jumpScroll(' + sec + ');" title="' + all +'">sections</span>';
        })
        .catch(error => {
            console.log(`loadPlots - ${error}`);
        });
    }
   
    function changeDive(dir) {
        var c = currDive;

        currDive += dir;
        if (currDive > maxDive)
            currDive = maxDive;
        else if (currDive < 1)
            currDive = 1;

        if (currDive != c) {
            loadPlots(currDive, false);
            // loadLog(currDive);
        }
    }
      
    function getSelectionText() {
        var text = "";
        var activeEl = document.activeElement;
        var activeElTagName = activeEl ? activeEl.tagName.toLowerCase() : null;
        if (
          (activeElTagName == "textarea") || (activeElTagName == "input" &&
          /^(?:text|search|password|tel|url)$/i.test(activeEl.type)) &&
          (typeof activeEl.selectionStart == "number")
        ) {
            text = activeEl.value.slice(activeEl.selectionStart, activeEl.selectionEnd);
        } else if (window.getSelection) {
            text = window.getSelection().toString();
        }
        return text;
    } 

    function parameterHelp(which) {
        var str = false;

        if (which == 'cmdfile') {
            var s = $(which).selectionStart;
            var e = $(which).selectionEnd;
            var v = $(which).value;

            if (v[s-1] == '$' && v[e] == ',') {
                str = v.substring(s, e);
            }
        }
        else if (which == 'logfile') {
            var v = window.getSelection().toString();
            var h = $('logfileDiv').innerHTML;
            var i = h.indexOf(v);
            if (i > 0 && h[i-1] == '$' && h[i + v.length] == ',') {
                str = v;
            }
        }
            
        if (str) {
            window.open('/parms#' + str, 'parms');
        }
    }

    const knownFiles = ["cmdfile", "targets", "science", "scicon.sch", "pdoscmds.bat", "tcm2mat.cal", "sg_calib_constants.m"];
    const cmdfileButtons = ['btnGO', 'btnQUIT', 'btnRESUME'];
    function changeFile() {
        var file = $('selectFile').value;
        for (var f of knownFiles) {
            if (f == file)
                $(f).removeAttribute('hidden');
            else
                $(f).setAttribute('hidden', '');
        }

        for (var b of cmdfileButtons) {
            if (file != "cmdfile") 
                $(b).setAttribute('hidden', '');
            else 
                $(b).removeAttribute('hidden');
        }

        if (file in controlFileDive) {
            $('fileDive').innerHTML = '(' + controlFileDive[file] + ')';
            $('fileDive').removeAttribute('hidden');
        }
        else {
            $('fileDive').setAttribute('hidden', '');
            $('fileDive').innerHTML = '';
        }
    }

    function doPlotlyProfiles(which) {
        let x = $('selPlotlyContour').value;
        var stride = $('selPlotlyProfileStride').value;
        var zStride = $('selPlotlyZStride').value;
    
        $('btnPlotlyContour').disabled = true;
        var def  = $('btnPlotlyContour').style.backgroundColor;
        $('btnPlotlyContour').style.backgroundColor = 'yellow';

        console.log(Date.now());
        fetch(`/pro/${currGlider}/${x}/0/-1/${stride}/${zStride}`)
        .then(res => res.text())
        .then(data => {
            data = data.replaceAll('NaN', 'null');
            data = JSON.parse(data);
            // console.log(data[x]);
            if (which == 'contour') {
                var d = [{
                    z: data[x],
                    y: data['depth'],
                    type: 'contour',
                    /// xaxis: 'profile',
                    // yaxis: 'depth',
                    connectgaps: true,
                    contours: {
                        coloring: 'heatmap',
                        showlabels: true,
                        labelfont: {
                            family: 'Raleway',
                            size: 12,
                            color: 'white',
                        },
                    }, 
                }];
                var layout = { 
                                font:       {size: 12},
                                margin: { t:20, l:80, r:80, b:80 },
                                xaxis: { title: 'profile/' + stride },
                                yaxis: { title: 'depth', autorange: 'reversed' },
                                plot_bgcolor: "#cccccc",
                             };
                var config = { responsive: true };
                
                Plotly.newPlot($('plotlyPlotDiv'), d, layout, config);
                console.log(Date.now());
                $('btnPlotlyContour').style.backgroundColor = def;
                $('btnPlotlyContour').disabled = false;
            }
            else if (which == 'profiles') {
            }
        })
        .catch(error => {
            console.log('plotly ' + error);
        })
    }

    function doPlotlyPlot(which) {
        let x = $('selPlotlyX').value;
        // let y = $('selPlotlyY').value;
        let y = [...$('selPlotlyY').selectedOptions].map(option => option.value);
        
        fetch(`/query/${currGlider}/${x},${y.join(',')}`)
        .then(res => res.json())
        .then(data => {
            if (which == 'plot') {
                var d = [];
                var xd = data.map(v => v[x]);
                for (var i = 0 ; i < y.length ; i++) {
                    var yd = data.map(v => v[y[i]]);
                    d.push({
                            x: xd,
                            y: yd,
                            mode: x == "dive" ? "lines" : "markers",
                            type: "scatter",
                            name: y[i]
                           });
                }
                var layout = { 
                                font:       {size: 12},
                                margin: { t:20, l:80, r:80, b:80 },
                                xaxis: { title: x },
                                yaxis: { title: y[0] },
                                plot_bgcolor: "#cccccc",
                             };
                var config = { responsive: true };
                Plotly.newPlot($('plotlyPlotDiv'), d, layout, config);
            }
            else if (which == 'table') {
                var values = [];
                var headers = [];
                values.push(data.map(v => v[x]));
                headers.push([x]);
                for (var i = 0 ; i < y.length ; i++) {
                    values.push(data.map(v => v[y[i]]));
                    headers.push([y[i]]);
                }

                console.log(headers);
 
                var d = [{
                    type: 'table',
                    header: {
                        values: headers,
                        align: 'center',
                        line: { width: 1, color: 'black' },
                        fill: { color: "#aaaaaa" },
                        font: {family: "Arial", size: 12, color: "white"}

                    },
                    cells: {
                        values: values,
                        align: "center",
                        fill: { color: "#eeeeee" } ,
                        line: {color: "#cccccc", width: 1},
                        font: {family: "Arial", size: 11, color: ["black"]}
                    },
                }];
                Plotly.newPlot($('plotlyPlotDiv'), d);
            }
        })
        .catch(error => {
            console.log('plotly ' + error);
        })
    }

    function loadPlotlyControlsContour(glider) {
        fetch(`/provars/${glider}`)
        .then(res => res.json())
        .then(data => {
            names = data['names'].sort();

            for (n of names) {
                let optX = document.createElement('option');
                optX.value = n;
                optX.innerHTML = n;
                let optY = document.createElement('option');
                $('selPlotlyContour').appendChild(optX);
            }
        })
        .catch(error => {
            console.log('provars ' + error);
        });

    }
    function loadPlotlyControlsXY(glider) {
        fetch(`/dbvars/${glider}`)
        .then(res => res.json())
        .then(data => {
            names = data['names'].sort();
            dv = names.indexOf('dive');
            names.splice(names.indexOf('dive'), 1);
            names = ['dive'].concat(names);

            for (n of names) {
                let optX = document.createElement('option');
                optX.value = n;
                optX.innerHTML = n;
                let optY = document.createElement('option');
                optY.value = n;
                optY.innerHTML = n;
 
                $('selPlotlyX').appendChild(optX);
                $('selPlotlyY').appendChild(optY);
            }
        })
        .catch(error => {
            console.log('dbvars ' + error);
        });

    }
 
    function init() {
        let path = window.location.pathname.substring(1).split('/');
        let glider = -1;
        let dive = -1;

        if (path.length >= 1) {
            glider = path[0];
            console.log(glider);
        }
        if (path.length == 2 && parseInt(path[1]) > 0) {
            dive = parseInt(path[1]);
            console.log(dive);
        }
        if (path.length == 3 && path[1] == 'order') {
            createCookie("order", path[2], 180);
        }

        if (glider == -1) {
            alert('invalid request - specify glider');
            console.log('invalid request - specify glider');
            return;
        }

        if (path.length > 1) {
            window.history.replaceState('object or string', 'Title', `/${glider}`);
        }

        currGlider = glider;
        console.log(glider);
        window.name = glider;
        loadStatus(glider, dive);
        loadControlFile('cmdfile');
        loadControlFile('science');
        loadControlFile('targets');
        loadControlFile('scicon.sch');
        loadControlFile('tcm2mat.cal');
        loadControlFile('pdoscmds.bat');
        loadControlFile('sg_calib_constants.m');
        loadPlotlyControlsXY(glider);
        loadPlotlyControlsContour(glider);
    }

</script>

<html>
<body onload="init();" style="font-family: verdana, arial, tahoma, 'sans serif'; font-size: 12px;">
<div style="position: relative;">

<div id="main" style="position: absolute; left: 0; top: 0; width:1058px; height:894px; overflow:auto;">
    <img id="mainImage">
    <table rules="groups" id="mainTable" hidden="hidden" style="height:894px; width:1040px; font-size:14px; text-align:right; font-family:verdana, arial, tahoma, 'sans serif';"> 

        <colgroup span=4><col><col><col><col></colgroup>
        <colgroup span=6><col><col><col><col><col><col></colgroup>
        <colgroup span=2><col><col></colgroup>
        <colgroup span=3><col><col><col></colgroup>
        <colgroup span=4><col><col><col><col></colgroup>
        <tbody style="height:894px; width:1040px; overflow-y:auto;"> <!-- display:block"> -->
            <tr bgcolor="#aaaaaa" align="center">
                <th>dive</th>
                <th>end</th>
                <th>length</th>
                <th>depth</th>
                <th>dog</th>
                <th>cog</th>
                <th>dtw</th>
                <th>ctw</th>
                <th>dtg</th>
                <th>ctg</th>
                <th>Umag</th>
                <th>Udir</th>
                <th>temp</th>
                <th>RH</th>
                <th>int P</th>
                <th>volts10</th>
                <th>% cap</th>
                <th>volts24</th>
                <th>% cap</th>
            </tr>
        </tbody>
    </table>

    <div id="logDiv" hidden="hidden"></div>

    
    <div id="plotlyDiv" hidden="hidden">
        <div id="plotyConfigDiv">
            <span style="vertical-align:top;">X:</span><select id="selPlotlyX" style="vertical-align:top;"></select> 
            <span style="vertical-align:top;">Y:</span><select id="selPlotlyY" multiple size="4"> </select>
            <button id="btnPlotlyPlot" style="vertical-align:top;" onclick="doPlotlyPlot('plot');">plot</button>
            <button id="btnPlotlyTable" style="vertical-align:top;" onclick="doPlotlyPlot('table');">table</button>
            
            <div style="float:right;">
                <span style="vertical-align:top;">contour:</span><select id="selPlotlyContour" style="vertical-align:top;"> </select>
                <button id="btnPlotlyContour" style="vertical-align:top;" onclick="doPlotlyProfiles('contour');">contour</button><br>
                <span style="vertical-align:top;">profile stride</span>
                <select style="vertical-align:top;" id="selPlotlyProfileStride">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5" selected>5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                </select>
                <span style="vertical-align:top;">bin stride</span>
                <select style="vertical-align:top;" id="selPlotlyZStride">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5" selected>5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                </select>
            </div>
        </div>
        <div id="plotlyPlotDiv" style="height:90%;">
        </div>
    </div>

    <div id="logfileDiv" hidden="hidden" ondblclick="parameterHelp('logfile');" title="double click parameter for help" style="background-color:#dddddd;">
    </div>
</div>

<div id="links" style="position: absolute; left:1060; top: 0; width:600; height:20; font-size:10px;">
    <a href="#" onclick="popupSelftest();">selftest</a> *
    <a href="#" onclick="popupMap();">map</a>
</div>

<div id="commlog" style="position: absolute; left:1060; top:20; width:640; height:400; overflow:auto; font-size: 10px; box-sizing:border-box; border:1px solid black; white-space:pre;">

</div>

<div id="status" style="position: absolute; left:1060; top:430; width:640; height:230; overflow:auto; font-size: 10px; box-sizing:border-box; border:1px solid black;">
    <div id="position" style="font-weight: bold; font-size: 4vmin; padding-left: 2vmin; padding-top: 1px; padding-bottom: 1px">
    </div>
    <div id="positionTime" style="font-weight: bold; font-size: 1.5vmin; padding-left: 2vmin; padding-top: 1px; padding-bottom: 2px">
    </div>
    <table style="table-layout:fixed; width: 600px;">
        <col style="width:60px;">
        <col style="width:140px;">
        <col style="width:60px;">
        <col style="width:140px;">
        <col style="width:60px;">
        <col style="width:140px;">
        <tr>
            <td>SOG</td><td id="SOG"></td>
            <td>COG</td><td id="COG"></td>
            <td>last fix</td><td id="lastFix"></td>
        </tr>
        <tr>
            <td>DOG</td><td id="DOG"></td>
            <td>&Delta;t</td><td id="dt"></td>
            <td>last call</td><td id="lastConnect"></td>
        </tr>
        <tr>
            <td>pitch</td><td id="pitch"></td>
            <td>volts</td><td id="volts"></td>
        </tr>
        <tr>
            <td>depth</td><td id="depth"></td>
            <td>dive</td><td id="dive"></td>
        </tr>
        <tr>
            <td>RH</td><td id="RH"></td>
            <td>cycle</td><td id="cycle"></td>
        </tr>
        <tr>
            <td>int P</td><td id="intP"></td>
            <td>call</td><td id="call"></td>
        </tr>
    </table>
</div>

<div id="divCmdfile" style="position: absolute; left:1060; top:670; width:640px; height:380px; font-size: 12px;">
    <textarea id="cmdfile" style="width:100%; height:100%; box-sizing:border-box;" ondblclick="parameterHelp('cmdfile');">
    </textarea>
    <textarea id="targets" style="width:100%; height:100%; box-sizing:border-box;" hidden="hidden"></textarea>
    <textarea id="science" style="width:100%; height:100%; box-sizing:border-box;" hidden="hidden"></textarea>
    <textarea id="scicon.sch" style="width:100%; height:100%; box-sizing:border-box;" hidden="hidden"></textarea>
    <textarea id="pdoscmds.bat" style="width:100%; height:100%; box-sizing:border-box;" hidden="hidden"></textarea>
    <textarea id="tcm2mat.cal" style="width:100%; height:100%; box-sizing:border-box;" hidden="hidden"></textarea>
    <textarea id="sg_calib_constants.m" style="width:100%; height:100%; box-sizing:border-box;" hidden="hidden"></textarea>
    <button id="btnSave" type="button" onclick="saveControl(0);">Save</button>
    <button id="btnForce" type="button" onclick="saveControl(1);">Force</button>
    <button id="btnGO" type="button" onclick="changeDirective('GO');" style="background-color:#00aa00;">GO</button>
    <button id="btnQUIT" type="button" onclick="changeDirective('QUIT');" style="background-color:#ff0020;">QUIT</button>
    <button id="btnRESUME" type="button" onclick="changeDirective('RESUME');" style="background-color:yellow;">RESUME</button>
    <select id="selectFile" onchange="changeFile()">
        <option value="cmdfile" selected>cmdfile</option>
        <option value="targets">targets</option>
        <option value="science">science</option>
        <option value="scicon.sch">scicon.sch</option>
        <option value="pdoscmds.bat">pdoscmds.bat</option>
        <option value="tcm2mat.cal">tcm2mat.cal</option>
        <option value="sg_calib_constants.m">sg_calib_constants.m</option>
    </select>
    <span id="fileDive" hidden="hidden"></span>
</div>

<div id="bottomButtons" style="position: absolute; left: 0; top: 900; width: 82; height: 180; overflow: hidden;">
    <span style="float: right;">
        <a href="#" onclick="showPlotly();" title="plot and table tool">tool</a> *
        <a href="#" onclick="showLog();" title="log file">log</a> *
        <a href="#" onclick="showLogFile();" title="raw log file">file</a>
    </span> <br> 
    <button id="btnUp" type="button" onclick="changeDive(1);" style="font-size: 18px; width:80px;" title="next dive">&#x2191</button><br><br>
    <button id="btnTable" type="button" onclick="showTable();" style="font-size: 48px; width:80px;" title="dives table">&#x2637</button><br><br>
    <button id="btnDown" type="button" onclick="changeDive(-1);" style="font-size: 18px; width:80px;" title="prev dive">&#x2193</button>
</div>

<div id="bottomBox" style="position: absolute; left: 82; top: 900; width: 978; height: 200; overflow: hidden;">
    <div id="bottomLinks" style="position: absolute; left: 10; top: 0; width: 978; height: 20; overflow: hidden;">
        
    </div>
    <div id="bottom" style="position: absolute; left: 0; top: 20; width: 978; height: 180; overflow: auto;">

    </div>
</div>

</div>
</body>


</html>
