<style>
    a:link    {color:#0000ff; text-decoration:none}
    a:visited {color:#0000ff; text-decoration:none}
    a:hover   {color:#ff0000; text-decoration:underline}
    a:active  {color:#ff0000; text-decoration:underline}
</style>

<script>

    function beep() {
        var snd = new Audio("data:audio/wav;base64,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qJrx4KOQjahZxWbcZgztj2c49nKmkId44S71j0c8eV9yDK6uPRzx5X18eDvjvQ6yKo9ZSS6l//8elePK/Lf//IInrOF/FvDoADYAGBMGb7FtErm5MXMlmPAJQVgWta7Zx2go+8xJ0UiCb8LHHdftWyLJE0QIAIsI+UbXu67dZMjmgDGCGl1H+vpF4NSDckSIkk7Vd+sxEhBQMRU8j/12UIRhzSaUdQ+rQU5kGeFxm+hb1oh6pWWmv3uvmReDl0UnvtapVaIzo1jZbf/pD6ElLqSX+rUmOQNpJFa/r+sa4e/pBlAABoAAAAA3CUgShLdGIxsY7AUABPRrgCABdDuQ5GC7DqPQCgbbJUAoRSUj+NIEig0YfyWUho1VBBBA//uQZB4ABZx5zfMakeAAAAmwAAAAF5F3P0w9GtAAACfAAAAAwLhMDmAYWMgVEG1U0FIGCBgXBXAtfMH10000EEEEEECUBYln03TTTdNBDZopopYvrTTdNa325mImNg3TTPV9q3pmY0xoO6bv3r00y+IDGid/9aaaZTGMuj9mpu9Mpio1dXrr5HERTZSmqU36A3CumzN/9Robv/Xx4v9ijkSRSNLQhAWumap82WRSBUqXStV/YcS+XVLnSS+WLDroqArFkMEsAS+eWmrUzrO0oEmE40RlMZ5+ODIkAyKAGUwZ3mVKmcamcJnMW26MRPgUw6j+LkhyHGVGYjSUUKNpuJUQoOIAyDvEyG8S5yfK6dhZc0Tx1KI/gviKL6qvvFs1+bWtaz58uUNnryq6kt5RzOCkPWlVqVX2a/EEBUdU1KrXLf40GoiiFXK///qpoiDXrOgqDR38JB0bw7SoL+ZB9o1RCkQjQ2CBYZKd/+VJxZRRZlqSkKiws0WFxUyCwsKiMy7hUVFhIaCrNQsKkTIsLivwKKigsj8XYlwt/WKi2N4d//uQRCSAAjURNIHpMZBGYiaQPSYyAAABLAAAAAAAACWAAAAApUF/Mg+0aohSIRobBAsMlO//Kk4soosy1JSFRYWaLC4qZBYWFRGZdwqKiwkNBVmoWFSJkWFxX4FFRQWR+LsS4W/rFRb/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////VEFHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAU291bmRib3kuZGUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMjAwNGh0dHA6Ly93d3cuc291bmRib3kuZGUAAAAAAAAAACU=");  
        snd.play();
    }

    function $(x) {
        return document.getElementById(x)
    }

    Number.prototype.zeroPad = function() {
        return ('0'+this).slice(-2);
    }

   function bearing(pt1, pt2) {
        var lat2 = pt2.lat*Math.PI/180;
        var lat1 = pt1.lat*Math.PI/180;
        var dLat = (lat2 - lat1);
        var dLon = (pt2.lon-pt1.lon)*Math.PI/180;
        var y = Math.sin(dLon) * Math.cos(lat2);
        var x = Math.cos(lat1)*Math.sin(lat2) -
                Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
        var brng = (Math.atan2(y, x)*180/Math.PI + 360) % 360;

        return brng;
    }

    function haversine(pt0, pt1) {
        var lat0, lon0, lat1, lon1;
        var sdlat_2, sdlon_2;
        var a;
        const R = 6378137.0;
        const DTR = 1.745329251994330e-02;

        lat0 = pt0.lat*DTR;
        lat1 = pt1.lat*DTR;
        lon0 = pt0.lon*DTR;
        lon1 = pt1.lon*DTR;

        sdlat_2 = Math.sin(0.5*(lat0 - lat1));
        sdlon_2 = Math.sin(0.5*(lon0 - lon1));

        a = sdlat_2*sdlat_2 + Math.cos(lat0)*Math.cos(lat1)*sdlon_2*sdlon_2;
        if (a >= 1 || a <= 0) {
            return 0;
        }

        return 2.0*R*Math.asin(Math.sqrt(a));
    }

    function formatPos(ddmm) {
        var deg = Math.trunc(ddmm/100);
        var min = Math.abs(ddmm - deg*100);
        var zero = min < 10 ? '0' : '';
        return (deg + '&deg;' + zero + min.toFixed(3) + '&prime;');
    }

    function ddmm2dd(ddmm) {
        var deg = Math.trunc(ddmm/100);
        var min = ddmm - deg*100;

        return deg + min/60;
    }

    var blurTimer  = false;
    var isBlurred  = false;
    var isFlashing =false;
    var currTitle  = "";

    var currGlider = '';

    var engplots;

    var fixes = [];
    var connect_t = 0;

    var fixTimer = null;

    function startFlash() {
        isFlashing = true;
        blurTimer = window.setInterval(function() 
            {
                document.title = document.title == currTitle ? currTitle + "..." : currTitle;
            }, 1000);
    }
 
    window.onblur=function() {
        isBlurred = true;
    }

    window.onfocus=function() { 
        isBlurred = false;
        isFlashing = false;
        document.title = currTitle;
        if (blurTimer) {
            clearInterval(blurTimer);
        }
        blurTimer = false;
    }

    function updateTimer() {
        if (fixes.length > 0) {
            $('lastFix').innerHTML = '' + (Date.now()/1000 - fixes.at(-1).t).toFixed(0) + 's';
        }
        if (connect_t > 0) {
            $('lastConnect').innerHTML = '' + (Date.now()/1000 - connect_t).toFixed(0) + 's';
        }
        fixTimer = setTimeout('updateTimer()', 1000);
    }

    let wsocket  = null;
    var lastSetup = 0;
    var first = true;

    function setupStream(glider) {
        if (Date.now() < lastSetup + 5000) {
            setTimeout('setupStream(glider)', 5000);
            console.log('too soon');
            return;
        }
        lastSetup = Date.now();
 
        if (wsocket != null) {
            wsocket.close();
            console.log('closing previous stream');
        }
        console.log('setting up stream');
        var loc = window.location, new_uri;
        if (loc.protocol === "https:") 
            new_uri = "wss:";
        else
            new_uri = "ws:";

        new_uri += "//" + loc.host;
        new_uri += "/stream/" + glider;
        wsocket = new WebSocket(new_uri);

        wsocket.onerror = function(error) {
            console.log('stream error detected');
            wsocket.close();
            setupStream(glider);
        };

        wsocket.onclose = function(e) {
            if (e.wasClean) {
                console.log('stream closed cleanly');
            }
            else {
                console.log('connection died');
                setupStream(glider);
            }
        };

        var chunk = "";
        wsocket.onmessage = function(e) { 
            var pieces, content, data, i;
            var vals = {};
            var update;
            var newDive;
            var newCmdfile;
            var d, pieces, lines;
            var pt, fix;
            var yr, mo, da, hr, mi, se;
            var tstr;
            const months = {'Jan': 1, 'Feb': 2, 'Mar': 3, 'Apr': 4, 'May': 5, 'Jun':6, 'Jul':7, 'Aug':8, 'Sep':9, 'Oct':10, 'Nov':11, 'Dec':12};
            var styles = ["font-weight:bold;", "font-weight:bold; color:red;", "font-weight:bold; color:green;"]
            var bolds = {"targets":0, "science":0, "cmdfile":0, "pdoscmds.bat":0, "Connected":0, "QUIT":1, "RECOV_CODE":1, "GO":2};


            var line = e.data;
            if (line.startsWith('NEW=')) {
                console.log(line);
                newDive = parseInt(line.split('=')[1].slice(2,6));
                loadPlots(newDive);
                loadLog(newDive);
            }
            else if (line.startsWith('CMDFILE=')) {
                newCmdfile = line.split('=')[1];
                $('cmdfile').value = newCmdfile;
            }
            else {
                lines = line.split('\n');

                var elt = $('commlog');
                elt.scrollTop = elt.scrollHeight;
                for (b of Object.keys(bolds)) {
                    line = line.replaceAll(b, '<span style="' + styles[bolds[b]] + '">' + b + '</span>');
                } 


                elt.innerHTML += line;
                for (d of lines) {
                    if (d.includes('GPS')) {
                        pieces = d.split(' ');
                        if (pieces.length == 2) {
                            colons = pieces[0].split(':');
                            gps    = pieces[1].split(',');
                            da = parseInt(gps[1].substring(0,2))
                            mo = parseInt(gps[1].substring(2,4))
                            yr = 2000 + parseInt(gps[1].substring(4,6))
                            hr = parseInt(gps[2].substring(0,2))
                            mi = parseInt(gps[2].substring(2,4))
                            se = parseInt(gps[2].substring(4,6))
                            tstr = yr + '-' + mo.zeroPad() + '-' + da.zeroPad()
                                   + 'T' + hr.zeroPad() + ':' + mi.zeroPad() + ':' + se.zeroPad() + '.000Z';
                            
                            fix = { pt: { 
                                            lat: ddmm2dd(parseFloat(gps[3])),
                                            lon: ddmm2dd(parseFloat(gps[4]))
                                        },
                                
                                    t: Date.parse(tstr)/1000,
                                  };

                            if (fixes.length == 0 || fixes.at(-1).t < fix.t) {
                                console.log('pushing fix at ' + fix.t);
                                fixes.push(fix);
                            } 
                            if (fixTimer == null) {
                                updateTimer();
                            }
                            if (fixes.length >= 2) {
                                var sog, cog, dog, dt;
                                dt = fixes.at(-1).t - fixes.at(-2).t;
                                dog = haversine(fixes.at(-1).pt, fixes.at(-2).pt);
                                cog = bearing(fixes.at(-2).pt, fixes.at(-1).pt);
                                sog = dog/dt/0.514;
                                $('SOG').innerHTML = sog.toFixed(2) + 'kts';
                                $('COG').innerHTML = cog.toFixed(1) + '&deg;';
                                $('DOG').innerHTML = dog.toFixed(0) + 'm';
                                $('dt').innerHTML = dt.toFixed(0) + 's';
                            }
                            else {
                                $('SOG').innerHTML = '0';
                                $('COG').innerHTML = '0';
                                $('DOG').innerHTML = '0';
                                $('dt').innerHTML = '0';
                            } 
                            
                            $('position').innerHTML = formatPos(parseFloat(gps[3])) + ',' + formatPos(parseFloat(gps[4])); 
                            $('positionTime').innerHTML = '@ ' + tstr.replace('T', ' ');
                            $('RH').innerHTML = colons[15];
                            $('intP').innerHTML = colons[14];
                            $('volts').innerHTML = colons[12];
                            $('pitch').innerHTML = colons[10];
                            $('depth').innerHTML = colons[11];
                            $('dive').innerHTML = colons[0];
                            $('cycle').innerHTML = colons[1];
                            $('call').innerHTML = colons[2];
                        }    
                    }
                    else if (d.includes('Connected at')) {
                        if (!first) beep();
                        pieces = d.split(' ');
                        if (pieces.length == 8) {
                            yr = pieces[7];
                            mo = months[pieces[3]];
                            da = parseInt(pieces[4]);
                            hr = parseInt(pieces[5].split(':')[0]);
                            mi = parseInt(pieces[5].split(':')[1]);
                            se = parseInt(pieces[5].split(':')[2]);
                            tstr = yr + '-' + mo.zeroPad() + '-' + da.zeroPad()
                                   + 'T' + hr.zeroPad() + ':' + mi.zeroPad() + ':' + se.zeroPad() + '.000Z';
                            console.log(tstr);
                            if (pieces[6] == 'PST')
                                connect_t = Date.parse(tstr)/1000 + 8*3600;
                            else
                                connect_t = Date.parse(tstr)/1000 + 7*3600;
                            if (fixTimer == null) {
                                updateTimer();
                            }
                        }
                    }
                }
                console.log('last line=[' + lines.at(-1) + ']') 

                first = false;
            }
            if (isBlurred && !isFlashing) {
                startFlash();
            }
        };
    }

    var currDive = -1;
    var maxDive = 10000; 
    var currElt = 'diveplot';
    var controlFileDive = {};

    function saveControl(force) {
        var xhttp = new XMLHttpRequest();
        var json = {};
        var file = $('selectFile').value;

        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                alert(this.responseText);
            }
        }
        json['force'] = force;
        json['file'] = file;
        json['contents'] = $(file).value; 
        xhttp.open("POST", "/save/" + currGlider + "/" + file, true);
        xhttp.send(JSON.stringify(json));
    }

    function changeDirective(cmd) {
        var newCmd = '$' + cmd;
        console.log(newCmd + ' ' + cmd);
        $('cmdfile').value = $('cmdfile').value.replace('$GO', newCmd);
        $('cmdfile').value = $('cmdfile').value.replace('$QUIT', newCmd);
        $('cmdfile').value = $('cmdfile').value.replace('$RESUME', newCmd);
        $('cmdfile').value = $('cmdfile').value.replace('$EXIT_TO_MENU', newCmd);
    }

    function popupPlotly(dive, elt) {
        window.open('/div/' + currGlider + '/' + dive + '/' + elt, '_blank');
    }

    function popupSelftest() {
        window.open('/selftest/' + currGlider, currGlider + '-selftest');
    }

    function popupMap() {
        window.open('/map/' + currGlider, currGlider + '-map');
    }

    function showPlot(elt, plotly) {
        $('mainImage').removeAttribute('hidden');
        $('mainImage').src = '/png/' + currGlider + '/' + currDive + '/' + elt;
        $('mainTable').setAttribute('hidden', '');
        $('logDiv').setAttribute('hidden', '');
        if (plotly) {
            $('mainImage').ondblclick = function() { popupPlotly(currDive, elt); }
        }
        else {
            $('mainImage').ondblclick = null;
        }
        currElt = elt;
    }

    function showEng(elt, plotly) {
        $('mainImage').removeAttribute('hidden');
        $('mainImage').src = '/eng/' + currGlider + '/' + elt;
        $('mainTable').setAttribute('hidden', '');
        $('logDiv').setAttribute('hidden', '');
        // $('mainImage').onclick = function() { popupPlotly(currDive, elt); }
        $('mainImage').ondblclick = null;
        currElt = elt;
    }

    function buildTable() {
        var row, cell, text;
        var tbody = $('mainTable').getElementsByTagName('tbody')[0];
        var xhttp = new XMLHttpRequest();
        const colors = ["#cccccc", "#eeeeee"];
        var i, c;
        var date;
        var course; 
        var dist;
        var n, e;
        console.log("building table");
        clearTable();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                resp = JSON.parse(this.responseText);
                for (d of resp) {
                    row = tbody.insertRow(1);
                    i = $('mainTable').rows.length % 2;
                    row.style.backgroundColor = colors[i];
                    cell = row.insertCell(0);
                    cell.innerHTML = '<a href="#" onclick="loadPlots(' + d['dive'] + ');">' + d['dive'] + '</a>';
                    cell.style.textAlign = 'left';
                    // cell.appendChild(text);

                    date = new Date(1000*(d['log_start'] + d['total_flight_time_s']));
                    cell = row.insertCell(1); 
                    text = document.createTextNode((date.getFullYear() - 2000) + '/' +
                                                   (date.getMonth() + 1).zeroPad() + '/' + 
                                                   date.getDate().zeroPad() + ' ' + 
                                                   date.getHours().zeroPad() + ':' + 
                                                   date.getMinutes().zeroPad());
                    cell.appendChild(text);

                    cell = row.insertCell(2); 
                    text = document.createTextNode('' + (d['total_flight_time_s']/60).toFixed(0));
                    cell.appendChild(text);

                    cell = row.insertCell(3);
                    text = document.createTextNode('' + d['max_depth'].toFixed(0) + '(' + d['log_D_TGT'] + ')');
                    cell.appendChild(text);

                    dist = Math.sqrt(d['GPS_north_displacement_m']*d['GPS_north_displacement_m'] 
                                     + d['GPS_east_displacement_m']*d['GPS_east_displacement_m']);
                    course = Math.atan2(d['GPS_east_displacement_m'], d['GPS_north_displacement_m'])*180.0/Math.PI;
                    if (course < 0) {
                        course = course + 360;
                    }
                    cell = row.insertCell(4);
                    text = document.createTextNode('' + (dist/1000).toFixed(2));
                    cell.appendChild(text);

                    cell = row.insertCell(5);
                    text = document.createTextNode('' + course.toFixed(1));
                    cell.appendChild(text);

                    n = d['flight_avg_speed_north'] * d['total_flight_time_s'];
                    e = d['flight_avg_speed_east'] * d['total_flight_time_s'];
                    dist = Math.sqrt(n*n + e*e);
                    course = Math.atan2(e, n)*180.0/Math.PI;
                    if (course < 0) {
                        course = course + 360;
                    }
                    cell = row.insertCell(6);
                    text = document.createTextNode('' + (dist/1000).toFixed(2));
                    cell.appendChild(text);

                    cell = row.insertCell(7);
                    text = document.createTextNode('' + course.toFixed(1));
                    cell.appendChild(text);

                    cell = row.insertCell(8);
                    text = document.createTextNode('' + (d['meters_to_target']/1000).toFixed(2));
                    cell.appendChild(text);

                    cell = row.insertCell(9);
                    text = document.createTextNode('' + (d['mag_heading_to_target'] + d['magnetic_variation']).toFixed(1));
                    cell.appendChild(text);

                    
                    dist = Math.sqrt(d['depth_avg_curr_east']*d['depth_avg_curr_east'] 
                                     + d['depth_avg_curr_north']*d['depth_avg_curr_north']);
                    course = Math.atan2(d['depth_avg_curr_east'], d['depth_avg_curr_north'])*180.0/Math.PI;
                    if (course < 0) {
                        course = course + 360;
                    }

                    cell = row.insertCell(10);
                    text = document.createTextNode('' + (dist*100.0).toFixed(1));
                    cell.appendChild(text);

                    cell = row.insertCell(11);
                    text = document.createTextNode('' + course.toFixed(1));
                    cell.appendChild(text);

                    cell = row.insertCell(12);
                    text = document.createTextNode('' + d['log_TEMP'].toFixed(2));
                    cell.appendChild(text);
                    cell = row.insertCell(13);
                    text = document.createTextNode('' + d['log_HUMID'].toFixed(2));
                    cell.appendChild(text);
                    cell = row.insertCell(14);
                    text = document.createTextNode('' + d['log_INTERNAL_PRESSURE'].toFixed(2));
                    cell.appendChild(text);

                    cell = row.insertCell(15);
                    text = document.createTextNode('' + d['volts_10V'].toFixed(2));
                    cell.appendChild(text);
                    cell = row.insertCell(16);
                    text = document.createTextNode('' + (d['capacity_10V']*100).toFixed(2));
                    cell.appendChild(text);
                    cell = row.insertCell(17);
                    text = document.createTextNode('' + d['volts_24V'].toFixed(2));
                    cell.appendChild(text);
                    cell = row.insertCell(18);
                    text = document.createTextNode('' + (d['capacity_24V']*100).toFixed(2));
                    cell.appendChild(text);

                }
            }
        }
        xhttp.open("GET", "/db/" + currGlider, true);
        xhttp.send();
            
    }

    function showTable() {
        $('mainImage').setAttribute('hidden', '');
        $('logDiv').setAttribute('hidden', '');
        $('mainTable').removeAttribute('hidden');
    }

    function showLog() {
        $('mainImage').setAttribute('hidden', '');
        $('mainTable').setAttribute('hidden', '');
        $('logDiv').removeAttribute('hidden');
        currElt = 'logfile';
    }

    function loadControlFile(file, dive) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                if (this.responseText == "none" || this.responseText == "oops")  {
                    console.log(file + ' ' + this.responseText);
                    return;
                } 

                resp = JSON.parse(this.responseText);
                if ('file' in resp && resp['file'] == file) {
                    $(file).value = resp['contents'];
                }
                if ('dive' in resp && resp['dive'] > -1) {
                    controlFileDive[file] = resp['dive'];
                }
            }
        }
        xhttp.open("GET", "/control/" + currGlider + "/" + file, true);
        xhttp.send();
    }

    function loadStatus(glider) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                resp = JSON.parse(this.responseText);
                document.title = resp['glider'];
                currTitle = resp['glider'];
                if (parseInt(resp['dive']) != currDive) {
                    currDive = maxDive = parseInt(resp['dive']);
                    loadPlots(currDive);
                    loadLog(currDive);
                }
                engplots = resp['engplots'];
                buildTable();
            }
        }
        xhttp.open("GET", "/status/" + glider, true);
        xhttp.send();
        setupStream(glider);
    }

    function clearPlots() {
        while($('bottom').firstChild) {
            $('bottom').removeChild($('bottom').firstChild);
        }
    }

    function clearTable() {
        while($('mainTable').rows.length > 1) {
            $('mainTable').deleteRow(1);
        }
    }

    function addPlot(p, x, plotly) {
        img = document.createElement('img');
        img.src = '/png/' + currGlider + '/' + currDive + '/' + p;
        img.style = "position: absolute; left: " + x + "; top: 0; width:180px; heigh:169px;"
        img.onclick = function() { showPlot(p, plotly); };
        img.title = p;
        $('bottom').appendChild(img);
    }

    function addEng(p, x, plotly) {
        img = document.createElement('img');
        img.src = '/eng/' + currGlider + '/' + p;
        img.style = "position: absolute; left: " + x + "; top: 0; width:180px; heigh:169px;"
        img.onclick = function() { showEng(p, plotly); };
        img.title = p;
        $('bottom').appendChild(img);
    }

    function loadLog(dive) {
        var xhttp = new XMLHttpRequest();

        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                $('logDiv').innerHTML = 'Dive ' + dive + '<br>';
                $('logDiv').innerHTML += this.responseText;
            }
        }
        xhttp.open("GET", "/log/" + currGlider + '/' + dive, true);
        xhttp.send();
    }

    function loadPlots(dive) {
        var xhttp = new XMLHttpRequest();
        var plots;
        var img;
        var x = 0;
        var idx;
        var priority = ["diveplot", "ctd", "ts", "vert_vel", "pitch"];

        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                resp = JSON.parse(this.responseText);
                clearPlots();
                var plots = resp['dvplots'];
                var plotly = resp['plotlyplots'];
                // var engplots = resp['engplots'];

                for (p of priority) {
                    if (plots.includes(p)) {
                        addPlot(p, x, plotly.includes(p));
                        x += 200;
                        idx = plots.indexOf(p);
                        plots.splice(idx, 1); 
                    }
                }
                for (p of plots) {
                    addPlot(p, x, plotly.includes(p));
                    x += 200;
                }
                for (p of engplots) {
                    addEng(p, x, false);
                    x += 200;
                }

                if (currElt == 'logfile')
                    showLog();
                else if (engplots.includes(currElt))
                    showEng(currElt, plotly.includes(currElt));
                else 
                    showPlot(currElt, plotly.includes(currElt));

                // $('mainImage').src = '/png/' + currGlider + '/' + dive + '/diveplot';
                // $('mainImage').removeAttribute('hidden'); 
                // $('mainTable').setAttribute('hidden', ''); 
            }
            currDive = dive;
        }
        xhttp.open("GET", "/plots/" + currGlider + '/' + dive, true);
        xhttp.send();
    }
   
    function changeDive(dir) {
        var c = currDive;

        currDive += dir;
        if (currDive > maxDive)
            currDive = maxDive;
        else if (currDive < 1)
            currDive = 1;

        if (currDive != c) {
            loadPlots(currDive);
            loadLog(currDive);
            currDive = c;
        }
    }
       
    function parameterHelp() {
        var s = $('cmdfile').selectionStart;
        var e = $('cmdfile').selectionEnd;
        var v = $('cmdfile').value;
        if (v[s-1] == '$' && v[e] == ',') {
            var str = v.substring(s, e);
            window.open('/parms#' + str, 'parms');
        }
    }

    const knownFiles = ["cmdfile", "targets", "science", "scicon.sch", "pdoscmds.bat", "tcm2mat.cal", "sg_calib_constants.m"];
    const cmdfileButtons = ['btnGO', 'btnQUIT', 'btnRESUME'];
    function changeFile() {
        var file = $('selectFile').value;
        for (var f of knownFiles) {
            if (f == file)
                $(f).removeAttribute('hidden');
            else
                $(f).setAttribute('hidden', '');
        }

        for (var b of cmdfileButtons) {
            if (file != "cmdfile") 
                $(b).setAttribute('hidden', '');
            else 
                $(b).removeAttribute('hidden');
        }

        if (file in controlFileDive) {
            $('fileDive').innerHTML = '(' + controlFileDive[file] + ')';
            $('fileDive').removeAttribute('hidden');
        }
        else {
            $('fileDive').setAttribute('hidden', '');
            $('fileDive').innerHTML = '';
        }
    }
 
    function init() {
        glider = window.location.pathname.substring(1);
        currGlider = glider;
        console.log(glider);
        loadStatus(glider);
        loadControlFile('cmdfile');
        loadControlFile('science');
        loadControlFile('targets');
        loadControlFile('scicon.sch');
        loadControlFile('tcm2mat.cal');
        loadControlFile('pdoscmds.bat');
        loadControlFile('sg_calib_constants.m');
    }

</script>

<html>
<body onload="init();" style="font-family: verdana, arial, tahoma, 'sans serif'; font-size: 12px;">
<div style="position: relative;">

<div id="main" style="position: absolute; left: 0; top: 0; width:1058px; height:894px; overflow:auto;">
    <img id="mainImage">
    <table rules="groups" id="mainTable" hidden="hidden" style="height:894px; width:1040px; font-size:14px; text-align:right; font-family:verdana, arial, tahoma, 'sans serif';"> 

        <colgroup span=4><col><col><col><col></colgroup>
        <colgroup span=6><col><col><col><col><col><col></colgroup>
        <colgroup span=2><col><col></colgroup>
        <colgroup span=3><col><col><col></colgroup>
        <colgroup span=4><col><col><col><col></colgroup>
        <tbody style="height:894px; width:1040px; overflow-y:auto;"> <!-- display:block"> -->
            <tr bgcolor="#aaaaaa" align="center">
                <th>dive</th>
                <th>end</th>
                <th>length</th>
                <th>depth</th>
                <th>dog</th>
                <th>cog</th>
                <th>dtw</th>
                <th>ctw</th>
                <th>dtg</th>
                <th>ctg</th>
                <th>Umag</th>
                <th>Udir</th>
                <th>temp</th>
                <th>RH</th>
                <th>int P</th>
                <th>volts10</th>
                <th>% cap</th>
                <th>volts24</th>
                <th>% cap</th>
            </tr>
        </tbody>
    </table>
    <div id="logDiv" hidden="hidden"></div>
</div>

<div id="links" style="position: absolute; left:1060; top: 0; width:600; height:20; font-size:10px;">
    <a href="#" onclick="popupSelftest();">selftest</a> *
    <a href="#" onclick="popupMap();">map</a>
</div>

<div id="commlog" style="position: absolute; left:1060; top:20; width:640; height:400; overflow:auto; font-size: 10px; box-sizing:border-box; border:1px solid black; white-space:pre;">

</div>

<div id="status" style="position: absolute; left:1060; top:430; width:640; height:230; overflow:auto; font-size: 10px; box-sizing:border-box; border:1px solid black;">
    <div id="position" style="font-weight: bold; font-size: 4vmin; padding-left: 2vmin; padding-top: 1px; padding-bottom: 1px">
    </div>
    <div id="positionTime" style="font-weight: bold; font-size: 1.5vmin; padding-left: 2vmin; padding-top: 1px; padding-bottom: 2px">
    </div>
    <table style="table-layout:fixed; width: 600px;">
        <col style="width:60px;">
        <col style="width:140px;">
        <col style="width:60px;">
        <col style="width:140px;">
        <col style="width:60px;">
        <col style="width:140px;">
        <tr>
            <td>SOG</td><td id="SOG"></td>
            <td>COG</td><td id="COG"></td>
            <td>last fix</td><td id="lastFix"></td>
        </tr>
        <tr>
            <td>DOG</td><td id="DOG"></td>
            <td>&Delta;t</td><td id="dt"></td>
            <td>last call</td><td id="lastConnect"></td>
        </tr>
        <tr>
            <td>pitch</td><td id="pitch"></td>
            <td>volts</td><td id="volts"></td>
        </tr>
        <tr>
            <td>depth</td><td id="depth"></td>
            <td>dive</td><td id="dive"></td>
        </tr>
        <tr>
            <td>RH</td><td id="RH"></td>
            <td>cycle</td><td id="cycle"></td>
        </tr>
        <tr>
            <td>int P</td><td id="intP"></td>
            <td>call</td><td id="call"></td>
        </tr>
    </table>
</div>

<div id="divCmdfile" style="position: absolute; left:1060; top:670; width:640px; height:380px; font-size: 12px;">
    <textarea id="cmdfile" style="width:100%; height:100%; box-sizing:border-box;" ondblclick="parameterHelp();">
    </textarea>
    <textarea id="targets" style="width:100%; height:100%; box-sizing:border-box;" hidden="hidden"></textarea>
    <textarea id="science" style="width:100%; height:100%; box-sizing:border-box;" hidden="hidden"></textarea>
    <textarea id="scicon.sch" style="width:100%; height:100%; box-sizing:border-box;" hidden="hidden"></textarea>
    <textarea id="pdoscmds.bat" style="width:100%; height:100%; box-sizing:border-box;" hidden="hidden"></textarea>
    <textarea id="tcm2mat.cal" style="width:100%; height:100%; box-sizing:border-box;" hidden="hidden"></textarea>
    <textarea id="sg_calib_constants.m" style="width:100%; height:100%; box-sizing:border-box;" hidden="hidden"></textarea>
    <button id="btnSave" type="button" onclick="saveControl(0);">Save</button>
    <button id="btnForce" type="button" onclick="saveControl(1);">Force</button>
    <button id="btnGO" type="button" onclick="changeDirective('GO');" style="background-color:#00aa00;">GO</button>
    <button id="btnQUIT" type="button" onclick="changeDirective('QUIT');" style="background-color:#ff0020;">QUIT</button>
    <button id="btnRESUME" type="button" onclick="changeDirective('RESUME');" style="background-color:yellow;">RESUME</button>
    <select id="selectFile" onchange="changeFile()">
        <option value="cmdfile" selected>cmdfile</option>
        <option value="targets">targets</option>
        <option value="science">science</option>
        <option value="scicon.sch">scicon.sch</option>
        <option value="pdoscmds.bat">pdoscmds.bat</option>
        <option value="tcm2mat.cal">tcm2mat.cal</option>
        <option value="sg_calib_constants.m">sg_calib_constants.m</option>
    </select>
    <span id="fileDive" hidden="hidden"></span>
</div>

<div id="bottomButtons" style="position: absolute; left: 0; top: 900; width: 80; height: 180; overflow: auto;">
    <span style="float: right;"><a href="#" onclick="showLog();">log</a></span><br>
    <button id="btnUp" type="button" onclick="changeDive(1);" style="font-size: 18px; width:80px;">&#x2191</button><br><br>
    <button id="btnTable" type="button" onclick="showTable();" style="font-size: 48px; width:80px;">&#x2637</button><br><br>
    <button id="btnDown" type="button" onclick="changeDive(-1);" style="font-size: 18px; width:80px;">&#x2193</button>
</div>

<div id="bottom" style="position: absolute; left: 80; top: 900; width: 978; height: 180; overflow: auto;">

</div>

</div>
</body>


</html>
