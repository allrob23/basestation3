<style>
    body {
        background-color: #999999;
        color: #000000;
    }

    .tile {
        background: #bbbbbb;
        width: 300px;
        height: 420px;
        border: 2px solid black;
        margin-left: 10px;
        margin-top: 10px;
        float: left;
        padding: 4px;
    }

    .header {
        font-size: 20px;
        font-weight: bold;
    }
    .position {
        font-size: 16px;
        font-weight: bold;
    }

    .label {
        float: left;
        width: 30px;
    }

    .box {
        display: flex;
        align-items: center; 
        margin-top: 5px;
    }

    .indicator {
        border: 2px solid black;
        margin-right: 5px;
        text-align: center;
        width: 50px;
        border-radius: 8px;
    }

    [class~="indicatorGreen"] {
        background-color: #00ff00;
    }
    [class~="indicatorRed"] {
        background-color: #ff0000;
    }
    [class~="indicatorYellow"] {
        background-color: #ffff00;
    }

    .chart {
        background: rgba(255, 255, 255, 0.4);
        justify-content: flex-start;
        border-radius: 50px;
        align-items: center;
        position: relative;
        padding: 0 5px;
        display: flex;
        height: 20px;
        width: 260px;
    }

    .chart span {
        margin-left: 2px;
        color: #555;
        font-weight: bolder;
    }

    .bar {
        border-radius: 0px;
        background: #00ff00;
        height: 16px;
        width: 100%;
        margin-left: 0px;
    }

    .barPercent {
        border-radius: 10px;
        background: #00ff00;
        height: 16px;
        width: 100%;
        margin-left: -2px;
    }


</style>
<script src="/script/util.js"></script>
<script>


    function setPlusMinusBar(chart, bar, span, pct, text, hover) {
        if (pct < -1)
            pct = -1;
        else if (pct > 1)
            pct = 1;

        var wide = $(chart).offsetWidth;
        var half = wide/2;
        var pix = half*Math.abs(pct);
        var off = pct < 0 ? half - pix : half;
     
        $(chart).title = hover;
        if (pct < 0) {
            $(bar).style.borderTopLeftRadius = '10px'; 
            $(bar).style.borderBottomLeftRadius = '10px';
            $(bar).style.borderTopRightRadius = '0px';
            $(bar).style.borderBottomRightRadius = '0px';
        }
        else {
            $(bar).style.borderTopLeftRadius = '0px'; 
            $(bar).style.borderBottomLeftRadius = '0px';
            $(bar).style.borderTopRightRadius = '10px';
            $(bar).style.borderBottomRightRadius = '10px';
        }
        $(bar).style.marginLeft = off + 'px';
        $(bar).style.width = pix + 'px';

        if (pct < 0 && pct > -0.1)
            $(bar).style.backgroundColor = 'yellow';
        else if (pct < -0.1)
            $(bar).style.backgroundColor = 'red';
        else 
            $(bar).style.backgroundColor = 'green';

        $(span).innerHTML = text;
    }

    function setPercentBar(chart, bar, span, pct, text, hover) {

        if (pct < -1)
            pct = -1;
        else if (pct > 1)
            pct = 1;
       
        $(chart).title = hover; 

        $(bar).style.width = (100*pct) + '%';

        if (pct < 0.1)
            $(bar).style.backgroundColor = 'red';
        else if (pct < 0.25)
            $(bar).style.backgroundColor = 'yellow';
        else 
            $(bar).style.backgroundColor = 'green';

        if (text != '')
            $(span).innerHTML = text;
        else 
            $(span).innerHTML = (pct*100).toFixed(0) + '%';

    }
    
    var gliders = [];
    var nextGauges = [];
    var nextTimer = null;
    var plotWhich = 'diveplot';
 
    function mission(glider) {
        if (glider.mission != '')
            return `?mission=${glider.mission}`;
        else
            return '';
    }

    function updateNext() {
        var next, nextHour, nextMin;
        for (var i = 0 ; i < nextGauges.length ; i++) {
            next = (nextGauges[i].next - Date.now()/1000);
            nextHour = parseInt('' + (next/3600));
            nextMin  = parseInt('' + Math.abs(((next - nextHour*3600)/60)));

            let due_t = new Date(Date.now() + next*1000).toISOString().replace('T', ' ').slice(0,-8);
            setPlusMinusBar(nextGauges[i].chart, 
                            nextGauges[i].bar,
                            nextGauges[i].span,
                            next/28800.0,
                            `${nextHour.zeroPad()}:${nextMin.zeroPad()}`, 
                            `next call due ${due_t}`);
        }
    }

    const directiveColors = { "GO": "green", "QUIT": "red", "RESUME": "yellow" };
    function formatDirective(d, id) {
        var color;
        color = d in directiveColors ? directiveColors[d] : 'black'; 
        return `<span style="color:${color};" id="${id}">${d}</span>`;
    }

    function thresh(val, lim1, lim2) {
        if (lim1 < lim2) {
            if (val < lim1)
                return 'indicatorRed';
            else if (val < lim2)
                return 'indicatorYellow';
            else
                return 'indicatorGreen';
        }
        else {
            if (val > lim1)
                return 'indicatorRed';
            else if (val > lim2)
                return 'indicatorYellow';
            else
                return 'indicatorGreen';
        }
    }

    function createTile(glider, t) {
        console.log(glider);
        console.log(mission(glider));

        fetch(`/summary/${glider.glider}${mission(glider)}`)
        .then(res => res.json())
        .then(data => {
            t.classList.add('tile');
            t.onclick = function() { window.open(`/${data.name}${mission(glider)}`, `${data.name}`); };
           
            var h, txt, box, barBatt, chartBatt, spanBatt, header;
            var barNext, chartNext, spanNex;
            if (glider.mission == '')
                h = h = 'SG' + data.name + '<br><hr>';
            else
                h = 'SG' + data.name + ': ' + glider.mission.replace('_', ' ') + '<br><hr>';

            header = document.createElement('div');
            header.classList.add('header');
            header.innerHTML = h;

            t.appendChild(header);

            txt = document.createElement('div');
            let end_t = new Date(data.end*1000).toISOString().replace('T', ' ').slice(0,-5);
            txt.innerHTML = `dive ${data.dive} ended ${end_t} to ${data.depth.toFixed(0)}m`;
            t.appendChild(txt);

            txt = document.createElement('div');
            txt.id = `${glider}_directive`

            txt.innerHTML = `parsed ${formatDirective(data.commDirective, "commdirective" + glider.glider)}, waiting ${formatDirective(data.cmdfileDirective, "cmdfileDirective" + glider.glider)}`;
            t.appendChild(txt);

            box = document.createElement('div');
            box.classList.add('box');

            txt = document.createElement('div');
            txt.classList.add('position');
            txt.innerHTML = formatPos(dd2ddmm(data.lat)) + ',' + formatPos(dd2ddmm(data.lon));
            h = document.createElement('div');
            h.appendChild(document.createTextNode('pos: '));
            h.classList.add('label');
            box.appendChild(h);
            box.appendChild(txt);
            t.appendChild(box);

            box = document.createElement('div');
            box.classList.add('box');

            chartBatt = document.createElement('div');
            chartBatt.classList.add('chart');
            chartBatt.id = 'chartBatt' + data.name;
            h = document.createElement('div');
            h.appendChild(document.createTextNode('batt: '));
            h.classList.add('label');
            box.appendChild(h);
            box.appendChild(chartBatt);
            t.appendChild(box);

            barBatt = document.createElement('div');
            barBatt.classList.add('barPercent');
            barBatt.id = 'barBatt' + data.name;
            chartBatt.appendChild(barBatt);

            spanBatt = document.createElement('span');
            spanBatt.id = 'spanBatt' + data.name;
            chartBatt.appendChild(spanBatt);

            let endurance_t = new Date(data.enduranceEndT*1000).toISOString().replace('T', ' ').slice(0,-14);
            setPercentBar(chartBatt.id, barBatt.id, spanBatt.id, data.capacity[1], '', `projected end ${endurance_t}`);

            box = document.createElement('div');
            box.classList.add('box');

            chartNext = document.createElement('div');
            chartNext.classList.add('chart');
            chartNext.id = 'chartNext' + data.name;
            h = document.createElement('div');
            h.appendChild(document.createTextNode('next: '));
            h.classList.add('label');
            box.appendChild(h);
            box.appendChild(chartNext);
            t.appendChild(box);

            barNext = document.createElement('div');
            barNext.classList.add('barPercent');
            barNext.id = 'barNext' + data.name;
            chartNext .appendChild(barNext);

            spanNext = document.createElement('span');
            spanNext.id = 'spanNext' + data.name;
            chartNext.appendChild(spanNext);

            nextGauges.push({chart:chartNext.id, bar:barNext.id, span:spanNext.id, next:data.next});

            next = (data.next - Date.now()/1000);
            nextHour = parseInt('' + (next/3600));
            nextMin  = parseInt('' + Math.abs(((next - nextHour*3600)/60)));
            
            let due_t = new Date(Date.now() + next*1000).toISOString().replace('T', ' ').slice(0,-8);
            setPlusMinusBar(chartNext.id, barNext.id, spanNext.id, next/28800.0, `${nextHour.zeroPad()}:${nextMin.zeroPad()}`, `next call due ${due_t}`);

            // annunciators
            box = document.createElement('div');
            box.classList.add('box');

            // errors
            h = document.createElement('div');
            h.classList.add('indicator');
            h.innerHTML = `errors<br>${data.errors + data.crits}`;
            h.classList.add(thresh(data.errors + data.crits, 0, 0));
            console.log('error ' + h.classList);
            h.setAttribute('hidden', ''); 
            box.appendChild(h);

            // alerts
            h = document.createElement('div');
            h.classList.add('indicator');
            h.innerHTML = `alerts<br>${data.alert ? 'yes' : 'none'}`;
            h.classList.add(thresh(data.alert ? 1 : 0, 0, 0));
            h.setAttribute('hidden', ''); 
            box.appendChild(h);
 
            // OG efficiency
            h = document.createElement('div');
            h.title = "over-ground efficiency (flight quality)"
            h.classList.add('indicator');
            h.innerHTML = `OG eff.<br>${(100*data.dogEfficiency).toFixed(0)}%`;
            h.classList.add(thresh(data.dogEfficiency, 0.25, 0.5));
            h.setAttribute('hidden', ''); 
            box.appendChild(h);

            // VBD efficiency
            h = document.createElement('div');
            h.classList.add('indicator');
            h.innerHTML = `VBD eff.<br>${(100*data.vbdEfficiency).toFixed(0)}%`;
            h.classList.add(thresh(data.vbdEfficiency, 0.25, 0.4));
            h.setAttribute('hidden', ''); 
            box.appendChild(h);

            // mission endurance
            let days = (data.missionEnd - data.enduranceEndT)/86400;
            h = document.createElement('div');
            h.title = 'mission endurance';
            h.classList.add('indicator');
            h.innerHTML = `endur.<br>-${days.toFixed(0)} days`;
            h.classList.add(thresh(days, 30, 0));
            h.setAttribute('hidden', ''); 
            box.appendChild(h);

            // internal pressure
            h = document.createElement('div');
            h.title = "internal pressure";
            h.classList.add('indicator');
            h.innerHTML = `intern P<br>${data.internalPressure.toFixed(2)} psi`;
            h.classList.add(thresh(data.internalPressureSlope, 0.01, 0.005));
            h.setAttribute('hidden', ''); 
            box.appendChild(h);

            // humidity
            h = document.createElement('div');
            h.classList.add('indicator');
            h.innerHTML = `humid<br>${data.humidity.toFixed(1)}`;
            h.classList.add(thresh(data.humiditySlope, 0.2, 0.05));
            h.setAttribute('hidden', ''); 
            box.appendChild(h);

            // volmax
            h = document.createElement('div');
            h.classList.add('indicator');
            h.innerHTML = `volmax<br>${data.impliedVolmaxSlope.toFixed(1)} cc/dv`;
            h.classList.add(thresh(Math.abs(data.impliedVolmaxSlope), 4, 2));
            h.setAttribute('hidden', ''); 
            box.appendChild(h);

            t.appendChild(box);

            var count = 0;
             
            const classes = ["indicatorRed", "indicatorYellow", "indicatorGreen"];
            coll = box.children;
            for (const c of classes) {
                for (var i = 0 ; i < coll.length && count < 5 ; i++) {
                    if (coll[i].classList.contains(c)) {
                        coll[i].removeAttribute('hidden');
                        count ++;
                    }
                }
            }    
            
            img = document.createElement('img');
            img.src = '/png/dv/' + data.name + '/' + data.dive + '/' + plotWhich + mission(glider);
            img.style = "top: 0; width:290px; max-height:240px; mix-blend-mode:multiply;"
     
            t.appendChild(img);
        })
        .catch(error => {
            console.log(error);
        });
    }


    function loadTable() {
        window.name = 'index';
        document.title = 'index';
        let params = new URLSearchParams(window.location.search);
        if (params.has('plot'))
            plotWhich = params.get('plot');

        clearTiles('main');
        nextGauges = [];

        fetch(`/optable/1`)
        .then(res => res.json())
        .then(data => {
            var glider, t;
            console.log(data);
            for (g of data) {
                glider = { glider: g.glider, mission: g.mission };

                // create div and append as blank to main
                // so that we can control the order independently
                // of when then individual /summary fetches arrive

                // this tile probably never exists here in loadTable
                if ($(`${g.glider}`)) {
                    console.log('tile exists, clearing');
                    clearTiles(`${g.glider}`);
                    t = $(`${g.glider}`);
                }
                else {
                    t = document.createElement('div');
                    t.id = `${g.glider}`
                    $('main').appendChild(t);
                }
                console.log(glider);
                createTile(glider, t);
            }

            if (nextTimer) {
                clearInterval(nextTimer);
            }
        
            nextTimer = window.setInterval(updateNext, 60000);
        })
        .catch(error => {
            console.log(error);
        });

    }

    function clearTiles(parent) {
        while($(parent).firstChild) {
            $(parent).removeChild($(parent).firstChild);
        }
    }

    let wsocket  = null;
    var lastSetup = 0;
    var first = true;

    function setupStream() {
        if (Date.now() < lastSetup + 5000) {
            setTimeout('setupStream()', 5000);
            console.log('too soon');
            return;
        }
        lastSetup = Date.now();

        if (wsocket != null) {
            wsocket.close();
            console.log('closing previous stream');
        }
        console.log('setting up stream');
        var loc = window.location, new_uri;
        if (loc.protocol === "https:")
            new_uri = "wss:";
        else
            new_uri = "ws:";

        new_uri += "//" + loc.host;
        new_uri += "/watch";
        wsocket = new WebSocket(new_uri);

        wsocket.onerror = function(error) {
            console.log('stream error detected');
            wsocket.close();
            setupStream();
        };

        wsocket.onclose = function(e) {
            if (e.wasClean) {
                console.log('stream closed cleanly');
            }
            else {
                console.log('connection died');
                setupStream();
            }
        };

        wsocket.onmessage = function(e) {
            var line = e.data;
            console.log(line);
            if (line.startsWith('NEW=')) {
                pieces = line.split('=')[1].split(',')
                glider = pieces[0]
                which = pieces[1]
                console.log(glider + ' ' + which);
                if (which == 'cmdfile' && pieces.length == 3) {
                    d = pieces[2]
                    $('cmdfileDirective' + glider).innerHTML = d;
                    $('cmdfileDirective' + glider).style.color = d in directiveColors ? directiveColors[d] : 'black';
                    // cmdfile has changed, brute force reload the whole
                    // tile so that the waiting directive changes
                    // clearTiles('' + glider);
                    // createTile({ "glider": glider, "mission": ''}, $('' + glider))
                }
                else if (which.startsWith('files')) {
                    // the only files we get is perdive which we use 
                    // to trigger a reload of this tile
                    clearTiles('' + glider);
                    createTile({ "glider": glider, "mission": ''}, $('' + glider))
                }
                else if (which.startsWith('status')) {
                    // the only status message is disconnected
                    $(glider).style.border = '2px solid black';
                }
                else if (which.startsWith('gpsstr')) {
                    // we only get gpsstr on new connection
                    $(glider).style.border = '2px solid magenta';
                }
            }
        }
    }
    function init() {
        loadTable();
        setupStream();
    }

</script>

<html>
<body onload="init();" style="font-family: verdana, arial, tahoma, 'sans serif'; font-size: 12px;">

<div id="main" style="position: relative;">


</div> 

</body>
</html>
